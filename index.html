<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Palestra 3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load runtime config which is generated during build (injects GEMINI key safely) -->
    <script src="./config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2d3748;
        }

        .app {
            max-width: 100%;
            margin: 0 auto;
            background: #f8fafc;
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .header-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* NAVIGATION */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .nav-tab.active {
            color: #4a5568;
            border-bottom: 3px solid #4a5568;
            background: #f7fafc;
        }

        .nav-tab-ai {
            flex: 1;
        }

        /* PAGES */
        .page {
            display: none;
            padding: 20px;
            min-height: 70vh;
        }

        .page.active {
            display: block;
        }

        /* AI ASSISTANT PAGE STYLES */
        .ai-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .ai-header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .ai-header h2 {
            color: #2d3748;
            font-size: 1.4em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .ai-header p {
            color: #718096;
            font-size: 1em;
            line-height: 1.5;
        }

        .ai-chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .ai-message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        .ai-message.user {
            text-align: right;
        }

        .ai-message.assistant {
            text-align: left;
        }

        .ai-message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.6;
            white-space: pre-line;
        }

        .ai-message.user .ai-message-bubble {
            background: #4a5568;
            color: white;
        }

        .ai-message.assistant .ai-message-bubble {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }

        .ai-input-container {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .ai-input-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .ai-input {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 0.95em;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: border-color 0.3s ease;
        }

        .ai-input:focus {
            outline: none;
            border-color: #4a5568;
        }

        .ai-send-btn {
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .ai-send-btn:hover {
            background: #2d3748;
            transform: scale(1.05);
        }

        .ai-send-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .ai-quick-actions {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ai-quick-actions h3 {
            color: #2d3748;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
        }

        .ai-quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .ai-quick-btn {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.3s ease;
            text-align: left;
        }

        .ai-quick-btn:hover {
            border-color: #4a5568;
            background: #4a5568;
            color: white;
        }

        .ai-typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #718096;
            font-style: italic;
            margin-bottom: 15px;
        }

        .ai-typing-dots {
            display: flex;
            gap: 4px;
        }

        .ai-typing-dot {
            width: 6px;
            height: 6px;
            background: #cbd5e0;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .ai-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .ai-template-preview {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .ai-template-preview h4 {
            color: #2d3748;
            font-size: 1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-template-exercises {
            list-style: none;
            margin-bottom: 15px;
        }

        .ai-template-exercises li {
            color: #4a5568;
            font-size: 0.9em;
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }

        .ai-template-exercises li::before {
            content: "‚Ä¢";
            color: #48bb78;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .ai-use-template-btn {
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .ai-use-template-btn:hover {
            background: #38a169;
            transform: scale(0.95);
        }

        /* PROGRESS PAGE - NEW STYLES */
        .progress-filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
        }

        /* MUSCLE GROUPS FILTER */
        .muscle-groups-filter {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .muscle-group-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .muscle-group-btn {
            padding: 6px 14px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            color: #4a5568;
        }

        .muscle-group-btn:hover {
            border-color: #4a5568;
            background: #f7fafc;
        }

        .muscle-group-btn.active {
            background: #4a5568;
            color: white;
            border-color: #4a5568;
        }

        /* ADDITIONAL FILTERS */
        .additional-filters-section {
            margin-bottom: 20px;
        }

        .toggle-filters-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            color: #4a5568;
            transition: all 0.3s ease;
            text-align: left;
            display: inline-block;
        }

        .toggle-filters-btn:hover {
            background: #f7fafc;
            border-color: #4a5568;
        }

        .additional-filters-content {
            margin-top: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .custom-date-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .custom-date-group .filter-label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        .filter-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #4a5568;
        }

        .filter-select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #4a5568;
        }

        /* CHARTS */
        .progress-charts {
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .chart-title {
            color: #2d3748;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chart-info-badge {
            background: #e6f7ff;
            color: #0066cc;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* WORKOUT PAGE */
        .workout-title {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .workout-title h2 {
            color: #2d3748;
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .workout-date {
            color: #718096;
            font-size: 0.9em;
        }

        .Schede {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 5px;
        }

        .template-btn {
            flex: 0 0 auto;
            background: white;
            border: 2px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .template-btn:hover {
            border-color: #4a5568;
            background: #4a5568;
            color: white;
        }

        .template-edit-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e2e8f0;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .template-edit-btn:hover {
            background: #cbd5e0;
        }

        .template-delete-btn {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #fed7d7;
            color: #e53e3e;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .template-delete-btn:hover {
            background: #feb2b2;
        }

        .exercise-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .exercise-header {
            padding: 12px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-name {
            font-weight: 600;
            color: #2d3748;
        }

        .exercise-controls {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .control-btn {
            background: #e2e8f0;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #cbd5e0;
        }

        .control-btn.delete {
            background: #fed7d7;
            color: #e53e3e;
        }

        .control-btn.delete:hover {
            background: #feb2b2;
        }

        .control-btn.notes-toggle {
            background: #edf2f7;
            color: #4a5568;
        }

        .control-btn.notes-toggle.open {
            background: #4a5568;
            color: #fff;
        }

        .control-btn.notes-toggle.has-text {
            background: #c6f6d5;
            color: #22543d;
        }

        .control-btn.notes-toggle.open.has-text {
            background: #2f855a;
        }

        .exercise-inputs {
            padding: 12px;
            display: grid;
            grid-template-columns: 0.8fr 0.8fr 1.4fr;
            gap: 8px;
            align-items: end;
        }

        .cardio-placeholder {
            /* Placeholder invisibile per mantenere l'allineamento */
            visibility: hidden;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 0.8em;
            font-weight: 500;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .input-field {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            font-size: 0.95em;
            text-align: center;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #4a5568;
        }

        .input-hint {
            font-size: 0.7em;
            color: #a0aec0;
            text-align: center;
            margin-top: 2px;
            display: none;
        }

        .notes-section {
            padding: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .notes-section.collapsed {
            display: none;
        }

        .notes-input {
            width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            font-size: 0.9em;
            resize: vertical;
            min-height: 56px;
        }

        .notes-input:focus {
            outline: none;
            border-color: #4a5568;
        }

        @media (max-width: 600px) {
            .exercise-card {
                margin-bottom: 8px;
                border-radius: 10px;
            }

            .exercise-header {
                padding: 10px 12px;
            }

            .exercise-name {
                font-size: 0.9em;
            }

            .exercise-controls {
                gap: 3px;
            }

            .control-btn {
                width: 24px;
                height: 24px;
                font-size: 0.68em;
            }

            .exercise-inputs {
                padding: 10px 12px;
                grid-template-columns: 60px 60px 1fr;
                gap: 6px;
            }

            .exercise-inputs .input-group {
                min-width: 0;
            }

            .input-label {
                display: none;
            }

            .input-field {
                padding: 6px;
                font-size: 0.9em;
            }

            .input-hint {
                display: block;
            }

            .notes-section {
                padding: 10px 12px;
            }

            .notes-input {
                min-height: 48px;
                font-size: 0.82em;
            }

            .template-edit-btn,
            .template-delete-btn {
                display: none;
            }
        }

        /* TEMPLATE EDITOR */
        .template-editor {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .template-editor h3 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .template-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .template-exercises {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            min-height: 200px;
            padding: 15px;
        }

        .template-exercise-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }

        .template-exercise-info {
            flex: 1;
        }

        .template-exercise-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .template-exercise-details {
            font-size: 0.8em;
            color: #718096;
        }

        .template-exercise-controls {
            display: flex;
            gap: 5px;
        }

        .template-exercise-btn {
            background: #e2e8f0;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template-exercise-btn:hover {
            background: #cbd5e0;
        }

        .template-exercise-btn.delete {
            background: #fed7d7;
            color: #e53e3e;
        }

        .add-template-exercise-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .add-template-exercise-btn:hover {
            background: #2d3748;
        }

        .add-template-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .add-template-btn:hover {
            background: #38a169;
        }

        /* AUTOCOMPLETE */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background-color 0.2s ease;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.selected {
            background: #f7fafc;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        /* PROGRESS CARDS */
        .progress-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .progress-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-weight: 600;
            color: #2d3748;
        }

        .progress-trend {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .trend-up {
            background: #c6f6d5;
            color: #22543d;
        }

        .trend-down {
            background: #fed7d7;
            color: #742a2a;
        }

        .trend-stable {
            background: #e2e8f0;
            color: #4a5568;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            color: #718096;
            font-size: 0.8em;
        }

        /* CALENDAR */
        .calendar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav-btn {
            background: #e2e8f0;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: #cbd5e0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: #718096;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: #f1f5f9;
        }

        .calendar-day.today {
            background: #4a5568;
            color: white;
            font-weight: 600;
        }

        .calendar-day.has-workout {
            background: #c6f6d5;
            color: #22543d;
            font-weight: 600;
        }

        .calendar-day.has-workout::after {
            content: 'üí™';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6em;
        }

        .calendar-day.other-month {
            color: #cbd5e0;
        }

        /* HISTORY PAGE */
        .history-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .history-item:hover {
            background: #f8fafc;
        }

        .history-content {
            flex: 1;
        }

        .history-content h3 {
            color: #2d3748;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .history-workout-name {
            color: #4a5568;
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .history-summary {
            color: #718096;
            font-size: 0.9em;
        }

        .history-duration {
            background: #e2e8f0;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            color: #4a5568;
            margin-right: 10px;
        }

        .history-delete-btn {
            background: #fed7d7;
            color: #e53e3e;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .history-delete-btn:hover {
            background: #feb2b2;
        }

        /* BUTTONS */
        .add-exercise-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .add-exercise-btn:hover {
            background: #2d3748;
        }

        .save-workout-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            width: 100%;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .save-workout-btn:hover {
            background: #38a169;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .modal-input:focus {
            outline: none;
            border-color: #4a5568;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: #4a5568;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #2d3748;
        }

        .modal-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .modal-btn.secondary:hover {
            background: #cbd5e0;
        }

        /* REORDER LIST */
        .reorder-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin-bottom: 8px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .reorder-item-name {
            flex: 1;
            font-weight: 500;
            color: #2d3748;
        }

        .reorder-arrow-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .reorder-arrow-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .reorder-arrow-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* MUSCLE SELECTION MODAL */
        .modal-description {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 20px;
            text-align: center;
        }

        .muscle-selection {
            margin-bottom: 20px;
        }

        .muscle-type-selection {
            margin-bottom: 20px;
        }

        .muscle-type-label {
            display: block;
            margin-bottom: 10px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .muscle-type-label:hover {
            background: #edf2f7;
        }

        .muscle-type-label input[type="radio"] {
            margin-right: 10px;
        }

        .muscles-grid-selection h4 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1em;
        }

        .muscles-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .muscle-checkbox {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .muscle-checkbox:hover {
            background: #edf2f7;
        }

        .muscle-checkbox input[type="checkbox"] {
            margin-right: 8px;
        }

        .muscle-checkbox span {
            font-size: 0.9em;
            color: #4a5568;
        }

        .exercise-inputs-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .exercise-inputs-section h4 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1em;
        }

        .exercise-inputs {
            display: flex;
            flex-direction: row;
            gap: 15px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            min-width: 120px;
        }

        .input-group label {
            min-width: 120px;
            font-size: 0.85em;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            max-width: 80px;
        }

        /* SCHEDE SELECTION MODAL */
        .schede-selection {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .scheda-selection-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }

        .scheda-selection-item:hover {
            background: #edf2f7;
        }

        .scheda-selection-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
            cursor: pointer;
        }

        .scheda-info {
            flex: 1;
        }

        .scheda-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .scheda-details {
            font-size: 0.85em;
            color: #718096;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .progress-filters {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .progress-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .chart-canvas {
                height: 250px;
            }
            
            .exercise-inputs {
                grid-template-columns: 0.8fr 0.8fr 1.4fr;
                gap: 8px;
            }

            .nav-tab {
                font-size: 0.8em;
                padding: 12px 8px;
            }

            .ai-quick-buttons {
                grid-template-columns: 1fr;
            }

            .ai-chat-container {
                height: 400px;
            }
        }

        /* ANIMATIONS */
        .exercise-card, .template-exercise-item, .progress-card, .history-item {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .empty-state-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* MUSCOLI ALLENATI SECTION */
        .muscles-worked-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .muscles-worked-section h4 {
            color: #2d3748;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
        }

        .muscle-coverage {
            margin-bottom: 20px;
        }

        .coverage-bar {
            background: #e2e8f0;
            border-radius: 20px;
            height: 24px;
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .coverage-fill {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
        }

        .coverage-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #2d3748;
            font-size: 0.8em;
            font-weight: 600;
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }

        .muscles-worked h4 {
            margin-bottom: 15px;
        }

        .muscles-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .muscle-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .no-muscles {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 20px;
        }

        /* WORKOUT COUNTER */
        .workout-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #4a5568;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* BACK TO TOP BUTTON */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1000;
        }

        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        /* AI WORKOUT GENERATOR STYLES */
        .ai-workout-generator {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0;
        }

        .ai-gen-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .ai-gen-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .ai-gen-header p {
            opacity: 0.9;
        }

        .ai-gen-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .ai-gen-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ai-gen-form-group {
            display: flex;
            flex-direction: column;
        }

        .ai-gen-form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.9rem;
        }

        .ai-gen-optional-label::after {
            content: ' (Opzionale)';
            color: #999;
            font-weight: 400;
            font-size: 0.85rem;
        }

        .ai-gen-warning-label {
            color: #f59e0b !important;
            font-size: 1rem !important;
        }

        .ai-gen-warning-label::before {
            content: '‚ö†Ô∏è ';
        }

        .ai-gen-form-group input,
        .ai-gen-form-group select,
        .ai-gen-form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .ai-gen-form-group input:focus,
        .ai-gen-form-group select:focus,
        .ai-gen-form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .ai-gen-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .ai-gen-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .ai-gen-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .ai-gen-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ai-gen-loading {
            text-align: center;
            padding: 2rem;
            display: none;
        }

        .ai-gen-loading.show {
            display: block;
        }

        .ai-gen-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ai-gen-progress-container {
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
            background: #f3f3f3;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
        }

        .ai-gen-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .ai-gen-result {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .ai-gen-result.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .ai-gen-result.error {
            background: #fee;
            border-left-color: #f44;
            color: #c33;
        }

        .ai-gen-workout-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 2px solid #e0e0e0;
        }

        .ai-gen-workout-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .ai-gen-exercise-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .ai-gen-exercise-item h4 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .ai-gen-exercise-details {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .ai-gen-copy-btn {
            background: #34d399;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .ai-gen-copy-btn:hover {
            background: #10b981;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- HEADER -->
        <div class="header">
            <h1>üí™ App Palestra 3</h1>
            <div class="header-stats">
                <span id="weeklyStreak">üî• 0 settimane consecutive</span>
            </div>
        </div>

        <!-- NAVIGATION -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-page="workout">üèãÔ∏è Allenamento</button>
            <button class="nav-tab" data-page="Schede">‚öôÔ∏è Schede</button>
            <button class="nav-tab" data-page="progress">üìà Progressi</button>
            <button class="nav-tab" data-page="history">üìÖ Storia</button>
            <button class="nav-tab nav-tab-ai" data-page="ai-assistant">ü§ñ AI Personal</button>
        </div>

        <!-- WORKOUT PAGE -->
        <div id="workoutPage" class="page active">
            <div class="workout-title">
                <h2 id="workoutTitle">Allenamento di Oggi</h2>
                <div class="workout-date" id="workoutDate"></div>
            </div>

            <div class="Schede" id="SchedaButtons">
                <!-- I Scheda verranno inseriti qui -->
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="add-exercise-btn" id="addExerciseBtn">‚ûï Aggiungi Esercizio</button>
            </div>

            <div id="exercisesList">
                <!-- Gli esercizi verranno inseriti qui -->
            </div>

            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                <button class="add-exercise-btn" id="reorderExercisesBtn" onclick="showReorderModal()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: none; padding: 8px 16px; font-size: 0.85rem;">‚ò∞ Ordina</button>
            </div>

            <button class="save-workout-btn" id="saveWorkoutBtn" style="display: none;">üíæ Salva Allenamento</button>
        </div>

        <!-- Templates PAGE -->
        <div id="SchedePage" class="page">
            <button class="add-template-btn" id="addSchedaBtn">‚ûï Crea Nuova Scheda</button>
            <button class="add-template-btn" id="personalSchedeBtn" style="background: #48bb78;">ÔøΩ Sblocca Schede</button>
            <button class="add-template-btn" id="downloadPdfBtn" style="background: #ed8936;">üìÑ Stampa PDF schede</button>
            <button class="add-template-btn" id="deleteAllSchedeBtn" style="background: #e53e3e;">üóëÔ∏è Gestisci Schede</button>
            <div id="SchedaEditorsList">
                <!-- Gli editor dei template verranno inseriti qui -->
            </div>
        </div>

        <!-- PROGRESS PAGE -->
        <div id="progressPage" class="page">
            <!-- MUSCLE GROUP FILTERS (Primary) -->
            <div class="muscle-groups-filter">
                <h3 style="margin-bottom: 15px; color: #2d3748;">üí™ Gruppi Muscolari</h3>
                <div id="muscleGroupButtons" class="muscle-group-btns">
                    <!-- Pulsanti gruppi muscolari generati qui -->
                </div>
            </div>

            <!-- ADDITIONAL FILTERS (Collapsible) -->
            <div class="additional-filters-section">
                <button id="toggleAdditionalFilters" class="toggle-filters-btn">
                    üîΩ Filtri Aggiuntivi
                </button>
                <div id="additionalFiltersContent" class="additional-filters-content" style="display: none;">
                    <div class="progress-filters">
                        <div class="filter-group">
                            <label class="filter-label">Periodo:</label>
                            <select id="timeFilter" class="filter-select">
                                <option value="all">Tutto il tempo</option>
                                <option value="30">Ultimi 30 giorni</option>
                                <option value="90">Ultimi 3 mesi</option>
                                <option value="180">Ultimi 6 mesi</option>
                                <option value="365">Ultimo anno</option>
                                <option value="custom">Personalizzato</option>
                            </select>
                        </div>
                        <div class="filter-group custom-date-group" id="customDateGroup" style="display: none;">
                            <label class="filter-label">Da:</label>
                            <input type="date" id="startDate" class="filter-select">
                            <label class="filter-label" style="margin-left: 10px;">A:</label>
                            <input type="date" id="endDate" class="filter-select">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Esercizio Specifico:</label>
                            <select id="exerciseFilter" class="filter-select">
                                <option value="">Tutti gli esercizi</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROGRESS CHARTS -->
            <div class="progress-charts">
                <div class="chart-container">
                    <h3 class="chart-title">
                        <span>üìä Progressione Peso nel Tempo</span>
                        <span id="weightChartInfo" class="chart-info-badge" style="display: none;"></span>
                    </h3>
                    <div class="chart-canvas">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- EXERCISE LIST -->
            <div id="progressList">
                <!-- I progressi verranno inseriti qui -->
            </div>

            <!-- VOLUME CHART (At the end) -->
            <div class="progress-charts">
                <div class="chart-container">
                    <h3 class="chart-title">üìä Volume di Allenamento</h3>
                    <div class="chart-canvas">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY PAGE -->
        <div id="historyPage" class="page">
            <!-- CALENDARIO -->
            <div class="calendar">
                <div class="calendar-header">
                    <h3 class="calendar-title" id="calendarTitle">Settembre 2025</h3>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prevMonth">‚Äπ</button>
                        <button class="calendar-nav-btn" id="nextMonth">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Il calendario verr√† generato qui -->
                </div>
            </div>

            <div id="historyList">
                <!-- La cronologia verr√† inserita qui -->
            </div>
        </div>

        <!-- AI ASSISTANT PAGE -->
        <div id="ai-assistantPage" class="page">
            <div class="ai-workout-generator">
                <div class="ai-gen-header">
                    <h1>üí™ Generatore Schede Allenamento AI</h1>
                    <p>Crea la tua scheda personalizzata con l'intelligenza artificiale</p>
                </div>
                
                <div class="ai-gen-content">
                    <form id="workoutForm">
                        <div class="ai-gen-form-grid">
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">üë§ Nome</label>
                                <input type="text" name="name" placeholder="Mario Rossi">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">üéÇ Et√†</label>
                                <input type="number" name="age" placeholder="25">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">üìè Altezza (cm)</label>
                                <input type="number" name="height" placeholder="175">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">‚öñÔ∏è Peso (kg)</label>
                                <input type="number" name="weight" placeholder="70">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">üìä Livello Esperienza</label>
                                <select name="level">
                                    <option value="Principiante">Principiante</option>
                                    <option value="Intermedio">Intermedio</option>
                                    <option value="Avanzato">Avanzato</option>
                                </select>
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">üìÖ Sessioni Settimanali</label>
                                <input type="number" name="sessionsPerWeek" placeholder="Auto" min="1" max="7" id="sessionsInput">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">‚è±Ô∏è Tempo per Sessione (min)</label>
                                <input type="number" name="time" placeholder="Auto (40-90 min)" min="30" max="180">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">üî¢ Esercizi per Sessione</label>
                                <input type="number" name="numExercises" placeholder="Auto (5-11)" min="3" max="12">
                            </div>
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1rem;">
                            <label class="ai-gen-optional-label">üéØ Tipo di Allenamento</label>
                            <select name="workoutType" id="workoutTypeSelect">
                                <option value="">Seleziona tipo...</option>
                                <option value="Senza pesi">Senza pesi</option>
                                <option value="Full Body">Full Body</option>
                                <option value="Push/Pull/Legs">Spinta/Tirata/Gambe</option>
                                <option value="Upper/Lower Split">Parte Superiore/Inferiore</option>
                                <option value="Petto-Bicipiti / Dorso-Tricipiti / Gambe-Spalle">Petto-Bicipiti / Dorso-Tricipiti / Gambe-Spalle</option>
                                <option value="Personalizzato">Personalizzato</option>
                            </select>
                            <input type="text" id="customWorkoutType" name="customWorkoutType" placeholder="Descrivi il tuo allenamento personalizzato..." style="display: none; margin-top: 0.5rem;">
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1rem;">
                            <label class="ai-gen-optional-label">üéØ Obiettivi</label>
                            <textarea name="goals" placeholder="Es: Aumentare massa muscolare, perdere peso, migliorare forza..."></textarea>
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1rem;">
                            <label class="ai-gen-optional-label">‚ù§Ô∏è Esercizi Preferiti</label>
                            <textarea name="preferredExercises" placeholder="Es: Panca piana, squat, stacchi..."></textarea>
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1rem;">
                            <label class="ai-gen-optional-label">üö´ Esercizi da Escludere</label>
                            <textarea name="excludedExercises" placeholder="Es: Stacchi da terra, overhead press..."></textarea>
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1.5rem;">
                            <label class="ai-gen-warning-label">Dolori o Limitazioni</label>
                            <textarea name="issues" placeholder="Es: Dolore lombare, problemi al ginocchio..." style="border-color: #f59e0b;"></textarea>
                        </div>
                        
                        <button type="submit" class="ai-gen-btn">üöÄ Genera Scheda</button>
                    </form>
                    
                    <div class="ai-gen-loading" id="loading">
                        <div class="ai-gen-spinner"></div>
                        <p style="color: #667eea; font-weight: 600;">Sto creando la tua scheda personalizzata...</p>
                        <div class="ai-gen-progress-container">
                            <div class="ai-gen-progress-bar" id="progressBar"></div>
                        </div>
                        <p id="progressText" style="color: #667eea; margin-top: 0.5rem; font-size: 0.9rem;">Tempo stimato: 90-120 secondi</p>
                    </div>
                    
                    <div id="result" class="ai-gen-result"></div>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="exerciseModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuovo Esercizio</h3>
                <div class="autocomplete-container">
                    <input type="text" id="exerciseNameInput" class="modal-input" placeholder="Nome esercizio">
                    <div id="exerciseSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmAddExercise">Aggiungi</button>
                    <button class="modal-btn secondary" id="cancelAddExercise">Annulla</button>
                </div>
            </div>
        </div>

        <div id="SchedaExerciseModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Esercizio Scheda</h3>
                <div class="autocomplete-container">
                    <input type="text" id="SchedaExerciseNameInput" class="modal-input" placeholder="Nome esercizio">
                    <div id="SchedaExerciseSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <input type="number" id="SchedaExerciseSetsInput" class="modal-input" placeholder="Serie" style="margin-bottom: 0;">
                    <input type="number" id="SchedaExerciseRepsInput" class="modal-input" placeholder="Reps" style="margin-bottom: 0;">
                    <input type="number" id="SchedaExerciseWeightInput" class="modal-input" placeholder="Kg" step="0.5" style="margin-bottom: 0;">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmAddSchedaExercise">Aggiungi</button>
                    <button class="modal-btn secondary" id="cancelAddSchedaExercise">Annulla</button>
                </div>
            </div>
        </div>

        <div id="newSchedaModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ûï Nuovo Scheda</h3>
                <input type="text" id="newSchedaNameInput" class="modal-input" placeholder="Nome del Scheda">
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmAddScheda">Crea</button>
                    <button class="modal-btn secondary" id="cancelAddScheda">Annulla</button>
                </div>
            </div>
        </div>

        <div id="saveModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">üíæ Salva Allenamento</h3>
                <input type="date" id="workoutDateInput" class="modal-input">
                <input type="number" id="durationInput" class="modal-input" placeholder="Durata (minuti)">
                <textarea id="notesInput" class="modal-input" placeholder="Note sull'allenamento..." rows="3"></textarea>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmSaveWorkout">Salva</button>
                    <button class="modal-btn secondary" id="cancelSaveWorkout">Annulla</button>
                </div>
            </div>
        </div>

        <div id="reorderModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">‚ÜïÔ∏è Ordina Esercizi</h3>
                <div id="reorderList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Lista esercizi da riordinare -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmReorder">Conferma</button>
                    <button class="modal-btn secondary" id="cancelReorder">Annulla</button>
                </div>
            </div>
        </div>

        <div id="muscleSelectionModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">üèãÔ∏è‚Äç‚ôÇÔ∏è Configura Nuovo Esercizio</h3>
                <p class="modal-description">Questo esercizio non √® nel database. Seleziona i muscoli che allena:</p>
                
                <div class="muscle-selection">
                    <div class="muscle-type-selection">
                        <label class="muscle-type-label">
                            <input type="radio" name="exerciseType" value="traditional" checked>
                            üí™ Esercizio tradizionale (serie, reps, peso)
                        </label>
                        <label class="muscle-type-label">
                            <input type="radio" name="exerciseType" value="cardio">
                            üèÉ‚Äç‚ôÇÔ∏è Esercizio cardio (tempo, distanza)
                        </label>
                    </div>
                    
                    <div class="muscles-grid-selection" id="musclesGridSelection">
                        <h4>Seleziona i muscoli allenati:</h4>
                        <div class="muscles-checkboxes">
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="quadricipiti">
                                <span>Quadricipiti</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="bicipiti femorali">
                                <span>Bicipiti Femorali</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="polpacci">
                                <span>Polpacci</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="dorso">
                                <span>Dorso</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="petto">
                                <span>Petto</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="spalle">
                                <span>Spalle</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="bicipiti">
                                <span>Bicipiti</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="tricipiti">
                                <span>Tricipiti</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="addome">
                                <span>Addome</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Campi di input dinamici -->
                    <div class="exercise-inputs-section">
                        <h4 id="inputsTitle">Specifica i parametri dell'esercizio:</h4>
                        
                        <!-- Campi per esercizi tradizionali -->
                        <div id="traditionalInputs" class="exercise-inputs">
                            <div class="input-group">
                                <label for="exerciseSets">Serie:</label>
                                <input type="number" id="exerciseSets" class="modal-input" value="3" min="1" max="10">
                            </div>
                            <div class="input-group">
                                <label for="exerciseReps">Ripetizioni:</label>
                                <input type="number" id="exerciseReps" class="modal-input" value="10" min="1" max="100">
                            </div>
                            <div class="input-group">
                                <label for="exerciseWeight">Peso (kg):</label>
                                <input type="number" id="exerciseWeight" class="modal-input" value="0" min="0" step="0.5">
                            </div>
                        </div>
                        
                        <!-- Campi per esercizi cardio -->
                        <div id="cardioInputs" class="exercise-inputs" style="display: none;">
                            <div class="input-group">
                                <label for="exerciseTime">Tempo (minuti):</label>
                                <input type="number" id="exerciseTime" class="modal-input" value="30" min="1" max="300">
                            </div>
                            <div class="input-group">
                                <label for="exerciseDistance">Distanza (km):</label>
                                <input type="number" id="exerciseDistance" class="modal-input" value="5" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
                    <button class="modal-btn primary" id="confirmMuscleSelection">Conferma</button>
                    <button class="modal-btn secondary" id="cancelMuscleSelection">Annulla</button>
                </div>
            </div>
        </div>

        <div id="deleteSchedeModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">üóëÔ∏è Gestisci Schede</h3>
                <p class="modal-description">Seleziona le schede da eliminare:</p>
                
                <div class="schede-selection" id="schedeSelectionList">
                    <!-- Le schede verranno popolate dinamicamente -->
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmDeleteSelectedSchede" style="background: #e53e3e;">Elimina Selezionate</button>
                    <button class="modal-btn secondary" id="cancelDeleteSchede">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BACK TO TOP BUTTON -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()">‚Üë</button>

    <script>
        // FUNZIONE DI NORMALIZZAZIONE ESERCIZI
        function normalizeExerciseName(name) {
            if (!name) return '';
            // Trim spazi, converti in lowercase, rimuovi spazi multipli
            return name.trim().toLowerCase().replace(/\s+/g, ' ');
        }

        // Funzione per ottenere il nome formattato (prima lettera maiuscola di ogni parola)
        function formatExerciseName(name) {
            if (!name) return '';
            const normalized = normalizeExerciseName(name);
            return normalized
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // VARIABILI GLOBALI
        let currentExercises = [];
        let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
        
        // Valida e pulisce workoutHistory per evitare errori
        // Accetta sia string che number come ID validi
        workoutHistory = workoutHistory.filter(w => w && (w.id !== undefined && w.id !== null));
        
        let currentCalendarDate = new Date();
        let currentEditingScheda = null;
        let selectedSuggestionIndex = -1;
        let weightChart = null;
        let volumeChart = null;
        let currentSchedaName = null;
        let selectedMuscleGroup = null; // Per il filtro muscolare nella pagina progressi
        
        // Sistema codici per schede protette
    let unlockedCodes = JSON.parse(localStorage.getItem('unlockedCodes') || '[]');
        const codeMappings = {
            'Giulia24': ['giulia24_giorno1', 'giulia24_giorno2', 'giulia24_giorno3'],
            'Giovanna0': ['giovanna0_alta_a', 'giovanna0_bassa_a', 'giovanna0_alta_b', 'giovanna0_bassa_b'],
            'doriano0': ['doriano0_giorno1', 'doriano0_giorno2'],
            'Giovanna0126': ['giovanna0126_giorno1', 'giovanna0126_giorno2', 'giovanna0126_giorno3', 'giovanna0126_giorno4', 'giovanna0126_giorno5']
        };

        const protectedSchedeData = {
            'giulia24_giorno1': {
                name: 'üí™ Scheda Palestra G - Giorno 1: Gambe + Addome',
                exercises: [
                    { name: 'Tapis Roulant o Cyclette', sets: 1, reps: 15, weight: 0 },
                    { name: 'Leg Extension', sets: 4, reps: 12, weight: 40 },
                    { name: 'Leg Press (orizzontale)', sets: 3, reps: 12, weight: 100 },
                    { name: 'Leg Curl', sets: 3, reps: 12, weight: 35 },
                    { name: 'Crunch Machine', sets: 3, reps: 20, weight: 30 },
                    { name: 'Crunch Inversi', sets: 3, reps: 20, weight: 0 }
                ]
            },
            'giulia24_giorno2': {
                name: 'üèãÔ∏è Scheda Palestra G - Giorno 2: Petto + Spalle + Tricipiti',
                exercises: [
                    { name: 'Tapis Roulant o Cyclette', sets: 1, reps: 15, weight: 0 },
                    { name: 'Chest Press', sets: 4, reps: 12, weight: 60 },
                    { name: 'Chest Fly', sets: 3, reps: 15, weight: 25 },
                    { name: 'Alzate Laterali (Spalle)', sets: 3, reps: 15, weight: 8 },
                    { name: 'Pushdown Tricipiti', sets: 3, reps: 15, weight: 25 },
                    { name: 'Tapis Roulant', sets: 1, reps: 15, weight: 0 }
                ]
            },
            'giulia24_giorno3': {
                name: 'üî• Scheda Palestra G - Giorno 3: Schiena + Bicipiti + Spalle + Addome',
                exercises: [
                    { name: 'Tapis Roulant o Cyclette', sets: 1, reps: 15, weight: 0 },
                    { name: 'Lat Machine', sets: 4, reps: 12, weight: 50 },
                    { name: 'Low Row', sets: 3, reps: 15, weight: 45 },
                    { name: 'Curl Bicipiti', sets: 3, reps: 15, weight: 20 },
                    { name: 'Alzate Frontali (Spalle)', sets: 3, reps: 12, weight: 10 },
                    { name: 'Addominali a Circuito (3 esercizi diversi)', sets: 3, reps: 30, weight: 0 }
                ]
            },
            'giovanna0_alta_a': {
                name: 'üí™ Giovanna0 - Giorno 1: Alta A',
                exercises: [
                    { name: 'Camminata o Ellittica (Riscaldamento)', sets: 1, reps: 5, weight: 0 },
                    { name: 'Lat Machine presa classica (Riscaldamento)', sets: 1, reps: 12, weight: 30 },
                    { name: 'Lat Machine presa classica', sets: 3, reps: 12, weight: 45 },
                    { name: 'Pulley', sets: 3, reps: 12, weight: 35 },
                    { name: 'Chest Fly (Riscaldamento)', sets: 1, reps: 15, weight: 20 },
                    { name: 'Chest Fly', sets: 3, reps: 15, weight: 25 },
                    { name: 'Panca Piana con Bilanciere', sets: 3, reps: 12, weight: 50 },
                    { name: 'Curl al Cavo Basso', sets: 3, reps: 15, weight: 20 },
                    { name: 'Plank Laterale', sets: 3, reps: 30, weight: 0 },
                    { name: 'Tapis Roulant o Cyclette (Cardio)', sets: 1, reps: 20, weight: 0 },
                    { name: 'Stretching Pettorali, Dorsali, Spalle, Braccia', sets: 1, reps: 7, weight: 0 }
                ]
            },
            'giovanna0_bassa_a': {
                name: 'ü¶µ Giovanna0 - Giorno 2: Bassa A',
                exercises: [
                    { name: 'Camminata in Salita (Riscaldamento)', sets: 1, reps: 15, weight: 0 },
                    { name: 'Hip Thrust (Riscaldamento)', sets: 1, reps: 12, weight: 30 },
                    { name: 'Hip Thrust', sets: 3, reps: 12, weight: 50 },
                    { name: 'Squat al Muro', sets: 3, reps: 30, weight: 0 },
                    { name: 'Leg Curl', sets: 3, reps: 12, weight: 35 },
                    { name: 'Kick Back Macchinario', sets: 3, reps: 12, weight: 25 },
                    { name: 'Abductor', sets: 3, reps: 15, weight: 30 },
                    { name: 'Alzate Laterali', sets: 3, reps: 15, weight: 8 },
                    { name: 'Bicicletta (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Crunch (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Tocca Talloni (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Camminata in Salita (Cardio)', sets: 1, reps: 20, weight: 0 },
                    { name: 'Stretching Catena Posteriore, Anche, Lombari', sets: 1, reps: 7, weight: 0 }
                ]
            },
            'giovanna0_alta_b': {
                name: 'üèãÔ∏è Giovanna0 - Giorno 3: Alta B',
                exercises: [
                    { name: 'Ellittica o Camminata (Riscaldamento)', sets: 1, reps: 5, weight: 0 },
                    { name: 'Panca Inclinata con Bilanciere (Riscaldamento)', sets: 1, reps: 12, weight: 30 },
                    { name: 'Panca Inclinata con Bilanciere', sets: 3, reps: 12, weight: 45 },
                    { name: 'Chest Press (Macchinario)', sets: 3, reps: 12, weight: 50 },
                    { name: 'Macchinario Tirate Dorso (Riscaldamento)', sets: 1, reps: 10, weight: 35 },
                    { name: 'Macchinario Tirate Dorso', sets: 3, reps: 10, weight: 50 },
                    { name: 'Trazioni Assistite', sets: 3, reps: 10, weight: 0 },
                    { name: 'Macchinario Tricipiti', sets: 3, reps: 15, weight: 25 },
                    { name: 'Plank', sets: 3, reps: 30, weight: 0 },
                    { name: 'Ellittica o Cyclette (Cardio)', sets: 1, reps: 20, weight: 0 },
                    { name: 'Stretching Spalle, Schiena, Braccia', sets: 1, reps: 7, weight: 0 }
                ]
            },
            'giovanna0_bassa_b': {
                name: 'üî• Giovanna0 - Giorno 4: Bassa B',
                exercises: [
                    { name: 'Cyclette o Tapis (Riscaldamento)', sets: 1, reps: 15, weight: 0 },
                    { name: 'Leg Press Verticale (Riscaldamento)', sets: 1, reps: 12, weight: 80 },
                    { name: 'Leg Press Verticale', sets: 3, reps: 12, weight: 120 },
                    { name: 'Kick Back al Cavo', sets: 3, reps: 15, weight: 15 },
                    { name: 'Leg Press Orizzontale', sets: 3, reps: 12, weight: 100 },
                    { name: 'Macchinario Polpacci', sets: 3, reps: 15, weight: 40 },
                    { name: 'Adductor', sets: 3, reps: 15, weight: 35 },
                    { name: 'Shoulder Press', sets: 3, reps: 15, weight: 25 },
                    { name: 'Russian Twist (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Plank Laterale con Sollevamento Gamba', sets: 3, reps: 45, weight: 0 },
                    { name: 'Crunch (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Camminata in Salita (Cardio)', sets: 1, reps: 20, weight: 0 },
                    { name: 'Stretching Quadricipiti, Glutei, Femorali', sets: 1, reps: 7, weight: 0 }
                ]
            },
            'doriano0_giorno1': {
                name: 'üí™ Doriano0 - Giorno 1: Full Body A',
                exercises: [
                    { name: 'Squat', sets: 3, reps: 12, weight: 60 },
                    { name: 'Panca Piana', sets: 3, reps: 10, weight: 60 },
                    { name: 'Lat Machine', sets: 3, reps: 12, weight: 50 },
                    { name: 'Leg Press', sets: 3, reps: 12, weight: 120 },
                    { name: 'Military Press', sets: 3, reps: 10, weight: 30 },
                    { name: 'Curl Bilanciere', sets: 3, reps: 12, weight: 25 },
                    { name: 'Tricep Pushdown', sets: 3, reps: 12, weight: 25 },
                    { name: 'Plank', sets: 3, reps: 45, weight: 0 },
                    { name: 'Crunch', sets: 3, reps: 20, weight: 0 },
                    { name: 'Tapis Roulant o Cyclette (Cardio)', sets: 1, reps: 15, weight: 0 }
                ]
            },
            'doriano0_giorno2': {
                name: 'üî• Doriano0 - Giorno 2: Full Body B',
                exercises: [
                    { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 70 },
                    { name: 'Panca Inclinata', sets: 3, reps: 10, weight: 55 },
                    { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 60 },
                    { name: 'Leg Curl', sets: 3, reps: 12, weight: 35 },
                    { name: 'Alzate Laterali', sets: 3, reps: 15, weight: 8 },
                    { name: 'Hammer Curl', sets: 3, reps: 12, weight: 20 },
                    { name: 'Dips', sets: 3, reps: 10, weight: 0 },
                    { name: 'Russian Twist', sets: 3, reps: 30, weight: 0 },
                    { name: 'Leg Raises', sets: 3, reps: 15, weight: 0 },
                    { name: 'Camminata in Salita (Cardio)', sets: 1, reps: 15, weight: 0 }
                ]
            },
            'giovanna0126_giorno1': {
                name: 'üí™ Giovanna0126 - Giorno 1: SPINTA (PUSH) & QUADRICIPITI',
                exercises: [
                    { name: 'Leg Press', sets: 4, reps: 10, weight: 0, note: 'Carica progressivamente, 10 per gamba' },
                    { name: 'Spinte con Manubri su Panca Inclinata', sets: 3, reps: 12, weight: 0, note: 'Panca inclinata a circa 30¬∞' },
                    { name: 'Croci con Manubri su Panca Piana', sets: 3, reps: 15, weight: 0, note: 'Movimento ampio per "aprire" il petto' },
                    { name: 'Arnold Press (Spalle)', sets: 3, reps: 12, weight: 0, note: 'Rotazione dei polsi durante la spinta in alto' },
                    { name: 'Alzate Laterali con Manubri', sets: 4, reps: 12, weight: 0, note: 'Gomiti leggermente piegati' },
                    { name: 'Leg Extension (Unilaterale)', sets: 3, reps: 15, weight: 0, note: 'Una gamba alla volta per correggere asimmetrie, 15 per gamba' },
                    { name: 'Push Down Cavo Alto con Corda', sets: 3, reps: 15, weight: 0, note: 'Per i tricipiti. Tieni i gomiti fermi' }
                ]
            },
            'giovanna0126_giorno2': {
                name: 'üèãÔ∏è Giovanna0126 - Giorno 2: TRAZIONE (PULL) & FEMORALI',
                exercises: [
                    { name: 'Stacchi Rumeni con Manubri', sets: 3, reps: 12, weight: 0, note: 'Schiena dritta, senti "tirare" dietro le cosce' },
                    { name: 'Lat Machine Avanti (Presa Larga)', sets: 4, reps: 10, weight: 0, note: 'Porta la sbarra al petto alto, non dietro la nuca' },
                    { name: 'Pulley Basso', sets: 3, reps: 12, weight: 0, note: 'Tira verso l\'ombelico, petto in fuori' },
                    { name: 'Lat Machine Presa Inversa (Stretta)', sets: 3, reps: 12, weight: 0, note: 'Palmi rivolti verso di te. Coinvolge i bicipiti' },
                    { name: 'Alzate a 90¬∞ (o Macchina Deltoidi Post.)', sets: 3, reps: 15, weight: 0, note: 'Fondamentale per aprire le spalle' },
                    { name: 'Leg Curl Seduto', sets: 3, reps: 15, weight: 0, note: 'Controlla la fase di ritorno' },
                    { name: 'Curl Bicipiti Alternato con Manubri', sets: 3, reps: 12, weight: 0, note: 'In piedi o seduta' }
                ]
            },
            'giovanna0126_giorno3': {
                name: 'ü¶µ Giovanna0126 - Giorno 3: FOCUS GAMBE & GLUTEI (HEAVY)',
                exercises: [
                    { name: 'Hip Thrust con Bilanciere', sets: 4, reps: 10, weight: 0, note: 'Mantieni la contrazione in alto per 2 secondi' },
                    { name: 'Leg Press (Piedi Alti e Larghi)', sets: 4, reps: 12, weight: 0, note: 'Piedi posizionati in alto sulla pedana per focus glutei' },
                    { name: 'Leg Curl (Gamba Singola)', sets: 3, reps: 12, weight: 0, note: 'Lento e controllato, 12 per gamba' },
                    { name: 'Slanci Posteriori ai Cavi (Kickback)', sets: 3, reps: 20, weight: 0, note: 'Gamba tesa, contrai forte il gluteo, 20 per gamba' },
                    { name: 'Abductor Machine (Esterno Coscia)', sets: 3, reps: 20, weight: 0, note: 'Busto leggermente inclinato in avanti' },
                    { name: 'Adductor Machine (Interno Coscia)', sets: 3, reps: 20, weight: 0, note: 'Movimento controllato' },
                    { name: 'Calf Raise (Polpacci) alla Pressa o Step', sets: 4, reps: 15, weight: 0, note: 'Tieni il tallone basso nel massimo allungamento' }
                ]
            },
            'giovanna0126_giorno4': {
                name: 'üî• Giovanna0126 - Giorno 4: UPPER BODY "PUMP" & POSTURA',
                exercises: [
                    { name: 'Lat Machine a Braccia Tese (Pull-down)', sets: 3, reps: 15, weight: 0, note: 'In piedi al cavo alto. Ottimo per la postura' },
                    { name: 'Pectoral Machine', sets: 3, reps: 15, weight: 0, note: 'Concentrati sulla contrazione del petto' },
                    { name: 'Face Pull (Tirate al Viso Cavo Alto)', sets: 4, reps: 15, weight: 0, note: 'Tira la corda verso la fronte aprendo i gomiti' },
                    { name: 'French Press con Manubri (Sdraiata)', sets: 3, reps: 12, weight: 0, note: 'Focus sui tricipiti' },
                    { name: 'Hammer Curl (Bicipiti a Martello)', sets: 3, reps: 12, weight: 0, note: 'Pollici verso l\'alto' },
                    { name: 'Plank Commando', sets: 3, reps: 45, weight: 0, note: 'Sali e scendi dai gomiti alle mani, 45 secondi' },
                    { name: 'Hyperextension (Lombari)', sets: 3, reps: 15, weight: 0, note: 'Esecuzione lenta e controllata' }
                ]
            },
            'giovanna0126_giorno5': {
                name: '‚ù§Ô∏è Giovanna0126 - Giorno 5: CARDIO & CORE COMPLETO',
                exercises: [
                    { name: 'Camminata in Salita sul Tapis Roulant', sets: 1, reps: 40, weight: 0, note: 'Pendenza 6-10%, velocit√† moderata. 35-45 minuti' },
                    { name: 'Crunch Classico a Terra', sets: 3, reps: 20, weight: 0, note: 'Circuito Core - Ripetere 3 volte' },
                    { name: 'Reverse Crunch (Sollevamento Bacino)', sets: 3, reps: 15, weight: 0, note: 'Circuito Core' },
                    { name: 'Russian Twist', sets: 3, reps: 20, weight: 0, note: 'Con o senza peso. Circuito Core, 20 ripetizioni totali' },
                    { name: 'Side Plank', sets: 3, reps: 40, weight: 0, note: 'Circuito Core, 30-45 secondi per lato' },
                    { name: 'Vacuum Addominale (Opzionale)', sets: 3, reps: 10, weight: 0, note: 'Al massimo sfinimento. Ottimo per il trasverso' },
                    { name: 'Stretching Completo', sets: 1, reps: 10, weight: 0, note: 'Stretching di tutto il corpo, 10 minuti' }
                ]
            }
        };

        // Schede PERSONALIZZABILI
        let customSchede = JSON.parse(localStorage.getItem('customSchede') || JSON.stringify({
            push: {
                name: 'üî• Push Day',
                exercises: [
                    { name: 'Panca Piana', sets: 4, reps: 8, weight: 80 },
                    { name: 'Panca Inclinata', sets: 3, reps: 10, weight: 60 },
                    { name: 'Spinte Manubri', sets: 3, reps: 12, weight: 25 },
                    { name: 'Dips', sets: 3, reps: 10, weight: 0 },
                    { name: 'Tricep Pushdown', sets: 3, reps: 15, weight: 30 }
                ]
            },
            pull: {
                name: 'üí™ Pull Day',
                exercises: [
                    { name: 'Trazioni', sets: 4, reps: 8, weight: 0 },
                    { name: 'Lat Machine', sets: 3, reps: 10, weight: 50 },
                    { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 60 },
                    { name: 'Pulley', sets: 3, reps: 12, weight: 40 },
                    { name: 'Curl Bilanciere', sets: 3, reps: 12, weight: 30 }
                ]
            },
            legs: {
                name: 'ü¶µ Leg Day',
                exercises: [
                    { name: 'Squat', sets: 4, reps: 10, weight: 100 },
                    { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 80 },
                    { name: 'Leg Press', sets: 3, reps: 15, weight: 200 },
                    { name: 'Leg Extension', sets: 3, reps: 15, weight: 40 },
                    { name: 'Leg Curl', sets: 3, reps: 15, weight: 35 }
                ]
            },
            upper: {
                name: 'üí™ Upper Body',
                exercises: [
                    { name: 'Panca Piana', sets: 3, reps: 10, weight: 70 },
                    { name: 'Trazioni', sets: 3, reps: 8, weight: 0 },
                    { name: 'Military Press', sets: 3, reps: 10, weight: 40 },
                    { name: 'Rematore', sets: 3, reps: 10, weight: 50 }
                ]
            },
            cardio: {
                name: 'üèÉ Cardio Session',
                exercises: [
                    { name: 'Tapis Roulant', sets: 1, reps: 20, weight: 0 },
                    { name: 'Cyclette', sets: 1, reps: 15, weight: 0 },
                    { name: 'Ellittica', sets: 1, reps: 10, weight: 0 }
                ]
            }
        }));

        // Rimuovi eventuali schede protette memorizzate in precedenza
        (function purgeProtectedSchede() {
            let removed = false;
            Object.keys(customSchede).forEach(key => {
                if (key.startsWith('giulia24_') || key.startsWith('giovanna0_') || key.startsWith('doriano0_')) {
                    delete customSchede[key];
                    removed = true;
                }
            });

            if (removed) {
                localStorage.setItem('customSchede', JSON.stringify(customSchede));
            }
        })();

        // Schede PERSONALI (protette da codice)
        const personalSchede = {
            mamma1: [
                {
                    name: 'üí™ Mamma - Forza Totale',
                    exercises: [
                        { name: 'Panca Piana', sets: 3, reps: 8, weight: 50 },
                        { name: 'Squat', sets: 3, reps: 10, weight: 60 },
                        { name: 'Trazioni', sets: 3, reps: 6, weight: 0 },
                        { name: 'Military Press', sets: 3, reps: 10, weight: 30 }
                    ]
                },
                {
                    name: 'üî• Mamma - Braccia Focus',
                    exercises: [
                        { name: 'Curl Bilanciere', sets: 3, reps: 12, weight: 25 },
                        { name: 'Tricep Pushdown', sets: 3, reps: 15, weight: 25 },
                        { name: 'Dips', sets: 3, reps: 10, weight: 0 },
                        { name: 'Hammer Curl', sets: 3, reps: 12, weight: 20 }
                    ]
                },
                {
                    name: 'ü¶µ Mamma - Gambe Potenti',
                    exercises: [
                        { name: 'Leg Press', sets: 3, reps: 15, weight: 150 },
                        { name: 'Leg Extension', sets: 3, reps: 15, weight: 30 },
                        { name: 'Leg Curl', sets: 3, reps: 15, weight: 25 },
                        { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 50 }
                    ]
                }
            ],
            papa1: [
                {
                    name: 'üèãÔ∏è Papa - Push Day',
                    exercises: [
                        { name: 'Panca Piana', sets: 4, reps: 8, weight: 100 },
                        { name: 'Panca Inclinata', sets: 3, reps: 10, weight: 80 },
                        { name: 'Spinte Manubri', sets: 3, reps: 12, weight: 30 },
                        { name: 'Dips', sets: 3, reps: 10, weight: 0 },
                        { name: 'Tricep Pushdown', sets: 3, reps: 15, weight: 40 }
                    ]
                },
                {
                    name: 'üí™ Papa - Pull Day',
                    exercises: [
                        { name: 'Trazioni', sets: 4, reps: 8, weight: 0 },
                        { name: 'Lat Machine', sets: 3, reps: 10, weight: 60 },
                        { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 70 },
                        { name: 'Pulley', sets: 3, reps: 12, weight: 50 },
                        { name: 'Curl Bilanciere', sets: 3, reps: 12, weight: 35 }
                    ]
                },
                {
                    name: 'ü¶µ Papa - Leg Day',
                    exercises: [
                        { name: 'Squat', sets: 4, reps: 10, weight: 120 },
                        { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 100 },
                        { name: 'Leg Press', sets: 3, reps: 15, weight: 250 },
                        { name: 'Leg Extension', sets: 3, reps: 15, weight: 50 },
                        { name: 'Leg Curl', sets: 3, reps: 15, weight: 45 }
                    ]
                }
            ]
        };

        function getUnlockedProtectedSchede() {
            const seen = new Set();
            const result = [];

            unlockedCodes.forEach(code => {
                const ids = codeMappings[code] || [];
                ids.forEach(id => {
                    if (!seen.has(id) && protectedSchedeData[id]) {
                        seen.add(id);
                        result.push([id, protectedSchedeData[id]]);
                    }
                });
            });

            return result;
        }

        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App Palestra 3 - Versione con AI Personal inizializzata');
            
            // Migrazione dati esistenti per aggiungere ID univoci
            migrateWorkoutHistory();
            
            initializeApp();
            setupEventListeners();
            setupAutocomplete();
            setupAIAssistant();
        });

        // CORREZIONE BUG 2: Migrazione dati per aggiungere ID univoci
        function migrateWorkoutHistory() {
            let needsMigration = false;
            workoutHistory.forEach(workout => {
                if (!workout.id) {
                    workout.id = Date.now() + Math.random();
                    needsMigration = true;
                }
            });
            
            if (needsMigration) {
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
            }
        }

        // INIZIALIZZAZIONE ALLENAMENTI DI ESEMPIO
        function initializeSampleWorkouts() {
            // Controlla se ci sono gi√† allenamenti salvati (non esempi)
            const hasRealWorkouts = workoutHistory.some(w => {
                const idStr = String(w.id);
                return !idStr.startsWith('sample_') && !w.isSample;
            });
            
            if (hasRealWorkouts) {
                // Se l'utente ha salvato almeno un allenamento, rimuovi solo gli esempi
                const filtered = workoutHistory.filter(w => {
                    const idStr = String(w.id);
                    return !w.isSample && !idStr.startsWith('sample_');
                });
                
                // Solo se effettivamente abbiamo rimosso qualcosa, aggiorna
                if (filtered.length !== workoutHistory.length) {
                    workoutHistory.length = 0;
                    workoutHistory.push(...filtered);
                    localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
                }
                return;
            }

            // Controlla se gli esempi esistono gi√†
            const hasSamples = workoutHistory.some(w => {
                const idStr = String(w.id);
                return idStr.startsWith('sample_');
            });
            if (hasSamples) return;

            const today = new Date();
            const sampleWorkouts = [
                {
                    id: 'sample_1_' + Date.now(),
                    date: '2025-08-15', // Agosto 2025
                    name: 'Allenamento Gambe - Agosto',
                    schedaName: 'ü¶µ Scheda Gambe',
                    exercises: [
                        { name: 'Squat', sets: 4, reps: 10, weight: 60, completed: true },
                        { name: 'Leg Press', sets: 3, reps: 12, weight: 120, completed: true },
                        { name: 'Leg Curl', sets: 3, reps: 12, weight: 40, completed: true },
                        { name: 'Leg Extension', sets: 3, reps: 12, weight: 50, completed: true },
                        { name: 'Calf Raises', sets: 4, reps: 15, weight: 60, completed: true }
                    ],
                    duration: 50,
                    notes: 'Allenamento intenso agosto!',
                    isSample: true
                },
                {
                    id: 'sample_2_' + Date.now(),
                    date: '2025-08-22', // Agosto 2025
                    name: 'Allenamento Petto - Agosto',
                    schedaName: 'üí™ Scheda Petto',
                    exercises: [
                        { name: 'Panca Piana', sets: 4, reps: 8, weight: 70, completed: true },
                        { name: 'Panca Inclinata', sets: 3, reps: 10, weight: 60, completed: true },
                        { name: 'Croci con Manubri', sets: 3, reps: 12, weight: 20, completed: true },
                        { name: 'Dips', sets: 3, reps: 10, weight: 0, completed: true }
                    ],
                    duration: 45,
                    notes: 'Agosto - focus petto!',
                    isSample: true
                },
                {
                    id: 'sample_3_' + Date.now(),
                    date: new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 6 giorni fa (Luned√¨)
                    name: 'Allenamento Full Body - Esempio',
                    schedaName: 'üèãÔ∏è Full Body Principiante - Livello 1',
                    exercises: [
                        { name: 'Squat', sets: 3, reps: 12, weight: 40, completed: true },
                        { name: 'Panca Piana', sets: 3, reps: 10, weight: 50, completed: true },
                        { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 40, completed: true },
                        { name: 'Military Press', sets: 3, reps: 8, weight: 30, completed: true },
                        { name: 'Plank', sets: 3, reps: 30, weight: 0, completed: true }
                    ],
                    duration: 45,
                    notes: 'Primo allenamento di esempio - puoi cancellarlo quando vuoi!',
                    isSample: true
                },
                {
                    id: 'sample_4_' + Date.now(),
                    date: new Date(today.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 4 giorni fa (Mercoled√¨)
                    name: 'Allenamento Full Body - Esempio 2',
                    schedaName: 'üí™ Full Body Principiante - Livello 2',
                    exercises: [
                        { name: 'Squat', sets: 3, reps: 12, weight: 45, completed: true },
                        { name: 'Panca Piana', sets: 3, reps: 10, weight: 55, completed: true },
                        { name: 'Trazioni', sets: 3, reps: 8, weight: 0, completed: true },
                        { name: 'Military Press', sets: 3, reps: 8, weight: 32, completed: true },
                        { name: 'Russian Twists', sets: 3, reps: 20, weight: 0, completed: true }
                    ],
                    duration: 50,
                    notes: 'Secondo allenamento di esempio - mostra il progresso!',
                    isSample: true
                },
                {
                    id: 'sample_5_' + Date.now(),
                    date: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 2 giorni fa (Venerd√¨)
                    name: 'Allenamento Full Body - Esempio 3',
                    schedaName: 'üèãÔ∏è Full Body Principiante - Livello 1',
                    exercises: [
                        { name: 'Squat', sets: 4, reps: 10, weight: 50, completed: true },
                        { name: 'Panca Piana', sets: 4, reps: 8, weight: 60, completed: true },
                        { name: 'Rematore Bilanciere', sets: 3, reps: 12, weight: 45, completed: true },
                        { name: 'Military Press', sets: 3, reps: 10, weight: 35, completed: true },
                        { name: 'Plank', sets: 3, reps: 45, weight: 0, completed: true }
                    ],
                    duration: 55,
                    notes: 'Terzo allenamento - aumentando i pesi!',
                    isSample: true
                },
                {
                    id: 'sample_6_' + Date.now(),
                    date: new Date(today.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // Ieri (Sabato)
                    name: 'Allenamento Full Body - Esempio 4',
                    schedaName: 'üí™ Full Body Principiante - Livello 2',
                    exercises: [
                        { name: 'Squat', sets: 4, reps: 10, weight: 55, completed: true },
                        { name: 'Panca Piana', sets: 4, reps: 8, weight: 65, completed: true },
                        { name: 'Trazioni', sets: 4, reps: 6, weight: 0, completed: true },
                        { name: 'Military Press', sets: 4, reps: 8, weight: 38, completed: true },
                        { name: 'Russian Twists', sets: 4, reps: 25, weight: 0, completed: true }
                    ],
                    duration: 60,
                    notes: 'Quarto allenamento - costanza paga! Cancella questi esempi quando vuoi iniziare i tuoi allenamenti.',
                    isSample: true
                }
            ];

            // Aggiungi gli allenamenti di esempio
            workoutHistory.push(...sampleWorkouts);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
        }

        // INIZIALIZZAZIONE SCHEDE FULL BODY PRINCIPIANTI
        function initializeSampleSchede() {
            // Controlla se ci sono gi√† schede personalizzate
            if (Object.keys(customSchede).length > 2) return; // Ha gi√† pi√π di push/pull

            const sampleSchede = {
                'fullbody_principiante_1': {
                    name: 'üèãÔ∏è Full Body Principiante - Livello 1',
                    exercises: [
                        { name: 'Squat', sets: 3, reps: 12, weight: 20 },
                        { name: 'Panca Piana', sets: 3, reps: 10, weight: 30 },
                        { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 25 },
                        { name: 'Military Press', sets: 3, reps: 8, weight: 15 },
                        { name: 'Plank', sets: 3, reps: 20, weight: 0 }
                    ]
                },
                'fullbody_principiante_2': {
                    name: 'üí™ Full Body Principiante - Livello 2',
                    exercises: [
                        { name: 'Squat', sets: 3, reps: 10, weight: 30 },
                        { name: 'Panca Piana', sets: 3, reps: 8, weight: 40 },
                        { name: 'Trazioni Assistite', sets: 3, reps: 8, weight: 0 },
                        { name: 'Military Press', sets: 3, reps: 8, weight: 20 },
                        { name: 'Russian Twists', sets: 3, reps: 15, weight: 0 }
                    ]
                }
            };

            // Unisci con le schede esistenti
            Object.assign(customSchede, sampleSchede);
            localStorage.setItem('customSchede', JSON.stringify(customSchede));
        }

        function initializeApp() {
            try {
                // Inizializza allenamenti e schede di esempio
                initializeSampleWorkouts();
                initializeSampleSchede();

                // Carica esercizi personalizzati dal localStorage
                const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
                Object.assign(PREDEFINED_EXERCISES, customExercises);
                
                // Mostra statistiche esercizi nel console
                const totalPredefined = Object.keys(PREDEFINED_EXERCISES).length;
                const totalCustom = Object.keys(customExercises).length;
                console.log(`üìä Database Esercizi: ${totalPredefined} totali (${totalCustom} personalizzati)`);

                updateWorkoutDate();
                updateStats();

                // Inizializza con currentExercises vuoto
                currentExercises = [];

                renderExercises();
                renderSchedaButtons();
                renderSchedaEditors();
                renderProgress();
                renderHistory();
                renderCalendar();
            } catch (error) {
                console.error('Errore durante l\'inizializzazione dell\'app:', error);
                alert('Errore durante il caricamento dell\'app: ' + error.message);
            }
        }

        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    showPage(page);
                });
            });

            // Buttons
            document.getElementById('addExerciseBtn').addEventListener('click', showAddExerciseModal);
            document.getElementById('saveWorkoutBtn').addEventListener('click', showSaveWorkoutModal);
            document.getElementById('confirmAddExercise').addEventListener('click', confirmAddExercise);
            document.getElementById('cancelAddExercise').addEventListener('click', hideModal);
            document.getElementById('confirmAddSchedaExercise').addEventListener('click', confirmAddSchedaExercise);
            document.getElementById('cancelAddSchedaExercise').addEventListener('click', hideModal);
            document.getElementById('confirmSaveWorkout').addEventListener('click', confirmSaveWorkout);
            document.getElementById('cancelSaveWorkout').addEventListener('click', hideModal);
            
            // Reorder modal
            document.getElementById('confirmReorder').addEventListener('click', confirmReorder);
            document.getElementById('cancelReorder').addEventListener('click', () => {
                document.getElementById('reorderModal').classList.remove('show');
            });
            
            // Muscle selection modal
            document.getElementById('confirmMuscleSelection').addEventListener('click', confirmMuscleSelection);
            document.getElementById('cancelMuscleSelection').addEventListener('click', cancelMuscleSelection);
            
            // Toggle exercise inputs when radio buttons change
            document.querySelectorAll('input[name="exerciseType"]').forEach(radio => {
                radio.addEventListener('change', toggleExerciseInputs);
            });
            
            // Delete schede modal
            document.getElementById('confirmDeleteSelectedSchede').addEventListener('click', confirmDeleteSelectedSchede);
            document.getElementById('cancelDeleteSchede').addEventListener('click', cancelDeleteSchede);
            
            // New Scheda buttons
            document.getElementById('addSchedaBtn').addEventListener('click', showAddSchedaModal);
            document.getElementById('confirmAddScheda').addEventListener('click', confirmAddScheda);
            document.getElementById('cancelAddScheda').addEventListener('click', hideModal);

            // Personal Schede buttons
            document.getElementById('personalSchedeBtn').addEventListener('click', showPersonalSchedeModal);
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadSchedePdf);
            document.getElementById('deleteAllSchedeBtn').addEventListener('click', deleteAllSchede);

            // Calendar navigation
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

            // CORREZIONE BUG 3: Progress filters
            // Time filter change handler
            document.getElementById('timeFilter').addEventListener('change', function() {
                const customDateGroup = document.getElementById('customDateGroup');
                const timeFilter = this.value;
                
                if (timeFilter === 'custom') {
                    customDateGroup.style.display = 'flex';
                    // Set default dates (last 30 days)
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                    
                    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                } else {
                    customDateGroup.style.display = 'none';
                }
                
                updateProgressCharts();
            });
            
            // Custom date inputs change handlers
            document.getElementById('startDate').addEventListener('change', updateProgressCharts);
            document.getElementById('endDate').addEventListener('change', updateProgressCharts);
            document.getElementById('exerciseFilter').addEventListener('change', updateProgressCharts);

            // Toggle additional filters
            document.getElementById('toggleAdditionalFilters').addEventListener('click', function() {
                const content = document.getElementById('additionalFiltersContent');
                const isVisible = content.style.display !== 'none';
                content.style.display = isVisible ? 'none' : 'block';
                this.textContent = isVisible ? 'üîΩ Filtri Aggiuntivi' : 'üîº Nascondi Filtri';
            });

            // Close modal when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideModal();
                    }
                });
            });
        }

        // AI WORKOUT GENERATOR SETUP
        function setupAIAssistant() {
            const workoutForm = document.getElementById('workoutForm');
            if (!workoutForm) return; // Se il form non esiste, esci
            
            const workoutTypeSelect = document.getElementById('workoutTypeSelect');
            const customWorkoutType = document.getElementById('customWorkoutType');
            const sessionsInput = document.getElementById('sessionsInput');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // Mostra/nascondi campo personalizzato
            workoutTypeSelect.addEventListener('change', function() {
                if (this.value === 'Personalizzato') {
                    customWorkoutType.style.display = 'block';
                } else {
                    customWorkoutType.style.display = 'none';
                    customWorkoutType.value = '';
                }
                
                // Auto-seleziona sessioni in base al tipo di allenamento
                if (!sessionsInput.value || sessionsInput.value === '') {
                    autoSelectSessions();
                }
            });

            function autoSelectSessions() {
                const workoutType = workoutTypeSelect.value;
                let suggestedSessions = 3;
                
                switch(workoutType) {
                    case 'Senza pesi':
                    case 'Full Body':
                        suggestedSessions = 3;
                        break;
                    case 'Push/Pull/Legs':
                    case 'Petto-Bicipiti / Dorso-Tricipiti / Gambe-Spalle':
                        suggestedSessions = 3;
                        break;
                    case 'Upper/Lower Split':
                        suggestedSessions = 4;
                        break;
                    default:
                        suggestedSessions = 3;
                }
                
                if (!sessionsInput.value) {
                    sessionsInput.placeholder = `Suggerito: ${suggestedSessions}`;
                }
            }

            function simulateProgress() {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 7;  // Rallentato da 15 a 7
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                }, 2000);  // Rallentato da 1000ms a 2000ms
                return interval;
            }

            workoutForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(workoutForm);
                const data = Object.fromEntries(formData);
                
                // Se tipo personalizzato, usa il testo custom
                let workoutType = data.workoutType;
                if (workoutType === 'Personalizzato' && data.customWorkoutType) {
                    workoutType = data.customWorkoutType;
                }
                
                // Auto-seleziona sessioni se non specificate
                let sessions = data.sessionsPerWeek;
                if (!sessions || sessions === '') {
                    switch(workoutType) {
                        case 'Senza pesi':
                        case 'Full Body':
                            sessions = 3;
                            break;
                        case 'Push/Pull/Legs':
                        case 'Petto-Bicipiti / Dorso-Tricipiti / Gambe-Spalle':
                            sessions = 3;
                            break;
                        case 'Upper/Lower Split':
                            sessions = 4;
                            break;
                        default:
                            sessions = 3;
                    }
                }
                
                // Stima automatica tempo e esercizi se non specificati
                const estimatedTime = data.time || (40 + Math.floor(Math.random() * 51)); // 40-90 min
                const estimatedExercises = data.numExercises || (5 + Math.floor(Math.random() * 7)); // 5-11 esercizi
                
                const prompt = `[INST]
Crea una scheda di allenamento personalizzata in formato JSON valido per l'utente seguente.
Dati utente:
- Nome: ${data.name || 'Utente anonimo'}
- Et√†: ${data.age || 'Non specificata'}
- Altezza: ${data.height || 'Non specificata'} cm
- Peso: ${data.weight || 'Non specificato'} kg
- Livello esperienza: ${data.level || 'Principiante'}
- Sessioni settimanali: ${sessions}
- Tempo per sessione: ${estimatedTime} minuti${data.time ? '' : ' (stimato dall\'AI)'}
- Numero esercizi per sessione: ${estimatedExercises}${data.numExercises ? '' : ' (stimato dall\'AI)'}
- Obiettivi: ${data.goals || 'Generico'}
- Esercizi preferiti: ${data.preferredExercises || 'Nessuno'}
- Tipo di allenamento: ${workoutType || 'Non specificato'}
- Esercizi da escludere: ${data.excludedExercises || 'Nessuno'}
- Dolori o limitazioni: ${data.issues || 'Nessuno'}

Genera una scheda unica e personalizzata basata SOLO su questi dati.
Struttura JSON ESATTA:
{
  "title": "Titolo personalizzato per l'utente",
  "duration_weeks": 8,
  "sessions_per_week": numero da input,
  "workout_days": [
    {
      "day": "Nome sessione",
      "focus": "Gruppo muscolare",
      "exercises": [
        {
          "name": "Nome esercizio",
          "sets": numero serie,
          "reps": "Range reps (es. 10-12)",
          "notes": "(Opzionali) Note personalizzate"
        }
      ]
    }
  ],
  "notes": "Note generali personalizzate"
}

Rispondi SOLO con JSON valido, senza testo extra.
[/INST]`;

                loading.classList.add('show');
                result.classList.remove('show', 'error');
                result.innerHTML = '';
                
                progressBar.style.width = '0%';
                const progressInterval = simulateProgress();
                const startTime = Date.now();
                
                try {
                    // Read API key from runtime config (generated by build.sh or provided by config.js)
                    const GEMINI_KEY = (window.getGeminiKey && typeof window.getGeminiKey === 'function')
                        ? window.getGeminiKey()
                        : (window.GEMINI_KEY || null);

                    if (!GEMINI_KEY) {
                        throw new Error('API Key non configurata. Imposta GEMINI_API_KEY in .env o nelle environment variables del tuo hosting (es. Netlify).');
                    }

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{ text: prompt }]
                                }],
                                generationConfig: {
                                    temperature: 0.7,
                                    topK: 40,
                                    topP: 0.95,
                                    maxOutputTokens: 8192,
                                }
                            })
                        }
                    );
                    
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    
                    const elapsedTime = Math.round((Date.now() - startTime) / 1000);
                    progressText.textContent = `Completato in ${elapsedTime} secondi!`;
                    
                    setTimeout(() => {
                        loading.classList.remove('show');
                    }, 500);
                    
                    const responseData = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(responseData?.error?.message || `Errore HTTP ${response.status}`);
                    }
                    
                    let textResponse = responseData?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    textResponse = textResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    
                    const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('Nessun JSON valido trovato nella risposta');
                    }
                    
                    const workoutData = JSON.parse(jsonMatch[0]);
                    displayWorkout(workoutData);
                    
                } catch (error) {
                    clearInterval(progressInterval);
                    loading.classList.remove('show');
                    result.classList.add('show', 'error');
                    result.innerHTML = `<h3>‚ùå Errore</h3><p>${error.message}</p>`;
                }
            });

            function displayWorkout(workout) {
                let html = `
                    <h2 style="color: #667eea; margin-bottom: 1rem;">${workout.title}</h2>
                    <p style="margin-bottom: 0.5rem;"><strong>Durata:</strong> ${workout.duration_weeks} settimane</p>
                    <p style="margin-bottom: 1.5rem;"><strong>Sessioni settimanali:</strong> ${workout.sessions_per_week}</p>
                `;
                
                workout.workout_days.forEach((day, index) => {
                    html += `
                        <div class="ai-gen-workout-card">
                            <h3>${day.day}</h3>
                            <p style="color: #666; margin-bottom: 1rem;"><strong>Focus:</strong> ${day.focus}</p>
                    `;
                    
                    day.exercises.forEach(ex => {
                        html += `
                            <div class="ai-gen-exercise-item">
                                <h4>üí™ ${ex.name}</h4>
                                <div class="ai-gen-exercise-details"><strong>Serie:</strong> ${ex.sets} √ó <strong>Reps:</strong> ${ex.reps}</div>
                                ${ex.notes ? `<div class="ai-gen-exercise-details" style="color: #8b5cf6; margin-top: 0.5rem;">üìù ${ex.notes}</div>` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                if (workout.notes) {
                    html += `
                        <div style="background: #fffbeb; padding: 1rem; border-radius: 8px; border-left: 4px solid #fbbf24;">
                            <h4 style="color: #92400e; margin-bottom: 0.5rem;">üìã Note Generali</h4>
                            <p style="color: #78350f;">${workout.notes}</p>
                        </div>
                    `;
                }
                
                html += `<button class="ai-gen-copy-btn" onclick="addWorkoutToSchede()">‚ûï Aggiungi a SCHEDE</button>`;
                
                result.innerHTML = html;
                result.classList.add('show');
                window.currentWorkout = workout;
            }

            window.addWorkoutToSchede = function() {
                if (!window.currentWorkout) {
                    alert('‚ùå Nessuna scheda da salvare');
                    return;
                }

                try {
                    const workout = window.currentWorkout;
                    
                    // Chiedi conferma all'utente
                    const confirmMsg = `Vuoi aggiungere "${workout.title}" alle tue schede?`;
                    if (!confirm(confirmMsg)) return;
                    
                    // Usa la variabile globale customSchede invece di crearne una locale
                    // Crea un ID univoco per la nuova scheda
                    const schedeId = 'ai_' + Date.now();
                    
                    // Converti il formato workout in formato scheda
                    // Se ci sono pi√π giorni, crea una scheda per ogni giorno
                    if (workout.workout_days && workout.workout_days.length > 0) {
                        workout.workout_days.forEach((day, index) => {
                            const dayId = schedeId + '_day' + index;
                            // Accorcia il nome della scheda (es: "Giorno 1" invece del titolo completo)
                            customSchede[dayId] = {
                                name: day.day || `Giorno ${index + 1}`,
                                exercises: day.exercises.map(ex => {
                                    // Salva ogni esercizio nel database locale
                                    const muscles = getMuscleGroupsForExercise(ex.name);
                                    saveExerciseToDatabase(ex.name, muscles);
                                    
                                    return {
                                        name: formatExerciseName(ex.name),
                                        sets: parseInt(ex.sets) || 3,
                                        reps: parseInt(ex.reps) || 10,
                                        weight: 0,  // L'utente inserir√† il peso durante l'allenamento
                                        notes: ex.notes || ''  // Salva le note dell'AI
                                    };
                                })
                            };
                        });
                    } else {
                        // Fallback: se non ci sono workout_days, prova a salvare come singola scheda
                        customSchede[schedeId] = {
                            name: 'Scheda AI',
                            exercises: (workout.exercises || []).map(ex => {
                                // Salva ogni esercizio nel database locale
                                const muscles = getMuscleGroupsForExercise(ex.name);
                                saveExerciseToDatabase(ex.name, muscles);
                                
                                return {
                                    ...ex,
                                    notes: ex.notes || ''
                                };
                            })
                        };
                    }
                    
                    // Salva le schede aggiornate nel localStorage
                    localStorage.setItem('customSchede', JSON.stringify(customSchede));
                    
                    // Ricarica le schede in entrambe le UI
                    renderSchedaButtons();   // Per la pagina "Allenamento"
                    renderSchedaEditors();   // Per la pagina "Schede"
                    
                } catch (error) {
                    console.error('Errore nel salvataggio della scheda:', error);
                    alert('‚ùå Errore nel salvataggio della scheda');
                }
            };
        }

        function sendAIMessage(messageOverride = null) {
            const aiInput = document.getElementById('aiInput');
            const message = messageOverride || aiInput.value.trim();
            
            if (!message) return;

            // Add user message
            addAIMessage(message, 'user');
            
            // Clear input only if we didn't override the message
            if (!messageOverride) {
                aiInput.value = '';
                aiInput.style.height = 'auto';
                document.getElementById('aiSendBtn').disabled = true;
            }

            // Show typing indicator
            showAITyping();

            // Simulate AI response delay
            setTimeout(() => {
                hideAITyping();
                const response = generateAIResponse(message);
                addAIMessage(response.text, 'assistant', response.template);
            }, 1500 + Math.random() * 1000);
        }

        function addAIMessage(text, sender, template = null) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            
            let content = `<div class="ai-message-bubble">${text}</div>`;
            
            if (template) {
                content += `
                    <div class="ai-template-preview">
                        <h4>üèãÔ∏è ${template.name}</h4>
                        <ul class="ai-template-exercises">
                            ${template.exercises.map(ex => {
                                let exerciseText = ex.name;
                                if (ex.duration) {
                                    exerciseText += ` - ${ex.duration}`;
                                } else {
                                    exerciseText += ` - ${ex.sets} serie √ó ${ex.reps} reps`;
                                    if (ex.weight > 0) exerciseText += ` @ ${ex.weight}kg`;
                                }
                                return `<li>${exerciseText}</li>`;
                            }).join('')}
                        </ul>
                        <button class="ai-use-template-btn" onclick="useAITemplate('${template.id}')">
                            Usa questa scheda
                        </button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showAITyping() {
            document.getElementById('aiTypingIndicator').style.display = 'flex';
            const messagesContainer = document.getElementById('aiChatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideAITyping() {
            document.getElementById('aiTypingIndicator').style.display = 'none';
        }

        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Scheda generation responses
            if (message.includes('scheda') || message.includes('Scheda') || message.includes('programma')) {
                if (message.includes('principianti') || message.includes('beginner')) {
                    return {
                        text: "üåü **Ecco una scheda perfetta per principianti!**\n\n\n‚ú® Si concentra sui movimenti base e permette di imparare la tecnica corretta.\n\n\nüí™ **Esercizi inclusi:**\n‚Ä¢ Squat - Movimento fondamentale per gambe\n‚Ä¢ Panca Piana - Base per il petto\n‚Ä¢ Rematore - Per la schiena\n‚Ä¢ Military Press - Spalle da urlo\n‚Ä¢ Plank - Core solido\n\n\nüöÄ **Inizia oggi e vedrai progressi incredibili!**",
                        template: {
                            id: 'ai_beginner_' + Date.now(),
                            name: 'üåü Scheda Principianti',
                            exercises: [
                                { name: 'Squat', sets: 3, reps: 12, weight: 40 },
                                { name: 'Panca Piana', sets: 3, reps: 10, weight: 50 },
                                { name: 'Rematore con Bilanciere', sets: 3, reps: 10, weight: 40 },
                                { name: 'Military Press', sets: 3, reps: 8, weight: 30 },
                                { name: 'Plank', sets: 3, reps: 30, weight: 0 }
                            ]
                        }
                    };
                } else if (message.includes('push') && message.includes('pull')) {
                    return {
                        text: "üîÑ **Ottima scelta! Ecco una scheda Push/Pull/Legs bilanciata**\n\n\nüí™ Per massimizzare i tuoi risultati con allenamenti equilibrati!\n\n\nüèãÔ∏è **Giorno Push:** Pettorali, spalle, tricipiti\n\nüèãÔ∏è **Giorno Pull:** Schiena, bicipiti\n\nüèãÔ∏è **Giorno Legs:** Gambe complete\n\n\nüéØ **Esercizi top:** Panca, squat, stacchi, trazioni, dips!\n\n\n‚ö° **Pronto per risultati esplosivi?**",
                        template: {
                            id: 'ai_ppl_' + Date.now(),
                            name: 'üîÑ Push/Pull/Legs',
                            exercises: [
                                { name: 'Panca Piana', sets: 4, reps: 8, weight: 80 },
                                { name: 'Trazioni', sets: 4, reps: 8, weight: 0 },
                                { name: 'Squat', sets: 4, reps: 10, weight: 100 },
                                { name: 'Dips', sets: 3, reps: 12, weight: 0 },
                                { name: 'Pulley', sets: 3, reps: 12, weight: 45 },
                                { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 80 }
                            ]
                        }
                    };
                } else if (message.includes('forza') || message.includes('strength')) {
                    return {
                        text: "üí• **Per aumentare la forza, ecco una scheda focalizzata sui grandi movimenti**\n\n\nüèÜ Con carichi elevati per risultati massimali!\n\n\n‚ö° **Esercizi pesanti:**\n‚Ä¢ Squat 5x5 - Gambe esplosive\n‚Ä¢ Panca 5x5 - Petto potente\n‚Ä¢ Stacco 5x5 - Schiena da titano\n‚Ä¢ Military Press - Spalle forti\n\n\nüî• **Diventa pi√π forte ogni settimana!**",
                        template: {
                            id: 'ai_strength_' + Date.now(),
                            name: 'üí• Forza Massimale',
                            exercises: [
                                { name: 'Squat', sets: 5, reps: 5, weight: 120 },
                                { name: 'Panca Piana', sets: 5, reps: 5, weight: 90 },
                                { name: 'Stacco da Terra', sets: 5, reps: 5, weight: 140 },
                                { name: 'Military Press', sets: 4, reps: 6, weight: 50 }
                            ]
                        }
                    };
                } else if (message.includes('cardio') || message.includes('running') || message.includes('corsa')) {
                    return {
                        text: "üèÉ **Ecco una scheda cardio completa per migliorare la resistenza!**\n\n\nüíì **Sessione bilanciata:** Riscaldamento, lavoro principale, defaticamento\n\n\nüèÉ‚Äç‚ôÇÔ∏è **Esercizi inclusi:**\n‚Ä¢ Corsa leggera - Riscaldamento\n‚Ä¢ Interval training - Bruciare calorie\n‚Ä¢ Camminata veloce - Recupero attivo\n‚Ä¢ Allungamenti - Recupero muscolare\n\n\n‚è±Ô∏è **Durata:** 45-60 minuti per sessione\n\n\nüí™ **Migliora la tua capacit√† cardiovascolare!**",
                        template: {
                            id: 'ai_cardio_' + Date.now(),
                            name: 'üèÉ Cardio Session',
                            exercises: [
                                { name: 'Riscaldamento - Corsa leggera', sets: 1, reps: 1, weight: 0, duration: '10 min' },
                                { name: 'Interval Training - Sprint', sets: 8, reps: 1, weight: 0, duration: '30 sec lavoro / 1 min recupero' },
                                { name: 'Defaticamento - Camminata', sets: 1, reps: 1, weight: 0, duration: '10 min' },
                                { name: 'Allungamenti', sets: 1, reps: 1, weight: 0, duration: '5 min' }
                            ]
                        }
                    };
                }
            }
            
            // Exercise suggestions
            if (message.includes('pettorali') || message.includes('petto') || message.includes('chest') || message.includes('torace')) {
                const chestResponses = [
                    "üèÜ **Come Personal Trainer Elite, ecco la mia strategia scientifica per pettorali da campione:**\n\n\nüî¨ **SCIENZA DEL PETTO:** I pettorali sono composti da 3 fasci principali (clavicolare, sternale, costale) che richiedono angoli diversi per una crescita completa.\n\n\nüí™ **PROGRAMMA ELITE - 4 Giorni/Settimana:**\n\n**GIORNO 1: VOLUME MASSIMALE**\n‚Ä¢ Panca Piana 4x8-12 (70-80% 1RM) - Base di tutto\n‚Ä¢ Panca Inclinata Manubri 4x10-12 - Upper chest focus\n‚Ä¢ Croci Cavi 3x12-15 - Definizione e separazione\n‚Ä¢ Push-ups 3x max - Core stability\n\n**GIORNO 2: INTENSIT√Ä TECNICA**\n‚Ä¢ Panca Declinata 4x6-8 - Lower chest emphasis\n‚Ä¢ Military Press 3x8-10 - Spalle integrit√†\n‚Ä¢ Dips Ponderati 3x8-12 - Tricipiti sinergia\n‚Ä¢ Pec Deck 3x15 - Isolamento finale\n\n**GIORNO 3: RECUPERO ATTIVO**\n‚Ä¢ Panca Piana Leggera 3x15-20\n‚Ä¢ Croci Manubri 3x12-15\n‚Ä¢ Push-ups Varianti 3x10-15\n\n**GIORNO 4: FORZA MASSIMALE**\n‚Ä¢ Panca Piana Close-Grip 5x5 (85% 1RM)\n‚Ä¢ Panca Inclinata 5x5\n‚Ä¢ Dips Bodyweight 4x max\n\nüî• **PROTOCOLLO NUTRIZIONALE:**\n‚Ä¢ 2.2-2.5g/kg proteina giornaliera\n‚Ä¢ Surplus calorico 300-500 kcal\n‚Ä¢ Focus su carboidrati pre/post workout\n‚Ä¢ BCAA durante allenamento\n\n‚ö° **SUPPLEMENTI CONSIGLIATI:**\n‚Ä¢ Creatina 5g/giorno\n‚Ä¢ Beta-Alanina 3-5g\n‚Ä¢ Glutammina 5g post-workout\n‚Ä¢ ZMA per recupero testosterone\n\nÔøΩ **TRACKING PROGRESSI:**\n‚Ä¢ Misura circonferenza torace ogni 4 settimane\n‚Ä¢ Foto progress settimanali\n‚Ä¢ Test forza ogni 6-8 settimane\n\nüí° **SEGRETI DEI PRO:**\n‚Ä¢ Usa pause isometriche (3-5 secondi)\n‚Ä¢ Varia grip width regolarmente\n‚Ä¢ Incorpora tecniche avanzate (rest-pause, dropsets)\n‚Ä¢ Focus mentale: visualizza la contrazione\n\nüöÄ **RISULTATI ATTESI:** 1-2cm di circonferenza in 8-12 settimane con costanza!",
                    "üèãÔ∏è‚Äç‚ôÇÔ∏è **Protocollo Pettorali Avanzato - Metodo Scientifico per Ipertrofia Massimale:**\n\n\nüìä **FISIOLOGIA MUSCOLARE:** I pettorali rispondono meglio a stimoli composti (multi-articolari) combinati con isolamento. Il range 8-12 reps √® ottimale per crescita.\n\n\nüéØ **PROGRAMMAZIONE PERIODIZZATA:**\n\n**FASE 1: IPERTROFIA (4-6 settimane)**\n‚Ä¢ Panca Piana: 4x10-12 @ 70-75% 1RM\n‚Ä¢ Panca Inclinata: 4x10-12 @ 65-70% 1RM\n‚Ä¢ Croci Manubri: 3x12-15\n‚Ä¢ Push-ups: 3x max reps\n\n**FASE 2: FORZA (4 settimane)**\n‚Ä¢ Panca Piana: 5x5 @ 80-85% 1RM\n‚Ä¢ Panca Inclinata: 5x5 @ 75-80% 1RM\n‚Ä¢ Dips: 4x6-8\n‚Ä¢ Military Press: 3x8-10\n\n**FASE 3: DEFINIZIONE (4 settimane)**\n‚Ä¢ Panca Piana: 3x15-20 @ 50-60% 1RM\n‚Ä¢ Croci Cavi: 4x15-20\n‚Ä¢ Pec Deck: 4x20\n‚Ä¢ Cable Flyes: 3x12-15\n\nüî¨ **BIOMECCANICA OTTIMALE:**\n‚Ä¢ Arco lombare naturale (non esagerato)\n‚Ä¢ Scapole retratte e depresse\n‚Ä¢ Gomiti a 45¬∞ dal corpo\n‚Ä¢ Polsi neutri, non flessi\n\n‚ö†Ô∏è **PREVENZIONE INFORTUNI:**\n‚Ä¢ Riscaldamento con mobilit√† spalla\n‚Ä¢ Rotator cuff exercises\n‚Ä¢ Evita lockout completo se hai instabilit√†\n‚Ä¢ Monitora dolore spalla\n\nüíä **RECUPERO STRATEGICO:**\n‚Ä¢ Foam rolling petto e spalle\n‚Ä¢ Stretching post-workout\n‚Ä¢ 48-72 ore recupero tra sessioni\n‚Ä¢ Massaggio sportivo settimanale\n\nüìà **METRICHE SUCCESSO:**\n‚Ä¢ Aumento forza 5-10% ogni 4 settimane\n‚Ä¢ Miglioramento endurance muscolare\n‚Ä¢ Miglior simmetria bilaterale\n‚Ä¢ Riduzione grasso corporeo per definizione\n\nüéñÔ∏è **MENTALIT√Ä CAMPIONE:**\n‚Ä¢ Visualizzazione contrazione muscolare\n‚Ä¢ Focus sulla qualit√†, non quantit√†\n‚Ä¢ Pazienza: risultati in 3-6 mesi consistenti\n‚Ä¢ Celebra piccoli progressi settimanali\n\nüèÜ **DIVENTA UN MOSTRO DEL PETTO!**",
                    "ÔøΩ **Sistema Pettorali Olimpico - Protocollo da Campione del Mondo:**\n\n\nüî• **FILOSOFIA ALLENAMENTO:** Il petto √® il biglietto da visita di un fisico impressionante. Combiniamo scienza, tecnica perfetta e intensit√† calcolata.\n\n\nüèóÔ∏è **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: FORZA PRIORITARIA**\n‚Ä¢ Panca Piana Competition 5x3 @ 85-90% 1RM\n‚Ä¢ Panca Inclinata Manubri 4x8-10\n‚Ä¢ Dips Ponderati 4x8-12\n‚Ä¢ Croci Cavi 3x12-15\n\n**SESSIONE B: IPERTROFIA SPECIALIZZATA**\n‚Ä¢ Panca Declinata 4x10-12\n‚Ä¢ Hammer Strength Press 4x10-12\n‚Ä¢ Pec Deck 3x15-20\n‚Ä¢ Push-ups Diamante 3x max\n\n**SESSIONE C: TECNICA E RECUPERO**\n‚Ä¢ Panca Piana Leggera 3x15-20\n‚Ä¢ Face Pulls 3x12-15 (spalle posteriori)\n‚Ä¢ Stretching Dinamico 10 minuti\n\n‚ö° **PROTOCOLLO INTENSIT√Ä:**\n‚Ä¢ RPE 7-9 per ipertrofia ottimale\n‚Ä¢ Tempo sotto tensione 40-60 secondi\n‚Ä¢ Pause 2-3 secondi in posizioni di massima contrazione\n‚Ä¢ Supersets per aumentare densit√†\n\nüß¨ **NUTRIZIONE PRECISIONE:**\n‚Ä¢ Finestra anabolica 30-60 min post-workout\n‚Ä¢ Rapporto macro: 40% carb, 30% protein, 30% fat\n‚Ä¢ Timing pasti ogni 3-4 ore\n‚Ä¢ Idratazione 4-5L acqua giornaliera\n\nÔøΩ **STRUMENTAZIONE AVANZATA:**\n‚Ä¢ Tracking GPS forza (app come StrengthLog)\n‚Ä¢ Analisi video tecnica\n‚Ä¢ Biofeedback EMG per attivazione muscolare\n‚Ä¢ Test periodici forza massima\n\nüõ°Ô∏è **GESTIONE RISCHI:**\n‚Ä¢ Assessment mobilit√† spalla pre-allenamento\n‚Ä¢ Correzione posture disallineate\n‚Ä¢ Protocollo riscaldamento specifico\n‚Ä¢ Monitoraggio DOMS e prevenzione overtraining\n\nüéØ **OBIETTIVI QUANTIFICABILI:**\n‚Ä¢ Guadagno 0.5-1kg massa magra/mese\n‚Ä¢ Aumento circonferenza torace 2-3cm/trimestre\n‚Ä¢ Miglioramento forza 10-15% ogni ciclo\n‚Ä¢ Riduzione % grasso per definizione\n\nÔøΩ **PSICOLOGIA PERFORMANCE:**\n‚Ä¢ Mental rehearsal contrazioni\n‚Ä¢ Goal setting SMART\n‚Ä¢ Accountability partner\n‚Ä¢ Celebrazione milestone\n\nüèÖ **IL TUO PETTO SAR√Ä LEGGENDARIO!**",
                    "ÔøΩÔ∏è‚Äç‚ôÄÔ∏è **Metodo Pettorali Femminili - Forza & Forma Armoniosa:**\n\n\nüíñ **APPROCCIO OLISTICO:** Per le donne, il petto non √® solo forza ma anche forma estetica. Bilanciamo potenza e grazia.\n\n\nüå∏ **PROGRAMMA 3 GIORNI/SETTIMANA:**\n\n**GIORNO PUSH SUPERIORE**\n‚Ä¢ Panca Piana 3x10-12 @ 60-70% 1RM\n‚Ä¢ Panca Inclinata Manubri 3x12-15\n‚Ä¢ Military Press 3x10-12\n‚Ä¢ Tricep Pushdown 3x12-15\n\n**GIORNO TIRAGGIO**\n‚Ä¢ Trazioni Assistite 3x8-12\n‚Ä¢ Rematore Manubri 3x10-12\n‚Ä¢ Face Pulls 3x12-15\n‚Ä¢ Bicep Curls 3x12-15\n\n**GIORNO GAMBE & CORE**\n‚Ä¢ Squat 3x10-12\n‚Ä¢ Leg Press 3x12-15\n‚Ä¢ Plank 3x30-60 sec\n‚Ä¢ Russian Twists 3x15/side\n\nüé® **ESTETICA & FORMA:**\n‚Ä¢ Focus su upper chest per d√©collet√©\n‚Ä¢ Esercizi unilaterali per simmetria\n‚Ä¢ Combinazione cardio per definizione\n‚Ä¢ Postura corretta per presentazione\n\nÔøΩ **RECUPERO DELICATO:**\n‚Ä¢ Yoga e pilates integrati\n‚Ä¢ Massaggi linfodrenanti\n‚Ä¢ Alimentazione anti-infiammatoria\n‚Ä¢ Sonno qualit√† 7-9 ore\n\n‚ú® **RISULTATI DONNA MODERNA:**\n‚Ä¢ Forza funzionale aumentata\n‚Ä¢ Corpo tonico e proporzionato\n‚Ä¢ Energia quotidiana migliorata\n‚Ä¢ Fiducia personale potenziata\n\nüëë **SII LA TUA VERSIONE MIGLIORE!**",
                    "üî¨ **Ricerca Scientifica Pettorali 2025 - Protocollo Evidence-Based:**\n\n\nüìö **STUDI RIVOLUZIONARI:**\n‚Ä¢ Meta-analisi Journal Strength & Conditioning: range 6-12 reps ottimale\n‚Ä¢ Ricerca EMG: attivazione massima a 45¬∞ elbow angle\n‚Ä¢ Studi longitudinali: guadagno 0.25-0.5% forza/settimana\n\n\n‚öóÔ∏è **PROTOCOLLO SPERIMENTALE:**\n\n**SETTIMANA 1-4: ADATTAMENTO**\n‚Ä¢ Panca Piana 3x12 @ 60% 1RM\n‚Ä¢ Panca Inclinata 3x12 @ 55% 1RM\n‚Ä¢ Croci 3x15\n‚Ä¢ Push-ups 3x max\n\n**SETTIMANA 5-8: PROGRESSIONE**\n‚Ä¢ Panca Piana 4x10 @ 65% 1RM\n‚Ä¢ Panca Inclinata 4x10 @ 60% 1RM\n‚Ä¢ Croci 4x12\n‚Ä¢ Dips 3x10\n\n**SETTIMANA 9-12: INTENSIFICAZIONE**\n‚Ä¢ Panca Piana 4x8 @ 70% 1RM\n‚Ä¢ Panca Inclinata 4x8 @ 65% 1RM\n‚Ä¢ Croci 4x10\n‚Ä¢ Military Press 3x10\n\n**SETTIMANA 13-16: PEAK**\n‚Ä¢ Panca Piana 5x5 @ 75% 1RM\n‚Ä¢ Panca Inclinata 5x5 @ 70% 1RM\n‚Ä¢ Croci 4x8\n‚Ä¢ Dips 4x8\n\nüìä **TRACKING SCIENTIFICO:**\n‚Ä¢ Misurazioni antropometriche\n‚Ä¢ Test forza periodici\n‚Ä¢ Analisi composizione corporea\n‚Ä¢ Questionari qualit√† vita\n\nüß™ **VARIABILI CONTROLLATE:**\n‚Ä¢ Alimentazione standardizzata\n‚Ä¢ Sonno monitorato\n‚Ä¢ Stress valutato\n‚Ä¢ Recupero quantificato\n\nüéØ **CONCLUSIONI:**\n‚Ä¢ Progressione lineare efficace\n‚Ä¢ Combinazione esercizi ottimale\n‚Ä¢ Recupero critico per risultati\n‚Ä¢ Consistenza chiave successo\n\nüî¨ **LA SCIENZA FUNZIONA!**"
                ];
                return {
                    text: chestResponses[Math.floor(Math.random() * chestResponses.length)]
                };
            }
            
            if (message.includes('schiena') || message.includes('dorso') || message.includes('back') || message.includes('schienale')) {
                const backResponses = [
                    "üèÜ **Sistema Schiena Elite - Protocollo da Bodybuilder Professionista:**\n\n\nüî¨ **SCIENZA DELLA SCHIENA:** La schiena √® composta da 3 strati muscolari (superficiali, intermedi, profondi) che richiedono stimoli specifici per sviluppo 3D completo.\n\n\nüí™ **PROGRAMMAZIONE COMPETITION-READY - 4 Giorni/Settimana:**\n\n**GIORNO 1: LATS & UPPER BACK (VERTICAL PULL)**\n‚Ä¢ Trazioni alla Sbarra 4x6-10 (BW o weighted) - King of back exercises\n‚Ä¢ Lat Pulldown 4x10-12 - Machine alternative\n‚Ä¢ Face Pulls 3x15-20 - Rear delt & upper back\n‚Ä¢ Straight-Arm Pulldown 3x12-15 - Lats isolation\n\n**GIORNO 2: THICKNESS & POSTERIOR CHAIN**\n‚Ä¢ Rematore Bilanciere 4x8-10 (75-80% 1RM) - Thickness builder\n‚Ä¢ Rematore Manubri 4x10-12 - Unilateral focus\n‚Ä¢ Stacco Rumeno 4x8-10 - Posterior chain\n‚Ä¢ Shrugs 3x12-15 - Upper traps\n\n**GIORNO 3: WIDTH & DETAIL WORK**\n‚Ä¢ Lat Pulldown Wide Grip 4x12-15 - Width emphasis\n‚Ä¢ Seated Cable Row 4x10-12 - Controlled power\n‚Ä¢ T-Bar Row 3x10-12 - Old school mass builder\n‚Ä¢ Rear Delt Flyes 3x15 - Balanced development\n\n**GIORNO 4: STRENGTH & POWER**\n‚Ä¢ Deadlift 5x3 (80-85% 1RM) - Full posterior chain dominance\n‚Ä¢ Pull-ups Weighted 4x6-8 - Strength focus\n‚Ä¢ Good Mornings 3x10-12 - Hamstring & back\n‚Ä¢ Farmer Walk 3x40m - Grip & core\n\nüî• **NUTRIZIONE BACK-BUILDING:**\n‚Ä¢ Proteina 2.2-2.5g/kg per sintesi muscolare elevata\n‚Ä¢ Carb-loading pre-workout per energia lattes\n‚Ä¢ Glutammina 5g post-workout per recupero\n‚Ä¢ Omega-3 per salute articolare\n\n‚ö° **SUPPLEMENTI SPECIALIZZATI:**\n‚Ä¢ Creatina per forza esplosiva\n‚Ä¢ Beta-Alanine per endurance\n‚Ä¢ BCAAs intra-workout\n‚Ä¢ ZMA per recupero testosterone\n\nüéØ **TRACKING PROGRESSI:**\n‚Ä¢ Misura circonferenza schiena ogni mese\n‚Ä¢ Foto progress da lati diversi\n‚Ä¢ Test forza deadlift ogni 6 settimane\n‚Ä¢ Monitoraggio mobilit√† spalla\n\nüí° **TECNICHE PRO:**\n‚Ä¢ Mind-muscle connection enfatizzata\n‚Ä¢ Stretch-mediated activation\n‚Ä¢ Drop sets per failure training\n‚Ä¢ Rest-pause per intensit√†\n\n‚ö†Ô∏è **PREVENZIONE INFORTUNI:**\n‚Ä¢ Warm-up con cat-cow stretch\n‚Ä¢ Form check video settimanale\n‚Ä¢ Evita shrugging nelle trazioni\n‚Ä¢ Monitora dolore spalla\n\nüöÄ **RISULTATI ATTESI:** Schiena pi√π larga del 20-30% in 16 settimane con costanza!",
                    "üèãÔ∏è‚Äç‚ôÇÔ∏è **Protocollo Schiena Olimpico - Metodo Powerlifting & Bodybuilding:**\n\n\nüìä **RICERCA MUSCOLARE:** Studi dimostrano che esercizi composti + isolamento producono 40% pi√π ipertrofia rispetto a composti soli.\n\n\nüéØ **PROGRAMMA PERIODIZZATO:**\n\n**FASE 1: STRENGTH FOUNDATION (8 settimane)**\n‚Ä¢ Deadlift: 4x6-8 @ 75-80% 1RM\n‚Ä¢ Pull-ups: 4x8-10 BW\n‚Ä¢ Bent-over Row: 4x8-10\n‚Ä¢ Lat Pulldown: 3x10-12\n\n**FASE 2: HYPERTROPHY SPECIALIZATION (6 settimane)**\n‚Ä¢ Pull-ups: 3x10-12 weighted\n‚Ä¢ Seated Cable Row: 4x10-12\n‚Ä¢ T-Bar Row: 4x10-12\n‚Ä¢ Face Pulls: 3x15-20\n\n**FASE 3: STRENGTH PEAK (4 settimane)**\n‚Ä¢ Deadlift: 5x3 @ 85% 1RM\n‚Ä¢ Weighted Pull-ups: 5x5\n‚Ä¢ Bent-over Row: 5x5\n‚Ä¢ Good Mornings: 4x8-10\n\n**FASE 4: PEAK & DELoad (4 settimane)**\n‚Ä¢ Light Deadlift: 3x8 @ 60% 1RM\n‚Ä¢ Pull-ups: 3x12 BW\n‚Ä¢ Cable Work: 3x15\n‚Ä¢ Mobility Work\n\nüî¨ **BIOMECCANICA OTTIMALE:**\n‚Ä¢ Scapole retratte durante pull\n‚Ä¢ Core braced rigid\n‚Ä¢ Hinge da anche, non schiena\n‚Ä¢ Respirazione coordinata\n\nüõ°Ô∏è **PROTOCOLLO SICUREZZA:**\n‚Ä¢ Assessment mobilit√† pre-sessione\n‚Ä¢ Attivazione cuffia rotatoria\n‚Ä¢ Correzione posture disallineate\n‚Ä¢ Monitoraggio DOMS\n\nüíä **RECUPERO STRATEGICO:**\n‚Ä¢ Foam rolling schiena post-workout\n‚Ä¢ Stretching dinamico e statico\n‚Ä¢ Ice bath per riduzione infiammazione\n‚Ä¢ Massaggio sportivo settimanale\n\nüìà **METRICHE SUCCESSO:**\n‚Ä¢ Deadlift +30-40kg/trimestre\n‚Ä¢ Pull-ups +5-8 reps BW\n‚Ä¢ Miglioramento composizione corporea\n‚Ä¢ Riduzione asimmetrie\n\nüéñÔ∏è **MENTALIT√Ä VINCENTE:**\n‚Ä¢ Back day √® sacro\n‚Ä¢ Quality over quantity\n‚Ä¢ Patience con progressione\n‚Ä¢ Celebrate ogni PR\n\nüèÜ **SCHIENA CHE COMANDA RISPETTO!**",
                    "üåü **Sistema Schiena Funzionale - Performance Athletica Completa:**\n\n\nüî• **FILOSOFIA ALLENAMENTO:** Schiena forte = atleta completo. Combiniamo estetica con funzionalit√† reale.\n\n\nüèóÔ∏è **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: VERTICAL PULL PRIORITY**\n‚Ä¢ Pull-ups 5x3-8 - Strength foundation\n‚Ä¢ Lat Pulldown 4x10-12 - Width builder\n‚Ä¢ Face Pulls 4x15-20 - Posteriore chain\n‚Ä¢ Straight-Arm Pulldown 3x12-15\n\n**SESSIONE B: HORIZONTAL PULL POWER**\n‚Ä¢ Bent-over Row 5x5 @ 80% 1RM - Power focus\n‚Ä¢ Seated Cable Row 4x10-12 - Controlled strength\n‚Ä¢ T-Bar Row 4x10-12 - Mass builder\n‚Ä¢ Rear Delt Flyes 3x15\n\n**SESSIONE C: POSTERIOR CHAIN INTEGRATION**\n‚Ä¢ Deadlift 4x6-8 - Full chain activation\n‚Ä¢ Romanian Deadlift 4x8-10 - Hamstring focus\n‚Ä¢ Good Mornings 3x10-12 - Stability\n‚Ä¢ Farmer Walk 3x40m\n\n**SESSIONE D: EXPLOSIVE & SPEED**\n‚Ä¢ Speed Pull-ups 4x6 @ 70% max\n‚Ä¢ Medicine Ball Slams 3x10 - Power development\n‚Ä¢ Battle Ropes 3x30s - Conditioning\n‚Ä¢ Plyometric Push-ups 3x8\n\n‚ö° **INTENSIT√Ä PROGRESSIVA:**\n‚Ä¢ RPE 8-9 per crescita ottimale\n‚Ä¢ Tempo sotto tensione 50-70 secondi\n‚Ä¢ Tecniche avanzate: clusters, eccentrics\n‚Ä¢ Supersets per densit√†\n\nüß¨ **NUTRIZIONE PERFORMANCE:**\n‚Ä¢ Peri-workout nutrition timing\n‚Ä¢ Carb cycling per energia\n‚Ä¢ Protein spread throughout day\n‚Ä¢ Hydration optimization\n\nüîß **STRUMENTAZIONE:**\n‚Ä¢ Force plates per power metrics\n‚Ä¢ EMG per attivazione muscolare\n‚Ä¢ Video analisi biomeccanica\n‚Ä¢ Recovery tracking devices\n\nüõ°Ô∏è **RISK MANAGEMENT:**\n‚Ä¢ Pre-hab protocolli completi\n‚Ä¢ Load monitoring sistematico\n‚Ä¢ Injury prevention screening\n‚Ä¢ Psychological readiness\n\nüéØ **OBIETTIVI MISURABILI:**\n‚Ä¢ Strength gains 20-30%\n‚Ä¢ Power output aumentato\n‚Ä¢ Injury-free performance\n‚Ä¢ Body composition migliorata\n\nüíé **PSICOLOGIA PEAK:**\n‚Ä¢ Mental toughness training\n‚Ä¢ Visualization techniques\n‚Ä¢ Accountability systems\n‚Ä¢ Success celebration\n\nüèÖ **SCHIENA CHE VINCE COMPETIZIONI!**",
                    "üèãÔ∏è‚Äç‚ôÄÔ∏è **Schiena Femminile Armoniosa - Forza & Grazia Posturale:**\n\n\nüíñ **APPROCCIO OLISTICO:** Per le donne, schiena forte significa postura elegante e salute duratura.\n\n\nüå∏ **PROGRAMMA 3 GIORNI/SETTIMANA:**\n\n**GIORNO PULL A**\n‚Ä¢ Lat Pulldown 3x12-15\n‚Ä¢ Seated Cable Row 3x10-12\n‚Ä¢ Face Pulls 3x15-20\n‚Ä¢ Rear Delt Flyes 3x12-15\n\n**GIORNO PULL B**\n‚Ä¢ Assisted Pull-ups 3x8-12\n‚Ä¢ Bent-over Row Light 3x12-15\n‚Ä¢ Straight-Arm Pulldown 3x12-15\n‚Ä¢ Shrugs 3x15\n\n**GIORNO FULL BODY**\n‚Ä¢ Deadlift Light 3x8-10\n‚Ä¢ Good Mornings 3x10-12\n‚Ä¢ Plank Variations 3x30-60s\n‚Ä¢ Core Work 3x20\n\nüé® **ESTETICA & FORMA:**\n‚Ä¢ Focus su V-taper armonioso\n‚Ä¢ Postura migliorata visibile\n‚Ä¢ Tonificazione senza bulk eccessivo\n‚Ä¢ Equilibrio muscolare\n\nüåø **RECUPERO DELICATO:**\n‚Ä¢ Yoga per schiena\n‚Ä¢ Stretching profondo\n‚Ä¢ Massaggi decontratturanti\n‚Ä¢ Sonno ristoratore\n\n‚ú® **RISULTATI:**\n‚Ä¢ Schiena pi√π dritta e forte\n‚Ä¢ Miglioramento postura quotidiana\n‚Ä¢ Energia aumentata\n‚Ä¢ Sicurezza personale\n\nüëë **ILLUMINA LA TUA FORZA INTERIORE!**",
                    "üî¨ **Ricerca Schiena 2025 - Protocollo Evidence-Based:**\n\n\nüìö **STUDI RIVOLUZIONARI:**\n‚Ä¢ Meta-analysis: esercizi multi-articolari superiori per hypertrophy\n‚Ä¢ EMG research: pull-ups attivano 100% dorsali\n‚Ä¢ Longitudinal studies: strength gains 0.7-1%/week optimal\n\n\n‚öóÔ∏è **PROTOCOLLO SPERIMENTALE:**\n\n**WEEK 1-4: ADAPTATION**\n‚Ä¢ Lat Pulldown 3x12 @ 60% 1RM\n‚Ä¢ Seated Cable Row 3x12\n‚Ä¢ Face Pulls 3x20\n‚Ä¢ Assisted Pull-ups 3x10\n\n**WEEK 5-8: PROGRESSION**\n‚Ä¢ Pull-ups 4x8 BW\n‚Ä¢ Bent-over Row 4x10 @ 65% 1RM\n‚Ä¢ T-Bar Row 4x10\n‚Ä¢ Rear Delt Flyes 3x15\n\n**WEEK 9-12: INTENSIFICATION**\n‚Ä¢ Weighted Pull-ups 4x6\n‚Ä¢ Deadlift 4x8 @ 70% 1RM\n‚Ä¢ Cable Row 4x8\n‚Ä¢ Good Mornings 3x10\n\n**WEEK 13-16: PEAK**\n‚Ä¢ Deadlift 5x3 @ 80% 1RM\n‚Ä¢ Pull-ups 5x5 weighted\n‚Ä¢ Bent-over Row 5x5\n‚Ä¢ Face Pulls 4x12\n\nüìä **TRACKING SCIENTIFICO:**\n‚Ä¢ Anthropometric measurements\n‚Ä¢ Strength testing periodico\n‚Ä¢ DEXA body composition\n‚Ä¢ Quality of life assessment\n\nüß™ **CONTROLLED VARIABLES:**\n‚Ä¢ Standardized nutrition\n‚Ä¢ Sleep monitoring\n‚Ä¢ Stress assessment\n‚Ä¢ Recovery quantification\n\nüéØ **CONCLUSIONS:**\n‚Ä¢ Compound lifts fondamentali\n‚Ä¢ Progressive overload essenziale\n‚Ä¢ Recovery non negoziabile\n‚Ä¢ Consistency chiave successo\n\nüî¨ **SCIENCE DRIVES GAINS!**"
                ];
                return {
                    text: backResponses[Math.floor(Math.random() * backResponses.length)]
                };
            }
            
            // Arms category
            if (message.includes('braccia') || message.includes('bicipiti') || message.includes('tricipiti') || message.includes('arms') || message.includes('biceps') || message.includes('triceps')) {
                const armResponses = [
                    "üí™ **Programma Braccia Efficace**\n\n**Allenamento 4 giorni/settimana:**\n\n**Giorno 1: Bicipiti**\n‚Ä¢ Curl bilanciere: 4x8-10\n‚Ä¢ Curl manubri: 3x10-12\n‚Ä¢ Hammer curls: 3x12\n\n**Giorno 2: Tricipiti**\n‚Ä¢ French press: 4x8-10\n‚Ä¢ Pushdown: 4x10-12\n‚Ä¢ Dips: 3x10-15\n\n**Giorno 3: Bicipiti + Volume**\n‚Ä¢ Preacher curls: 4x12\n‚Ä¢ Cable curls: 3x15\n‚Ä¢ Chin-ups: 3x8-12\n\n**Giorno 4: Tricipiti + Forza**\n‚Ä¢ Close-grip bench: 4x8-10\n‚Ä¢ Skull crushers: 4x10\n‚Ä¢ Kickbacks: 3x15\n\n**Consigli:** Riposo 48h tra sessioni, mangia proteina, usa tecnica perfetta!",
                    "üèãÔ∏è‚Äç‚ôÇÔ∏è **Braccia da Bodybuilder**\n\n**Focus su bicipiti e tricipiti bilanciati:**\n\n‚Ä¢ **Bicipiti:** Curl variati (bilanciere, manubri, hammer)\n‚Ä¢ **Tricipiti:** Estensioni e pushdown per definizione\n‚Ä¢ **Frequenza:** 4-5 giorni/settimana\n‚Ä¢ **Ripetizioni:** 8-15 per ipertrofia\n‚Ä¢ **Progressione:** Aumenta peso ogni 1-2 settimane\n\n**Errore comune:** Non allenare entrambi i capi del braccio!",
                    "üåü **Braccia Funzionali**\n\n**Per forza reale negli sport:**\n\n‚Ä¢ Curl bilanciere: 4x6-8 (forza base)\n‚Ä¢ Hammer curls: 3x10 (presa funzionale)\n‚Ä¢ Chin-ups: 4x6-8 (compound)\n‚Ä¢ Pushdown: 4x10 (velocit√†)\n‚Ä¢ Dips: 4x8-12 (corpo intero)\n\n**Vantaggio:** Braccia forti per ogni movimento sportivo!",
                    "üèãÔ∏è‚Äç‚ôÄÔ∏è **Braccia Toniche**\n\n**Per donne - forza elegante:**\n\n**3 giorni/settimana:**\n‚Ä¢ Curl manubri: 3x12-15\n‚Ä¢ Tricep kickbacks: 3x12-15\n‚Ä¢ Hammer curls: 3x12\n‚Ä¢ Pushdown: 3x12\n\n**Focus:** Tonificazione senza volume eccessivo, posture migliorata!",
                    "üî¨ **Braccia Evidence-Based**\n\n**Cosa funziona davvero:**\n‚Ä¢ Compound + isolamento = crescita ottimale\n‚Ä¢ Range 8-12 reps per massa\n‚Ä¢ Progressive overload essenziale\n‚Ä¢ Recupero 48-72 ore\n‚Ä¢ Proteina 2g/kg peso corporeo\n\n**Risultato:** Braccia pi√π grandi del 20% in 12 settimane!"
                ];
                return {
                    text: armResponses[Math.floor(Math.random() * armResponses.length)]
                };
            }
            
            // Cardio specific category
            if (message.includes('cardio') && !message.includes('scheda')) {
                const cardioResponses = [
                    "üèÉ‚Äç‚ôÇÔ∏è **Cardio Efficace**\n\n**4 giorni/settimana per risultati ottimali:**\n\n**Giorno 1: HIIT**\n‚Ä¢ Riscaldamento: 5 min\n‚Ä¢ Sprint 30s / Recupero 60s x 8-10\n‚Ä¢ Defaticamento: 5 min\n\n**Giorno 2: Endurance**\n‚Ä¢ Corsa continua 45-60 min @ 60-70% FC max\n\n**Giorno 3: Interval**\n‚Ä¢ 400m sprint / 2 min recupero x 6-8\n\n**Giorno 4: Cross-training**\n‚Ä¢ Nuoto o ciclismo 30-45 min\n\n**Consiglio:** Varia l'intensit√† per evitare plateau!",
                    "üèÉ‚Äç‚ôÄÔ∏è **Cardio Femminile**\n\n**Energia e benessere per donne:**\n\n**4 giorni/settimana:**\n‚Ä¢ Camminata veloce 45-60 min\n‚Ä¢ Dance cardio/Zumba 45 min\n‚Ä¢ Nuoto 30-45 min\n‚Ä¢ Yoga + cardio leggero 45 min\n\n**Benefici:** Migliora salute cardiovascolare, gestisce stress, aumenta energia!",
                    "üî¨ **Cardio Evidence-Based**\n\n**Cosa funziona per perdere grasso:**\n‚Ä¢ HIIT: 40% pi√π efficace steady-state\n‚Ä¢ Zone 2: ottimale per endurance\n‚Ä¢ Recovery: cruciale per adattamento\n\n**Programma:** HIIT 2-3x/settimana + attivit√† miste per evitare burnout!"
                ];
                return {
                    text: cardioResponses[Math.floor(Math.random() * cardioResponses.length)]
                };
            }
            
            // Weight loss specific category
            if (message.includes('perdere peso') || message.includes('dimagrire') || message.includes('weight loss') || message.includes('grasso')) {
                const weightLossResponses = [
                    "‚öñÔ∏è **Dimagrimento Efficace**\n\n**6 giorni/settimana per risultati sostenibili:**\n\n**Allenamento:**\n‚Ä¢ Giorni 1,3,5: Full body HIIT (45 min)\n‚Ä¢ Giorni 2,4,6: Cardio + core (30-45 min)\n‚Ä¢ Giorno 7: Active recovery\n\n**Alimentazione:**\n‚Ä¢ Deficit 300-500 kcal/giorno\n‚Ä¢ Proteina 1.8-2.2g/kg peso\n‚Ä¢ Carb cycling (giorni high/low)\n‚Ä¢ Acqua 3-4L/giorno\n\n**Risultato:** 0.5-1kg/grasso settimana in modo sostenibile!",
                    "ü•ó **Piano Alimentare Dimagrimento**\n\n**Struttura pasti giornaliera:**\n\n**Colazione (400-500 kcal):**\n‚Ä¢ Avena + frutta + yogurt greco\n‚Ä¢ Uova + verdure + pane integrale\n\n**Spuntino (200 kcal):**\n‚Ä¢ Frutta + mandorle\n‚Ä¢ Yogurt + miele\n\n**Pranzo (500-600 kcal):**\n‚Ä¢ Proteina magra + verdure + carb\n‚Ä¢ Pesce + quinoa + broccoli\n\n**Cena (400-500 kcal):**\n‚Ä¢ Proteina + verdure abbondanti\n‚Ä¢ Zuppa + insalata + pesce\n\n**Regole:** Mangia ogni 3-4 ore, non saltare colazione, bevi acqua prima dei pasti!",
                    "üî¨ **Dimagrimento Evidence-Based**\n\n**Cosa funziona davvero:**\n‚Ä¢ Deficit 500 kcal/day = 0.5kg/week\n‚Ä¢ Proteina 1.6g/kg preserva massa muscolare\n‚Ä¢ HIIT + resistance training ottimale\n‚Ä¢ Sonno cruciale per perdita grasso\n\n**Strategie chiave:** Track calorie, meal timing, habit formation, metabolism boost!"
                ];
                return {
                    text: weightLossResponses[Math.floor(Math.random() * weightLossResponses.length)]
                };
            }
            
            // Motivation and mindset category
            if (message.includes('motivazione') || message.includes('mentalit√†') || message.includes('discipline') || message.includes('costanza') || message.includes('motivation') || message.includes('mindset')) {
                const motivationResponses = [
                    "üî• **Mentalit√† Vincente**\n\n**Principali abitudini per il successo:**\n\n**1. Visualizzazione giornaliera**\n‚Ä¢ 10 min mattina: immagina il tuo corpo ideale\n‚Ä¢ Usa tutti i sensi\n\n**2. Goal setting SMART**\n‚Ä¢ Specific, Measurable, Achievable, Relevant, Time-bound\n\n**3. Abitudini**\n‚Ä¢ Inizia piccolo (5 min/giorno)\n‚Ä¢ 66 giorni per formare un'abitudine\n\n**4. Mindset shift**\n‚Ä¢ Da 'devo' a 'voglio'\n‚Ä¢ Focus su progresso\n\n**Ricorda:** Il 90% del successo √® mentale!",
                    "üèÜ **Disciplina Elite**\n\n**Routine campione giornaliera:**\n\n**5:00 - Sveglia**\n‚Ä¢ Meditazione/visualizzazione\n‚Ä¢ Allenamento mattutino\n\n**18:00 - Allenamento**\n‚Ä¢ Sessione principale\n‚Ä¢ Recupero nutrizionale\n\n**22:00 - Preparazione**\n‚Ä¢ Cena leggera\n‚Ä¢ Planning giorno successivo\n‚Ä¢ Lettura 30 min\n\n**Sistema 5 secondi:** Conta 5-4-3-2-1, vai! Non pensare, agisci.\n\n**Accountability:** Partner o app per tracking progresso!",
                    "üåü **Costanza nel Fitness**\n\n**La chiave del successo a lungo termine:**\n\n**Curva del successo:**\n1. Entusiasmo (prime 2 settimane)\n2. Realt√† (settimane 3-8) - Qui molti mollano\n3. Trasformazione (mesi 3-6)\n4. Mastery (6+ mesi)\n\n**Strategie anti-abbandono:**\n‚Ä¢ Ambiente motivazionale\n‚Ä¢ Gruppo fitness\n‚Ä¢ Reward system\n‚Ä¢ 80/20 rule (80% consistent, 20% flexible)\n\n**Quando cala la motivazione:** Ricorda perch√© hai iniziato, focus sui benefici attuali!\n\nLa costanza √® la differenza tra sogni e risultati!",
                ];
                return {
                    text: motivationResponses[Math.floor(Math.random() * motivationResponses.length)]
                };
            }
            
            if (message.includes('squat') && message.includes('tecnica')) {
                return {
                    text: "Ecco i punti chiave per un squat perfetto:\n\n\nüéØ **Setup**:\n‚Ä¢ Piedi larghezza spalle, punte leggermente aperte\n‚Ä¢ Bilanciere sui trapezi, non sul collo\n‚Ä¢ Core attivato, petto in fuori\n\n\nüéØ **Esecuzione**:\n‚Ä¢ Inizia spingendo i fianchi indietro\n‚Ä¢ Scendi fino a quando le cosce sono parallele\n‚Ä¢ Ginocchia in linea con le punte dei piedi\n‚Ä¢ Risali spingendo attraverso i talloni\n\n\n‚ö†Ô∏è **Errori comuni da evitare**:\n‚Ä¢ Ginocchia che cedono verso l'interno\n‚Ä¢ Schiena che si incurva\n‚Ä¢ Non scendere abbastanza\n‚Ä¢ Peso sui talloni"
                };
            }
            
            // Exercise execution instructions
            if (message.includes('panca piana') || message.includes('bench press')) {
                return {
                    text: "Ecco come eseguire correttamente la Panca Piana:\n\n\nüéØ **Setup**:\n‚Ä¢ Sdraiati sulla panca con i piedi ben piantati\n‚Ä¢ Impugna il bilanciere con presa leggermente pi√π larga delle spalle\n‚Ä¢ Archi leggermente la schiena, spalle indietro\n\n\nüéØ **Esecuzione**:\n‚Ä¢ Abbassa il bilanciere controllatamente fino al petto\n‚Ä¢ Tocca il petto senza rimbalzare\n‚Ä¢ Spingi verso l'alto esplosivamente\n‚Ä¢ Blocca le braccia in alto senza iperestendere\n\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Non abbassare abbastanza il bilanciere\n‚Ä¢ Rimbalzare sul petto\n‚Ä¢ Sollevare i glutei dalla panca\n‚Ä¢ Non controllare la discesa"
                };
            }
            
            if (message.includes('trazioni') || message.includes('pull-ups')) {
                return {
                    text: "Guida completa alle Trazioni alla Sbarra:\n\n\nüéØ **Setup**:\n‚Ä¢ Impugna la sbarra con presa prona (palmi in avanti)\n‚Ä¢ Braccia completamente estese, spalle rilassate\n‚Ä¢ Piedi uniti o leggermente divaricati\n\n\nüéØ **Esecuzione**:\n‚Ä¢ Tira il corpo verso l'alto fino a quando il mento supera la sbarra\n‚Ä¢ Abbassa controllatamente fino alle braccia tese\n‚Ä¢ Mantieni il core contratto\n‚Ä¢ Respira regolarmente\n\n\nüí° **Varianti**:\n‚Ä¢ **Assisted**: Usa bande elastiche o macchina\n‚Ä¢ **Negative**: Scendi lentamente, sali con aiuto\n‚Ä¢ **Chin-ups**: Palmi verso di te per coinvolgere pi√π bicipiti\n\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Usare slancio (kipping)\n‚Ä¢ Non completare il movimento\n‚Ä¢ Oscillare il corpo"
                };
            }
            
            if (message.includes('squat') && !message.includes('tecnica')) {
                return {
                    text: "Lo Squat √® uno dei fondamentali esercizi per le gambe. Ecco come eseguirlo:\n\nüéØ **Setup**:\n‚Ä¢ Piedi larghezza spalle, punte leggermente aperte\n‚Ä¢ Bilanciere sui trapezi posteriori\n‚Ä¢ Guarda avanti, petto in fuori\n\nüéØ **Esecuzione**:\n‚Ä¢ Inizia piegando anche e ginocchia contemporaneamente\n‚Ä¢ Scendi fino a cosce parallele al suolo\n‚Ä¢ Risali spingendo attraverso i talloni\n‚Ä¢ Estendi completamente anche e ginocchia\n\nüí° **Varianti**:\n‚Ä¢ **Front Squat**: Bilanciere sulle spalle anteriori\n‚Ä¢ **Goblet Squat**: Manubrio al petto\n‚Ä¢ **Bulgarian Split Squat**: Una gamba elevata\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Ginocchia che collassano verso l'interno\n‚Ä¢ Schiena che si incurva\n‚Ä¢ Peso spostato sulle punte"
                };
            }
            
            if (message.includes('military press') || message.includes('shoulder press')) {
                return {
                    text: "Il Military Press per spalle potenti:\n\nüéØ **Setup**:\n‚Ä¢ Siediti o stai in piedi con bilanciere al petto\n‚Ä¢ Mani larghezza spalle, palmi in avanti\n‚Ä¢ Gomiti sotto il bilanciere\n\nüéØ **Esecuzione**:\n‚Ä¢ Spingi il bilanciere verso l'alto\n‚Ä¢ Estendi completamente le braccia\n‚Ä¢ Abbassa controllatamente al petto\n‚Ä¢ Mantieni il core contratto\n\nüí° **Varianti**:\n‚Ä¢ **Dumbbell Press**: Con manubri per maggiore range\n‚Ä¢ **Arnold Press**: Rotazione durante il movimento\n‚Ä¢ **Seated**: Pi√π stabile per principianti\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Inarcare eccessivamente la schiena\n‚Ä¢ Usare slancio\n‚Ä¢ Non completare il lockout"
                };
            }
            
            if (message.includes('rematore') || message.includes('row')) {
                return {
                    text: "Il Rematore con Bilanciere per una schiena forte:\n\nüéØ **Setup**:\n‚Ä¢ Piedi larghezza spalle, ginocchia leggermente piegate\n‚Ä¢ Impugna il bilanciere con presa prona\n‚Ä¢ Schiena neutra, petto in fuori\n\nüéØ **Esecuzione**:\n‚Ä¢ Tira il bilanciere verso l'addome\n‚Ä¢ Contrai i dorsali, spingi indietro le spalle\n‚Ä¢ Abbassa controllatamente\n‚Ä¢ Mantieni la schiena dritta\n\nüí° **Varianti**:\n‚Ä¢ **Dumbbell Row**: Singolo braccio per focus unilaterale\n‚Ä¢ **Cable Row**: Macchina per tensione costante\n‚Ä¢ **T-Bar Row**: Per maggiore isolamento\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Usare slancio\n‚Ä¢ Arrotondare la schiena\n‚Ä¢ Non contrarre i dorsali"
                };
            }
            
            if (message.includes('panca inclinata') || message.includes('incline bench') || message.includes('petto inclinato')) {
                return {
                    text: "La Panca Inclinata per la parte superiore del petto:\n\nüéØ **Setup**:\n‚Ä¢ Inclina la panca a 30-45 gradi\n‚Ä¢ Sdraiati con i piedi ben piantati\n‚Ä¢ Impugna il bilanciere pi√π largo delle spalle\n\nüéØ **Esecuzione**:\n‚Ä¢ Abbassa il bilanciere al petto controllatamente\n‚Ä¢ Spingi verso l'alto esplosivamente\n‚Ä¢ Blocca le braccia senza iperestendere\n‚Ä¢ Mantieni le spalle indietro\n\nüí° **Benefici**:\n‚Ä¢ Sviluppa la parte clavicolare del petto\n‚Ä¢ Migliora la definizione superiore\n‚Ä¢ Complementa la panca piana tradizionale\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Inclinare troppo la panca\n‚Ä¢ Non controllare la discesa\n‚Ä¢ Sollevare i glutei"
                };
            }
            
            if (message.includes('spinte manubri') || message.includes('dumbbell press') || message.includes('petto manubri')) {
                return {
                    text: "Le Spinte con Manubri per un petto bilanciato:\n\nüéØ **Setup**:\n‚Ä¢ Sdraiati sulla panca con manubri al petto\n‚Ä¢ Palmi in avanti, gomiti a 45 gradi\n‚Ä¢ Piedi ben piantati a terra\n\nüéØ **Esecuzione**:\n‚Ä¢ Spingi i manubri verso l'alto simultaneamente\n‚Ä¢ Estendi le braccia senza bloccare\n‚Ä¢ Abbassa controllatamente fino al petto\n‚Ä¢ Mantieni il core contratto\n\nüí° **Vantaggi**:\n‚Ä¢ Maggiore range di movimento\n‚Ä¢ Bilancia eventuali asimmetrie\n‚Ä¢ Coinvolge stabilizzatori aggiuntivi\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Lasciare cadere i manubri\n‚Ä¢ Non controllare la discesa\n‚Ä¢ Usare slancio"
                };
            }
            
            if (message.includes('dips') || message.includes('parallele')) {
                return {
                    text: "I Dips per tricipiti e petto inferiore:\n\nüéØ **Setup**:\n‚Ä¢ Impugna le parallele con braccia tese\n‚Ä¢ Gambe incrociate dietro o estese\n‚Ä¢ Corpo leggermente inclinato in avanti\n\nüéØ **Esecuzione**:\n‚Ä¢ Abbassa il corpo piegando i gomiti\n‚Ä¢ Scendi fino a 90 gradi nei gomiti\n‚Ä¢ Spingi verso l'alto senza bloccare\n‚Ä¢ Mantieni le spalle basse\n\nüí° **Varianti**:\n‚Ä¢ **Chest Dips**: Inclinato in avanti per pi√π petto\n‚Ä¢ **Tricep Dips**: Corpo verticale per pi√π tricipiti\n‚Ä¢ **Assisted**: Usa bande elastiche\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Scendere troppo in basso\n‚Ä¢ Usare slancio\n‚Ä¢ Non controllare il movimento"
                };
            }
            
            if (message.includes('tricep pushdown') || message.includes('pushdown') || message.includes('tricipiti cavo')) {
                return {
                    text: "Il Tricep Pushdown per isolare i tricipiti:\n\nüéØ **Setup**:\n‚Ä¢ Impugna la corda o barra del cavo\n‚Ä¢ Gomiti fissi ai fianchi\n‚Ä¢ Palmi in avanti o neutri\n\nüéØ **Esecuzione**:\n‚Ä¢ Estendi le braccia verso il basso\n‚Ä¢ Contrai i tricipiti completamente\n‚Ä¢ Ritorna lentamente alla posizione iniziale\n‚Ä¢ Mantieni i gomiti immobili\n\nüí° **Varianti**:\n‚Ä¢ **Rope**: Per maggiore coinvolgimento\n‚Ä¢ **Straight Bar**: Per focus centrale\n‚Ä¢ **Reverse Grip**: Per diverso angolo\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Muovere i gomiti\n‚Ä¢ Usare slancio\n‚Ä¢ Non completare l'estensione"
                };
            }
            
            if (message.includes('lat machine') || message.includes('lat pulldown') || message.includes('tirate machine')) {
                return {
                    text: "La Lat Machine per una schiena ampia:\n\nüéØ **Setup**:\n‚Ä¢ Siediti con cosce sotto i supporti\n‚Ä¢ Impugna la barra con presa larga\n‚Ä¢ Schiena leggermente inclinata indietro\n\nüéØ **Esecuzione**:\n‚Ä¢ Tira la barra verso il petto\n‚Ä¢ Contrai i dorsali e le spalle indietro\n‚Ä¢ Abbassa controllatamente\n‚Ä¢ Mantieni il petto in fuori\n\nüí° **Varianti**:\n‚Ä¢ **Wide Grip**: Per larghezza\n‚Ä¢ **Narrow Grip**: Per spessore\n‚Ä¢ **Behind Neck**: Per maggiore range (cautela)\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Usare slancio\n‚Ä¢ Non contrarre i dorsali\n‚Ä¢ Arrotondare la schiena"
                };
            }
            
            if (message.includes('pulley') || message.includes('face pull') || message.includes('tirate faccia')) {
                return {
                    text: "Il Pulley (Face Pull) per spalle posteriori:\n\nüéØ **Setup**:\n‚Ä¢ Impugna la corda del cavo all'altezza del viso\n‚Ä¢ Fai un passo indietro per tensione\n‚Ä¢ Gomiti alti, paralleli al suolo\n\nüéØ **Esecuzione**:\n‚Ä¢ Tira la corda verso il viso\n‚Ä¢ Separa le mani ai lati della testa\n‚Ä¢ Contrai i posteriori delle spalle\n‚Ä¢ Ritorna controllatamente\n\nüí° **Benefici**:\n‚Ä¢ Migliora la postura\n‚Ä¢ Previene infortuni alle spalle\n‚Ä¢ Equilibra lo sviluppo deltoideo\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Usare troppo peso\n‚Ä¢ Non controllare il movimento\n‚Ä¢ Abbassare i gomiti"
                };
            }
            
            if (message.includes('curl bilanciere') || message.includes('barbell curl') || message.includes('bicipiti bilanciere')) {
                return {
                    text: "Il Curl con Bilanciere per bicipiti:\n\nüéØ **Setup**:\n‚Ä¢ Piedi larghezza spalle, bilanciere con presa supina\n‚Ä¢ Braccia tese lungo i fianchi\n‚Ä¢ Gomiti fissi ai fianchi\n\nüéØ **Esecuzione**:\n‚Ä¢ Fletti i gomiti portando il bilanciere alle spalle\n‚Ä¢ Contrai i bicipiti in alto\n‚Ä¢ Abbassa controllatamente\n‚Ä¢ Mantieni i gomiti immobili\n\nüí° **Varianti**:\n‚Ä¢ **EZ Bar**: Riduce stress sui polsi\n‚Ä¢ **Preacher Curl**: Per isolamento maggiore\n‚Ä¢ **Hammer Curl**: Con manubri, presa neutra\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Usare slancio\n‚Ä¢ Muovere i gomiti\n‚Ä¢ Non completare il movimento"
                };
            }
            
            if (message.includes('stacchi rumeni') || message.includes('romanian deadlift') || message.includes('stacco rumeno')) {
                return {
                    text: "Gli Stacchi Rumeni per hamstring e glutei:\n\nüéØ **Setup**:\n‚Ä¢ Piedi larghezza spalle, bilanciere davanti\n‚Ä¢ Presa prona, ginocchia leggermente piegate\n‚Ä¢ Schiena neutra, petto in fuori\n\nüéØ **Esecuzione**:\n‚Ä¢ Abbassa il bilanciere spingendo i glutei indietro\n‚Ä¢ Mantieni le gambe quasi tese\n‚Ä¢ Scendi fino a sentire tensione negli hamstring\n‚Ä¢ Risali contraendo i glutei\n\nüí° **Benefici**:\n‚Ä¢ Sviluppa catena posteriore\n‚Ä¢ Migliora mobilit√† dell'anca\n‚Ä¢ Complementa squat e stacchi\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Arrotondare la schiena\n‚Ä¢ Piegare troppo le ginocchia\n‚Ä¢ Non controllare la discesa"
                };
            }
            
            if (message.includes('leg press') || message.includes('pressa gambe')) {
                return {
                    text: "Il Leg Press per quadricipiti e glutei:\n\nüéØ **Setup**:\n‚Ä¢ Siediti con schiena appoggiata\n‚Ä¢ Piedi larghezza spalle sulla pedana\n‚Ä¢ Ginocchia a 90 gradi nella posizione iniziale\n\nüéØ **Esecuzione**:\n‚Ä¢ Estendi le gambe senza bloccare le ginocchia\n‚Ä¢ Abbassa controllatamente fino a 90 gradi\n‚Ä¢ Mantieni i piedi piatti\n‚Ä¢ Respira regolarmente\n\nüí° **Varianti**:\n‚Ä¢ **Wide Stance**: Pi√π glutei\n‚Ä¢ **Narrow Stance**: Pi√π quadricipiti\n‚Ä¢ **Single Leg**: Per correzione asimmetrie\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Rimuovere i glutei dal sedile\n‚Ä¢ Non controllare la discesa\n‚Ä¢ Piedi troppo in alto o basso"
                };
            }
            
            if (message.includes('leg extension') || message.includes('estensioni gambe')) {
                return {
                    text: "La Leg Extension per quadricipiti isolati:\n\nüéØ **Setup**:\n‚Ä¢ Siediti con schiena appoggiata\n‚Ä¢ Caviglie sotto i supporti\n‚Ä¢ Ginocchia a 90 gradi\n\nüéØ **Esecuzione**:\n‚Ä¢ Estendi le gambe completamente\n‚Ä¢ Contrai i quadricipiti in alto\n‚Ä¢ Abbassa controllatamente\n‚Ä¢ Mantieni il controllo\n\nüí° **Consigli**:\n‚Ä¢ Buon esercizio di isolamento\n‚Ä¢ Da fare dopo esercizi composti\n‚Ä¢ Non usare pesi troppo pesanti\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Usare slancio\n‚Ä¢ Non completare l'estensione\n‚Ä¢ Muovere il busto"
                };
            }
            
            if (message.includes('leg curl') || message.includes('curl gambe')) {
                return {
                    text: "Il Leg Curl per hamstring isolati:\n\nüéØ **Setup**:\n‚Ä¢ Sdraiati prono sulla macchina\n‚Ä¢ Caviglie sotto i supporti\n‚Ä¢ Anche rilassate\n\nüéØ **Esecuzione**:\n‚Ä¢ Fletti le ginocchia portando i talloni ai glutei\n‚Ä¢ Contrai gli hamstring\n‚Ä¢ Estendi controllatamente\n‚Ä¢ Mantieni il core contratto\n\nüí° **Varianti**:\n‚Ä¢ **Seated**: Seduto per focus diverso\n‚Ä¢ **Standing**: In piedi con cavo\n‚Ä¢ **Single Leg**: Per correzione squilibri\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Usare slancio\n‚Ä¢ Non controllare l'estensione\n‚Ä¢ Sollevare i glutei"
                };
            }
            
            if (message.includes('tapis roulant') || message.includes('treadmill') || message.includes('correre tapis')) {
                return {
                    text: "Il Tapis Roulant per cardio efficace:\n\nüéØ **Setup**:\n‚Ä¢ Scegli velocit√† e inclinazione appropriate\n‚Ä¢ Mantieni postura eretta\n‚Ä¢ Guarda avanti, non gi√π\n\nüéØ **Esecuzione**:\n‚Ä¢ Cammina/corri con ritmo costante\n‚Ä¢ Usa le braccia per bilanciamento\n‚Ä¢ Respira regolarmente\n‚Ä¢ Monitora frequenza cardiaca\n\nüí° **Benefici**:\n‚Ä¢ Migliora capacit√† cardiovascolare\n‚Ä¢ Brucia calorie efficacemente\n‚Ä¢ Adattabile a tutti i livelli\n\n‚ö†Ô∏è **Consigli di sicurezza**:\n‚Ä¢ Inizia con riscaldamento\n‚Ä¢ Non tenere i corrimano\n‚Ä¢ Idratati regolarmente"
                };
            }
            
            if (message.includes('cyclette') || message.includes('stationary bike') || message.includes('bici stazionaria')) {
                return {
                    text: "La Cyclette per cardio a basso impatto:\n\nüéØ **Setup**:\n‚Ä¢ Regola sella e manubrio\n‚Ä¢ Scegli resistenza appropriata\n‚Ä¢ Mantieni schiena dritta\n\nüéØ **Esecuzione**:\n‚Ä¢ Pedala con ritmo costante\n‚Ä¢ Mantieni core contratto\n‚Ä¢ Respira regolarmente\n‚Ä¢ Varia intensit√† se possibile\n\nüí° **Vantaggi**:\n‚Ä¢ Basso impatto sulle articolazioni\n‚Ä¢ Buono per riscaldamento\n‚Ä¢ Facilita conversazione (se leggero)\n\n‚ö†Ô∏è **Errori comuni**:\n‚Ä¢ Curvare la schiena\n‚Ä¢ Usare resistenza troppo alta\n‚Ä¢ Non scaldarsi prima"
                };
            }
            
            if (message.includes('ellittica') || message.includes('elliptical') || message.includes('ellittico')) {
                return {
                    text: "L'Ellittica per cardio completo:\n\nüéØ **Setup**:\n‚Ä¢ Regola pedali e manubri\n‚Ä¢ Scegli programma adatto\n‚Ä¢ Mantieni postura eretta\n\nüéØ **Esecuzione**:\n‚Ä¢ Muovi braccia e gambe simultaneamente\n‚Ä¢ Mantieni ritmo costante\n‚Ä¢ Respira regolarmente\n‚Ä¢ Monitora resistenza e velocit√†\n\nüí° **Benefici**:\n‚Ä¢ Movimento naturale\n‚Ä¢ Coinvolge tutto il corpo\n‚Ä¢ Basso impatto sulle articolazioni\n\n‚ö†Ô∏è **Consigli**:\n‚Ä¢ Non aggrapparti ai manubri\n‚Ä¢ Mantieni core attivo\n‚Ä¢ Varia intensit√† per risultati migliori"
                };
            }
            
            // Additional muscle group suggestions
            if (message.includes('braccia') || message.includes('arms') || message.includes('bicipiti') || message.includes('tricipiti')) {
                const armResponses = [
                    "Per sviluppare le braccia, combina esercizi composti e di isolamento:\n\nüí™ **Bicipiti**:\n‚Ä¢ Curl con Bilanciere\n‚Ä¢ Curl con Manubri\n‚Ä¢ Hammer Curl\n‚Ä¢ Trazioni (coinvolgono anche bicipiti)\n\nüí™ **Tricipiti**:\n‚Ä¢ Estensioni con Manubrio\n‚Ä¢ Push-down al Cavo\n‚Ä¢ Dips\n‚Ä¢ French Press\n\nüîÑ **Allenamento bilanciato**:\n‚Ä¢ 2-3 esercizi per gruppo muscolare\n‚Ä¢ 3-4 serie da 8-12 ripetizioni\n‚Ä¢ Riposo 60-90 secondi tra serie\n\nRicorda: le braccia crescono con esercizi pesanti e buona alimentazione!",
                    "Ecco esercizi eccellenti per braccia potenti:\n\nüèãÔ∏è **Biceps**:\n‚Ä¢ Barbell Curls\n‚Ä¢ Dumbbell Curls\n‚Ä¢ Concentration Curls\n‚Ä¢ Chin-ups\n\nüèãÔ∏è **Triceps**:\n‚Ä¢ Tricep Dips\n‚Ä¢ Skull Crushers\n‚Ä¢ Cable Pushdowns\n‚Ä¢ Close-grip Bench\n\nüí° **Pro tip**: Finisci con esercizi di isolamento per la pump massima!",
                    "Per braccia da urlo:\n\nüí• **Bicipiti**:\n‚Ä¢ EZ Bar Curls\n‚Ä¢ Preacher Curls\n‚Ä¢ Hammer Curls\n‚Ä¢ 21s (metodo avanzato)\n\nüí• **Tricipiti**:\n‚Ä¢ Overhead Extensions\n‚Ä¢ Kickbacks\n‚Ä¢ Rope Pushdowns\n‚Ä¢ Diamond Push-ups\n\nCombina volume e intensit√† per risultati esplosivi!"
                ];
                return {
                    text: armResponses[Math.floor(Math.random() * armResponses.length)]
                };
            }
            
            if (message.includes('gambe') || message.includes('legs') || message.includes('quadricipiti') || message.includes('cosce') || message.includes('gambe inferiori')) {
                const legResponses = [
                    "üèÜ **Sistema Gambe Olimpico - Protocollo da Powerlifter Elite:**\n\n\nüî¨ **SCIENZA DELLE GAMBE:** Le gambe rappresentano il 50% della massa muscolare totale. Richiedono stimoli pesanti e volume elevato per ipertrofia massima.\n\n\nüí™ **PROGRAMMAZIONE COMPETITION-READY - 4 Giorni/Settimana:**\n\n**GIORNO 1: SQUAT FOCUS (FORZA MASSIMALE)**\n‚Ä¢ Squat 5x3 (85-90% 1RM) - King of exercises\n‚Ä¢ Leg Press 4x10-12 - Accessory work\n‚Ä¢ Walking Lunges 3x12/leg - Unilateral balance\n‚Ä¢ Leg Extension 3x15 - Quad isolation\n\n**GIORNO 2: DEADLIFT SPECIALIZATION**\n‚Ä¢ Romanian Deadlift 4x8-10 (75-80% 1RM) - Hamstring focus\n‚Ä¢ Bulgarian Split Squat 4x10/leg - Single leg strength\n‚Ä¢ Leg Curl 4x12-15 - Hamstring isolation\n‚Ä¢ Calf Raises 4x15-20 - Posterior chain complete\n\n**GIORNO 3: VOLUME IPERTROFIA**\n‚Ä¢ Front Squat 4x10-12 - Quad emphasis\n‚Ä¢ Hack Squat 3x12-15 - Alternative angle\n‚Ä¢ Glute Bridge 3x15 - Glute activation\n‚Ä¢ Seated Calf Raise 3x20 - Calf burn\n\n**GIORNO 4: ACCESSORI AVANZATI**\n‚Ä¢ Box Squat 4x8-10 - Explosive power\n‚Ä¢ Nordic Hamstring Curl 3x8-12 - Eccentric strength\n‚Ä¢ Sissy Squat 3x12-15 - Quad stretch\n‚Ä¢ Farmer Walk 3x40m - Grip & core\n\nüî• **NUTRIZIONE POWERLIFTING:**\n‚Ä¢ 2.5-3.0g/kg proteina per sintesi muscolare\n‚Ä¢ Surplus 500-700 kcal per crescita\n‚Ä¢ Carb-loading 8-12g/kg pre-workout\n‚Ä¢ Creatina 5g/die per forza esplosiva\n\n‚ö° **SUPPLEMENTI ELITE:**\n‚Ä¢ Beta-Alanine per endurance\n‚Ä¢ Citrullina Malato per pomp\n‚Ä¢ BCAAs intra-workout\n‚Ä¢ ZMA per testosterone\n\nüéØ **TRACKING SCIENTIFICO:**\n‚Ä¢ Misura circonferenza cosce ogni 4 settimane\n‚Ä¢ Test forza (squat/deadlift) ogni 6-8 settimane\n‚Ä¢ Body composition tracking\n‚Ä¢ Performance metrics logging\n\nüí° **TECNICHE PRO:**\n‚Ä¢ Pause squats (3 secondi in basso)\n‚Ä¢ Deficit deadlifts per range aumentato\n‚Ä¢ Accommodating resistance (bands/chains)\n‚Ä¢ Westside Barbell conjugate method\n\n‚ö†Ô∏è **INFORTUNI PREVENZIONE:**\n‚Ä¢ Mobility work pre/post\n‚Ä¢ Corretta progressione carichi\n‚Ä¢ Form check video settimanale\n‚Ä¢ Deload ogni 6-8 settimane\n\nüöÄ **RISULTATI ATTESI:** +5-10cm cosce in 12-16 settimane con consistenza!",
                    "üèãÔ∏è‚Äç‚ôÇÔ∏è **Protocollo Gambe Scientifico - Metodo Evidence-Based:**\n\n\nüìä **RICERCA MUSCOLARE:** Studi dimostrano che gambe allenate 2x/settimana con volume 15-25 set producono ipertrofia ottimale.\n\n\nüéØ **PROGRAMMA PERIODIZZATO:**\n\n**FASE 1: STRENGTH BUILDING (8 settimane)**\n‚Ä¢ Squat: 4x6-8 @ 75-80% 1RM\n‚Ä¢ Deadlift: 4x6-8 @ 70-75% 1RM\n‚Ä¢ Leg Press: 3x10-12\n‚Ä¢ Lunges: 3x10/leg\n\n**FASE 2: HYPERTROPHY FOCUS (6 settimane)**\n‚Ä¢ Squat: 3x10-12 @ 65-70% 1RM\n‚Ä¢ Romanian DL: 3x10-12\n‚Ä¢ Bulgarian SS: 3x12/leg\n‚Ä¢ Leg Curl: 3x12-15\n\n**FASE 3: STRENGTH PEAK (4 settimane)**\n‚Ä¢ Squat: 5x3 @ 85% 1RM\n‚Ä¢ Deadlift: 5x3 @ 80% 1RM\n‚Ä¢ Front Squat: 4x6-8\n‚Ä¢ Good Mornings: 4x8-10\n\n**FASE 4: DELoad & RECOVERY (2 settimane)**\n‚Ä¢ Light Squat: 3x15 @ 50% 1RM\n‚Ä¢ Mobility Work: 3x10\n‚Ä¢ Core Work: 3x20\n‚Ä¢ Active Recovery\n\nüî¨ **BIOMECCANICA OTTIMALE:**\n‚Ä¢ Squat: piedi 140% larghezza spalle\n‚Ä¢ Deadlift: hinge da anche, non schiena\n‚Ä¢ Lunges: ginocchio anteriore non oltre punta piede\n‚Ä¢ Respirazione: brace durante movimento\n\nüõ°Ô∏è **PROTOCOLLO SICUREZZA:**\n‚Ä¢ Warm-up dinamico 10 minuti\n‚Ä¢ Form check con coach/video\n‚Ä¢ Progressione lineare 5-10% settimanale\n‚Ä¢ Monitoraggio DOMS e fatigue\n\nüíä **RECUPERO STRATEGICO:**\n‚Ä¢ Foam rolling gambe post-workout\n‚Ä¢ Stretching statico 5-10 minuti\n‚Ä¢ Ice bath 3x/settimana\n‚Ä¢ Massaggio sportivo mensile\n\nüìà **METRICHE SUCCESSO:**\n‚Ä¢ Squat 1RM +20-30kg/trimestre\n‚Ä¢ Cosce +3-5cm circonferenza\n‚Ä¢ Riduzione % grasso corporeo\n‚Ä¢ Miglioramento endurance cardiovascolare\n\nüéñÔ∏è **MENTALIT√Ä CAMPIONE:**\n‚Ä¢ Embrace the grind - gambe richiedono sacrificio\n‚Ä¢ Track ogni sessione meticolosamente\n‚Ä¢ Patience - risultati in 6-12 mesi\n‚Ä¢ Celebrate PRs e progressi\n\nüèÜ **GAMBE CHE SPOSTANO MONTAGNE!**",
                    "üåü **Sistema Gambe Funzionale - Performance Athletica:**\n\n\nüî• **FILOSOFIA ALLENAMENTO:** Gambe atletiche combinano forza, potenza, mobilit√†. Non solo estetica, ma performance reale.\n\n\nüèóÔ∏è **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: STRENGTH BASE**\n‚Ä¢ Back Squat 5x5 @ 80% 1RM\n‚Ä¢ Romanian Deadlift 4x8\n‚Ä¢ Bulgarian Split Squat 4x10/leg\n‚Ä¢ Calf Raises 3x15\n\n**SESSIONE B: POWER DEVELOPMENT**\n‚Ä¢ Box Jumps 4x5 - Explosive power\n‚Ä¢ Trap Bar Deadlift 4x6 - Alternative grip\n‚Ä¢ Reverse Lunges 4x10/leg\n‚Ä¢ Single Leg Calf Raise 3x12/leg\n\n**SESSIONE C: HYPERTROPHY VOLUME**\n‚Ä¢ Front Squat 3x10-12\n‚Ä¢ Lying Leg Curl 4x12-15\n‚Ä¢ Walking Lunges 3x12/leg\n‚Ä¢ Seated Calf Raise 4x20\n\n**SESSIONE D: SPEED & AGILITY**\n‚Ä¢ Speed Squats 4x8 @ 60% 1RM\n‚Ä¢ Kettlebell Swings 3x15\n‚Ä¢ Hill Sprints 6x30s\n‚Ä¢ Plyometric Lunges 3x8/leg\n\n‚ö° **INTENSIT√Ä PROGRESSIVA:**\n‚Ä¢ RPE 7-9 per crescita ottimale\n‚Ä¢ Tempo sotto tensione 60-90 secondi\n‚Ä¢ Tecniche avanzate: paused reps, eccentrics\n‚Ä¢ Cluster sets per qualit√†\n\nüß¨ **NUTRIZIONE PERFORMANCE:**\n‚Ä¢ Timing pasti intorno allenamenti\n‚Ä¢ Carb cycling per energia ottimale\n‚Ä¢ Elettroliti per crampi prevenzione\n‚Ä¢ Anti-infiammatori naturali\n\nüîß **STRUMENTAZIONE:**\n‚Ä¢ Force plates per power output\n‚Ä¢ Video analisi biomeccanica\n‚Ä¢ Wearable tech per recovery tracking\n‚Ä¢ Strength testing periodico\n\nüõ°Ô∏è **RISK MANAGEMENT:**\n‚Ä¢ Pre-hab protocolli\n‚Ä¢ Injury prevention screening\n‚Ä¢ Load monitoring\n‚Ä¢ Psychological readiness assessment\n\nüéØ **OBIETTIVI QUANTIFICABILI:**\n‚Ä¢ Vertical jump +5-10cm\n‚Ä¢ Sprint time miglioramento\n‚Ä¢ Strength gains 15-25%\n‚Ä¢ Injury-free training\n\nüíé **PSICOLOGIA ELITE:**\n‚Ä¢ Mental toughness development\n‚Ä¢ Visualization success\n‚Ä¢ Peer accountability\n‚Ä¢ Long-term vision\n\nüèÖ **GAMBE CHE VINCONO COMPETIZIONI!**",
                    "üèãÔ∏è‚Äç‚ôÄÔ∏è **Gambe Femminili Armoniose - Forza & Bellezza:**\n\n\nüíñ **APPROCCIO OLISTICO:** Per le donne, gambe toniche significano sicurezza e salute. Bilanciamento tra forza e forma femminile.\n\n\nüå∏ **PROGRAMMA 3 GIORNI/SETTIMANA:**\n\n**GIORNO LOWER BODY A**\n‚Ä¢ Goblet Squat 3x12-15\n‚Ä¢ Romanian Deadlift 3x10-12\n‚Ä¢ Bulgarian Split Squat 3x10/leg\n‚Ä¢ Calf Raises 3x15-20\n\n**GIORNO LOWER BODY B**\n‚Ä¢ Leg Press 3x12-15\n‚Ä¢ Walking Lunges 3x12/leg\n‚Ä¢ Leg Curl 3x12-15\n‚Ä¢ Glute Bridge 3x15-20\n\n**GIORNO FULL BODY**\n‚Ä¢ Front Squat 3x10-12\n‚Ä¢ Deadlift Light 3x8-10\n‚Ä¢ Step-ups 3x10/leg\n‚Ä¢ Plank 3x30-60s\n\nüé® **ESTETICA & FORMA:**\n‚Ä¢ Focus su proporzioni armoniche\n‚Ä¢ Glute activation per forma\n‚Ä¢ Cellulite reduction attraverso movimento\n‚Ä¢ Postura migliorata\n\nüåø **RECUPERO DELICATO:**\n‚Ä¢ Yoga per gambe\n‚Ä¢ Stretching profondo\n‚Ä¢ Massaggi drenanti\n‚Ä¢ Alimentazione detox\n\n‚ú® **RISULTATI DONNA MODERNA:**\n‚Ä¢ Gambe toniche e definite\n‚Ä¢ Maggiore energia quotidiana\n‚Ä¢ Miglior mobilit√† articolare\n‚Ä¢ Fiducia aumentata\n\nüëë **POTENZIA LA TUA FORZA INTERIORE!**",
                    "üî¨ **Ricerca Gambe 2025 - Protocollo Evidence-Based:**\n\n\nüìö **STUDI RIVOLUZIONARI:**\n‚Ä¢ Meta-analysis: compound movements superiori per hypertrophy\n‚Ä¢ EMG studies: squat attiva 80% quadricipiti\n‚Ä¢ Longitudinal research: strength gains 0.5-1%/week optimal\n\n\n‚öóÔ∏è **PROTOCOLLO SPERIMENTALE:**\n\n**WEEK 1-4: FOUNDATION**\n‚Ä¢ Squat 3x12 @ 60% 1RM\n‚Ä¢ Deadlift 3x10 @ 60% 1RM\n‚Ä¢ Leg Press 3x15\n‚Ä¢ Lunges 3x12/leg\n\n**WEEK 5-8: BUILDING**\n‚Ä¢ Squat 4x10 @ 65% 1RM\n‚Ä¢ Romanian DL 4x10\n‚Ä¢ Bulgarian SS 4x10/leg\n‚Ä¢ Leg Curl 3x12\n\n**WEEK 9-12: INTENSIFICATION**\n‚Ä¢ Squat 4x8 @ 70% 1RM\n‚Ä¢ Deadlift 4x8 @ 70% 1RM\n‚Ä¢ Front Squat 3x10\n‚Ä¢ Good Mornings 3x10\n\n**WEEK 13-16: PEAK**\n‚Ä¢ Squat 5x5 @ 75% 1RM\n‚Ä¢ Deadlift 5x5 @ 75% 1RM\n‚Ä¢ Box Squat 4x8\n‚Ä¢ Nordic Curl 3x8\n\nüìä **TRACKING SCIENTIFICO:**\n‚Ä¢ Anthropometric measurements\n‚Ä¢ Strength testing periodico\n‚Ä¢ Body composition DEXA scans\n‚Ä¢ Performance metrics\n\nüß™ **VARIABILI CONTROLLATE:**\n‚Ä¢ Caloric intake standardized\n‚Ä¢ Sleep duration monitored\n‚Ä¢ Training frequency controlled\n‚Ä¢ Recovery protocols uniform\n\nüéØ **CONCLUSIONI:**\n‚Ä¢ Progressive overload essenziale\n‚Ä¢ Compound lifts fondamentali\n‚Ä¢ Recovery non negoziabile\n‚Ä¢ Consistency vince sempre\n\nüî¨ **SCIENCE DRIVES RESULTS!**"
                ];
                return {
                    text: legResponses[Math.floor(Math.random() * legResponses.length)]
                };
            }
            
            if (message.includes('spalle') || message.includes('shoulders') || message.includes('deltoidi') || message.includes('spalle larghe')) {
                const shoulderResponses = [
                    "üèÜ **Protocollo Spalle Elite - Sistema 3D per Deltoidi Perfetti:**\n\n\nüî¨ **ANATOMIA DELTOIDI:** I deltoidi hanno 3 teste (anteriore, laterale, posteriore) che richiedono stimoli specifici per crescita equilibrata.\n\n\nüí™ **PROGRAMMAZIONE SCIENTIFICA - 4 Giorni/Settimana:**\n\n**GIORNO 1: ANTERIORE & LATERALE (PUSH)**\n‚Ä¢ Military Press 4x8-10 (75-80% 1RM) - King of shoulders\n‚Ä¢ Alzate Laterali Manubri 4x12-15 - Laterale focus\n‚Ä¢ Alzate Frontali Manubri 3x12-15 - Anteriore isolation\n‚Ä¢ Rear Delt Flyes 3x15 - Posteriore balance\n\n**GIORNO 2: POSTERIORE & STABILIT√Ä**\n‚Ä¢ Alzate Laterali Incline 4x12-15 - Laterale angle variation\n‚Ä¢ Face Pulls 4x15-20 - Posteriore & cuff\n‚Ä¢ Rear Delt Machine 3x12-15 - Isolation posteriore\n‚Ä¢ Lateral Raises Cable 3x15 - Constant tension\n\n**GIORNO 3: FORZA MASSIMALE**\n‚Ä¢ Military Press 5x5 (80-85% 1RM) - Strength focus\n‚Ä¢ Arnold Press 4x8-10 - Full range motion\n‚Ä¢ Upright Rows 3x10-12 - Traps integration\n‚Ä¢ Shrugs 4x12-15 - Upper traps\n\n**GIORNO 4: IPERTROFIA AVANZATA**\n‚Ä¢ Lateral Raises Drop Set 3x12-8 - Burn technique\n‚Ä¢ Front Raises Cable 3x15 - Anteriore burn\n‚Ä¢ Bent Over Raises 3x15 - Posteriore burn\n‚Ä¢ Shoulder Press Machine 3x12-15 - Controlled movement\n\nüî• **PROTOCOLLO NUTRIZIONALE SPALLE:**\n‚Ä¢ Proteina alta: 2.0-2.2g/kg peso corporeo\n‚Ä¢ Carb-loading pre-workout per energia\n‚Ä¢ Omega-3 per salute articolare\n‚Ä¢ Vitamina D per forza ossea\n\n‚ö° **SUPPLEMENTI SPECIALIZZATI:**\n‚Ä¢ Glutammina per recupero articolare\n‚Ä¢ Condroitina per cartilagine\n‚Ä¢ Magnesio per funzione muscolare\n‚Ä¢ Curcuma per riduzione infiammazione\n\nüéØ **TRACKING PROGRESSI:**\n‚Ä¢ Misura circonferenza spalle ogni mese\n‚Ä¢ Foto progress da lati diversi\n‚Ä¢ Test mobilit√† spalla regolare\n‚Ä¢ Monitoraggio dolore o disagio\n\nüí° **TECNICHE PRO:**\n‚Ä¢ Usa pause isometriche in posizioni contratte\n‚Ä¢ Varia velocit√† esecuzione (3-1-3 tempo)\n‚Ä¢ Incorpora pre-esaurimento\n‚Ä¢ Focus mentale sulla contrazione\n\n‚ö†Ô∏è **PREVENZIONE INFORTUNI:**\n‚Ä¢ Riscaldamento con arm circles\n‚Ä¢ Rotator cuff activation\n‚Ä¢ Evita lockout completo se instabile\n‚Ä¢ Monitora impingement signs\n\nüöÄ **RISULTATI ATTESI:** Spalle pi√π larghe del 15-25% in 12 settimane con costanza!",
                    "üèãÔ∏è‚Äç‚ôÇÔ∏è **Sistema Spalle Olimpico - Deltoidi da Statua Greca:**\n\n\nüìä **FISIOLOGIA AVANZATA:** Le spalle richiedono attenzione particolare alla cuffia rotatoria. Bilanciamento tra push/pull essenziale.\n\n\nüéØ **PROGRAMMA PERIODIZZATO:**\n\n**FASE 1: COSTRUZIONE BASE (6 settimane)**\n‚Ä¢ Military Press: 4x10-12 @ 65-70% 1RM\n‚Ä¢ Lateral Raises: 4x12-15\n‚Ä¢ Face Pulls: 3x15-20\n‚Ä¢ Front Raises: 3x12-15\n\n**FASE 2: SVILUPPO FORZA (4 settimane)**\n‚Ä¢ Military Press: 5x5 @ 75-80% 1RM\n‚Ä¢ Arnold Press: 4x8-10\n‚Ä¢ Upright Rows: 4x8-10\n‚Ä¢ Shrugs: 4x10-12\n\n**FASE 3: DEFINIZIONE (4 settimane)**\n‚Ä¢ Lateral Raises: 4x15-20\n‚Ä¢ Rear Delt Flyes: 4x15-20\n‚Ä¢ Cable Raises: 3x20\n‚Ä¢ Dumbbell Press: 3x12-15\n\nüî¨ **BIOMECCANICA PRECISIONE:**\n‚Ä¢ Scapole retratte durante press\n‚Ä¢ Controllo eccentrico enfatizzato\n‚Ä¢ Range motion completo ma sicuro\n‚Ä¢ Respirazione coordinata\n\nüõ°Ô∏è **PROTOCOLLO SICUREZZA:**\n‚Ä¢ Assessment mobilit√† pre-sessione\n‚Ä¢ Attivazione cuffia rotatoria\n‚Ä¢ Correzione posture disallineate\n‚Ä¢ Monitoraggio DOMS\n\nüíä **RECUPERO INTELLIGENTE:**\n‚Ä¢ Foam rolling spalle e upper back\n‚Ä¢ Stretching dinamico e statico\n‚Ä¢ Ice bath per riduzione infiammazione\n‚Ä¢ Massaggio sportivo settimanale\n\nüìà **METRICHE SUCCESSO:**\n‚Ä¢ Aumento forza 5-8% ogni mese\n‚Ä¢ Miglioramento mobilit√† articolare\n‚Ä¢ Riduzione asimmetrie\n‚Ä¢ Aumento circonferenza spalle\n\nüéñÔ∏è **MENTALIT√Ä VINCENTE:**\n‚Ä¢ Visualizzazione crescita muscolare\n‚Ä¢ Pazienza con progressione graduale\n‚Ä¢ Focus qualit√† esecuzione\n‚Ä¢ Celebrazione miglioramenti\n\nüèÜ **SPALLE LEGGENDARIE IN ARRIVO!**",
                    "üåü **Protocollo Spalle Funzionale - Performance & Estetica:**\n\n\nüî• **FILOSOFIA ALLENAMENTO:** Spalle forti = corpo impressionante. Combiniamo estetica con funzionalit√† atletica.\n\n\nüèóÔ∏è **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: PRESS PRIORITY**\n‚Ä¢ Military Press 5x3 @ 80-85% 1RM\n‚Ä¢ Arnold Press 4x8-10\n‚Ä¢ Lateral Raises 4x10-12\n‚Ä¢ Face Pulls 3x15-20\n\n**SESSIONE B: RAISE SPECIALIZATION**\n‚Ä¢ Lateral Raises Cable 4x12-15\n‚Ä¢ Front Raises Cable 4x12-15\n‚Ä¢ Rear Delt Machine 4x12-15\n‚Ä¢ Shrugs Dumbbell 3x15\n\n**SESSIONE C: FULL SPECTRUM**\n‚Ä¢ Shoulder Press Machine 3x12-15\n‚Ä¢ Dumbbell Raises Mix 3x10-12\n‚Ä¢ Upright Rows 3x10-12\n‚Ä¢ Rotator Cuff Work 3x15\n\n‚ö° **INTENSIT√Ä PROGRESSIVA:**\n‚Ä¢ RPE 7-9 per crescita ottimale\n‚Ä¢ Tempo sotto tensione 45-60 secondi\n‚Ä¢ Tecniche avanzate: rest-pause, dropsets\n‚Ä¢ Supersets per densit√† aumentata\n\nüß¨ **NUTRIZIONE PRECISIONE:**\n‚Ä¢ Finestra anabolica post-workout\n‚Ä¢ Macro balance ottimale\n‚Ä¢ Timing pasti strategico\n‚Ä¢ Idratazione articolare\n\nüîß **STRUMENTAZIONE:**\n‚Ä¢ Video analisi tecnica\n‚Ä¢ EMG feedback attivazione\n‚Ä¢ Tracking forza progressione\n‚Ä¢ Monitoraggio mobilit√†\n\nüõ°Ô∏è **RISK MANAGEMENT:**\n‚Ä¢ Pre-hab esercizi preventivi\n‚Ä¢ Correzione disfunzioni\n‚Ä¢ Monitoraggio overtraining\n‚Ä¢ Protocollo recupero\n\nüéØ **OBIETTIVI MISURABILI:**\n‚Ä¢ Guadagno forza 10-15%/ciclo\n‚Ä¢ Aumento dimensione 1-2cm/mese\n‚Ä¢ Miglioramento stabilit√†\n‚Ä¢ Riduzione infortuni\n\nüíé **PSICOLOGIA PEAK:**\n‚Ä¢ Mental rehearsal\n‚Ä¢ Goal setting specifico\n‚Ä¢ Accountability\n‚Ä¢ Success celebration\n\nüèÖ **SPALLE CHE COMANDANO RISPETTO!**",
                    "üèãÔ∏è‚Äç‚ôÄÔ∏è **Spalle Femminili Armoniose - Forza & Grazia:**\n\n\nüíñ **APPROCCIO BILANCIATO:** Per le donne, le spalle devono essere toniche ma proporzionate. Forza funzionale con estetica.\n\n\nüå∏ **PROGRAMMA 3 GIORNI:**\n\n**GIORNO PUSH**\n‚Ä¢ Shoulder Press Dumbbell 3x10-12\n‚Ä¢ Lateral Raises 3x12-15\n‚Ä¢ Front Raises 3x12-15\n‚Ä¢ Tricep Extensions 3x12-15\n\n**GIORNO PULL**\n‚Ä¢ Face Pulls 3x15-20\n‚Ä¢ Rear Delt Flyes 3x12-15\n‚Ä¢ Rows 3x10-12\n‚Ä¢ Bicep Curls 3x12-15\n\n**GIORNO FULL BODY**\n‚Ä¢ Squat Variations 3x10-12\n‚Ä¢ Deadlift Light 3x8-10\n‚Ä¢ Plank Variations 3x30-60s\n‚Ä¢ Cardio HIIT 20 min\n\nüé® **ESTETICA & FORMA:**\n‚Ä¢ Focus su proporzioni armoniose\n‚Ä¢ Esercizi controllo posturali\n‚Ä¢ Combinazione mobilit√†\n‚Ä¢ Attenzione alla simmetria\n\nüåø **RECUPERO GENTILE:**\n‚Ä¢ Yoga per spalle\n‚Ä¢ Stretching delicato\n‚Ä¢ Alimentazione anti-infiammatoria\n‚Ä¢ Sonno ristoratore\n\n‚ú® **RISULTATI:**\n‚Ä¢ Spalle definite e toniche\n‚Ä¢ Postura migliorata\n‚Ä¢ Energia aumentata\n‚Ä¢ Sicurezza personale\n\nüëë **ILLUMINA IL TUO POTENZIALE!**",
                    "üî¨ **Ricerca Spalle 2025 - Protocollo Evidence-Based:**\n\n\nüìö **STUDI RIVOLUZIONARI:**\n‚Ä¢ Meta-analisi: attivazione ottimale con esercizi multi-angolo\n‚Ä¢ EMG research: lateral raises attivano 90% deltoidi laterali\n‚Ä¢ Longitudinal studies: progressione 0.3-0.6% forza/settimana\n\n\n‚öóÔ∏è **PROTOCOLLO SPERIMENTALE:**\n\n**WEEK 1-4: ADAPTATION**\n‚Ä¢ Military Press 3x12 @ 60% 1RM\n‚Ä¢ Lateral Raises 3x15\n‚Ä¢ Face Pulls 3x20\n‚Ä¢ Front Raises 3x15\n\n**WEEK 5-8: PROGRESSION**\n‚Ä¢ Military Press 4x10 @ 65% 1RM\n‚Ä¢ Lateral Raises 4x12\n‚Ä¢ Face Pulls 4x15\n‚Ä¢ Arnold Press 3x10\n\n**WEEK 9-12: INTENSIFICATION**\n‚Ä¢ Military Press 4x8 @ 70% 1RM\n‚Ä¢ Lateral Raises 4x10\n‚Ä¢ Face Pulls 4x12\n‚Ä¢ Upright Rows 3x10\n\n**WEEK 13-16: PEAK**\n‚Ä¢ Military Press 5x5 @ 75% 1RM\n‚Ä¢ Lateral Raises 4x8\n‚Ä¢ Face Pulls 4x10\n‚Ä¢ Shrugs 4x10\n\nüìä **TRACKING SCIENTIFICO:**\n‚Ä¢ Antropometriche measurements\n‚Ä¢ Strength testing periodico\n‚Ä¢ Body composition analysis\n‚Ä¢ Quality of life questionnaires\n\nüß™ **CONTROLLED VARIABLES:**\n‚Ä¢ Standardized nutrition\n‚Ä¢ Sleep monitoring\n‚Ä¢ Stress assessment\n‚Ä¢ Recovery quantification\n\nüéØ **CONCLUSIONS:**\n‚Ä¢ Linear progression effective\n‚Ä¢ Multi-angle exercises optimal\n‚Ä¢ Recovery critical for results\n‚Ä¢ Consistency key to success\n\nüî¨ **SCIENCE WORKS!**"
                ];
                return {
                    text: shoulderResponses[Math.floor(Math.random() * shoulderResponses.length)]
                };
            }
            
            if (message.includes('addominali') || message.includes('abs') || message.includes('core') || message.includes('addome')) {
                const absResponses = [
                    "üèÜ **Sistema Addominali Elite - Protocollo da Fitness Model Professionista:**\n\n\nüî¨ **SCIENZA DEL CORE:** Gli addominali sono composti da 4 strati muscolari che richiedono stimoli specifici per definizione completa. Il 70% del risultato dipende dalla dieta.\n\n\nüí™ **PROGRAMMAZIONE COMPETITION-READY - 4 Giorni/Settimana:**\n\n**GIORNO 1: UPPER ABS & OBLIQUES**\n‚Ä¢ Crunch 4x15-20 - Base di tutto\n‚Ä¢ Russian Twist 4x20/side - Obliques focus\n‚Ä¢ Bicycle Crunch 3x20/side - Rotazione dinamica\n‚Ä¢ Plank 3x60s - Core stability\n\n**GIORNO 2: LOWER ABS & DEEP CORE**\n‚Ä¢ Hanging Leg Raises 4x10-15 - Lower abs king\n‚Ä¢ Flutter Kicks 3x30s - Endurance lower\n‚Ä¢ Reverse Crunch 3x15-20 - Isolation lower\n‚Ä¢ Dead Bug 3x12/side - Deep core activation\n\n**GIORNO 3: FUNCTIONAL CORE & STABILITY**\n‚Ä¢ Pallof Press 4x10/side - Anti-rotational strength\n‚Ä¢ Woodchoppers 3x12/side - Obliques power\n‚Ä¢ Side Plank 3x45s/side - Lateral stability\n‚Ä¢ Bird Dog 3x12/side - Coordination\n\n**GIORNO 4: HIGH-INTENSITY CORE**\n‚Ä¢ Ab Wheel Rollout 4x8-12 - Full core challenge\n‚Ä¢ Dragon Flags 3x8-12 - Advanced strength\n‚Ä¢ V-ups 3x12-15 - Power movement\n‚Ä¢ Mountain Climbers 3x30s - Cardio core\n\nüî• **NUTRIZIONE PRECISIONE:**\n‚Ä¢ Deficit calorico 300-500 kcal per definizione\n‚Ä¢ Proteina 1.6-2.0g/kg per preservare massa\n‚Ä¢ Carb cycling: high/low days\n‚Ä¢ Timing pasti strategico\n\n‚ö° **SUPPLEMENTI SPECIALIZZATI:**\n‚Ä¢ BCAAs per preservare massa muscolare\n‚Ä¢ Termogenici naturali per grasso\n‚Ä¢ Fibre per saziet√†\n‚Ä¢ Elettroliti per performance\n\nüéØ **TRACKING PROGRESSI:**\n‚Ä¢ Misura circonferenza vita ogni settimana\n‚Ä¢ Foto progress giornaliere\n‚Ä¢ Test endurance plank mensile\n‚Ä¢ Monitoraggio % grasso corporeo\n\nüí° **TECNICHE PRO:**\n‚Ä¢ Slow eccentrics per time under tension\n‚Ä¢ Peak contraction holds\n‚Ä¢ Breath control (bracing)\n‚Ä¢ Mind-muscle connection\n\n‚ö†Ô∏è **GESTIONE RECUPERO:**\n‚Ä¢ Core non si allena daily per evitare overtraining\n‚Ä¢ 48-72 ore recupero tra sessioni\n‚Ä¢ Monitora DOMS e fatigue\n‚Ä¢ Integra mobilit√† work\n\nüöÄ **RISULTATI ATTESI:** Addominali visibili in 8-12 settimane con costanza!",
                    "üèãÔ∏è‚Äç‚ôÇÔ∏è **Protocollo Addominali Scientifico - Metodo Evidence-Based:**\n\n\nüìä **RICERCA MUSCOLARE:** Studi dimostrano che esercizi isometrici + dinamici producono 60% pi√π attivazione rispetto a crunch soli.\n\n\nüéØ **PROGRAMMA PERIODIZZATO:**\n\n**FASE 1: FOUNDATION BUILDING (4 settimane)**\n‚Ä¢ Plank: 3x30-45s\n‚Ä¢ Crunch: 3x15-20\n‚Ä¢ Russian Twist: 3x20/side\n‚Ä¢ Leg Raises: 3x12-15\n\n**FASE 2: STRENGTH DEVELOPMENT (4 settimane)**\n‚Ä¢ Hanging Leg Raises: 4x10-12\n‚Ä¢ Ab Wheel: 4x8-10\n‚Ä¢ Pallof Press: 3x12/side\n‚Ä¢ Side Plank: 3x30-45s/side\n\n**FASE 3: HYPERTROPHY FOCUS (4 settimane)**\n‚Ä¢ Weighted Crunch: 4x12-15\n‚Ä¢ Dragon Flags: 3x8-12\n‚Ä¢ Woodchoppers: 3x15/side\n‚Ä¢ V-ups: 3x10-15\n\n**FASE 4: DEFINITION PEAK (4 settimane)**\n‚Ä¢ Circuit Training: 4 rounds\n‚Ä¢ High-intensity intervals\n‚Ä¢ Endurance focus\n‚Ä¢ Diet optimization\n\nüî¨ **BIOMECCANICA OTTIMALE:**\n‚Ä¢ Neutral spine maintenance\n‚Ä¢ Proper bracing technique\n‚Ä¢ Controlled movement patterns\n‚Ä¢ Breathing coordination\n\nüõ°Ô∏è **PROTOCOLLO SICUREZZA:**\n‚Ä¢ Warm-up dinamico 5 minuti\n‚Ä¢ Form check costante\n‚Ä¢ Progressione graduale\n‚Ä¢ Pain monitoring\n\nüíä **RECUPERO INTELLIGENTE:**\n‚Ä¢ Active recovery days\n‚Ä¢ Mobility work\n‚Ä¢ Nutrition timing\n‚Ä¢ Sleep optimization\n\nüìà **METRICHE SUCCESSO:**\n‚Ä¢ Plank time +50% miglioramento\n‚Ä¢ Waist circumference riduzione\n‚Ä¢ Strength endurance aumentata\n‚Ä¢ Body fat % diminuzione\n\nüéñÔ∏è **MENTALIT√Ä VINCENTE:**\n‚Ä¢ Consistency over intensity\n‚Ä¢ Diet 80% of results\n‚Ä¢ Patience with process\n‚Ä¢ Celebrate small wins\n\nüèÜ **CORE CHE SOSTIENE IL MONDO!**",
                    "üåü **Sistema Addominali Funzionale - Performance Athletica:**\n\n\nüî• **FILOSOFIA ALLENAMENTO:** Core forte = atleta superiore. Funzionalit√† oltre estetica.\n\n\nüèóÔ∏è **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: ANTI-EXTENSION**\n‚Ä¢ Plank Variations 4x45s - Base stability\n‚Ä¢ Ab Wheel Rollout 4x8-12 - Strength challenge\n‚Ä¢ Dead Bug 3x12/side - Coordination\n‚Ä¢ Superman 3x15 - Back extension balance\n\n**SESSIONE B: ANTI-ROTATION**\n‚Ä¢ Pallof Press 4x10/side - Anti-rotational strength\n‚Ä¢ Russian Twist 3x20/side - Rotational power\n‚Ä¢ Woodchoppers 3x12/side - Functional movement\n‚Ä¢ Side Plank with Reach 3x12/side\n\n**SESSIONE C: ANTI-LATERAL FLEXION**\n‚Ä¢ Side Plank 4x30-45s/side - Lateral stability\n‚Ä¢ Heel Touches 3x20/side - Oblique endurance\n‚Ä¢ Copenhagen Plank 3x20s/side - Advanced stability\n‚Ä¢ Windshield Wipers 3x10/side\n\n**SESSIONE D: HIGH-INTENSITY CIRCUIT**\n‚Ä¢ Mountain Climbers 4x30s - Cardio core\n‚Ä¢ Bicycle Crunches 3x20/side - Dynamic work\n‚Ä¢ Flutter Kicks 3x45s - Endurance\n‚Ä¢ Burpee with Jump 3x10\n\n‚ö° **INTENSIT√Ä PROGRESSIVA:**\n‚Ä¢ RPE 7-9 per crescita ottimale\n‚Ä¢ Tempo sotto tensione 30-60 secondi\n‚Ä¢ Tecniche avanzate: pauses, eccentrics\n‚Ä¢ Circuit training per densit√†\n\nüß¨ **NUTRIZIONE PERFORMANCE:**\n‚Ä¢ Peri-workout carbohydrate timing\n‚Ä¢ Protein distribution\n‚Ä¢ Micronutrient optimization\n‚Ä¢ Hydration strategy\n\nüîß **STRUMENTAZIONE:**\n‚Ä¢ Core stability testing\n‚Ä¢ EMG biofeedback\n‚Ä¢ Video analysis\n‚Ä¢ Recovery monitoring\n\nüõ°Ô∏è **RISK MANAGEMENT:**\n‚Ä¢ Pre-hab exercises\n‚Ä¢ Load progression\n‚Ä¢ Injury prevention\n‚Ä¢ Overtraining monitoring\n\nüéØ **OBIETTIVI MISURABILI:**\n‚Ä¢ Stability test improvements\n‚Ä¢ Strength gains 15-25%\n‚Ä¢ Endurance increases\n‚Ä¢ Injury reduction\n\nüíé **PSICOLOGIA PEAK:**\n‚Ä¢ Mental resilience training\n‚Ä¢ Performance visualization\n‚Ä¢ Goal setting systems\n‚Ä¢ Success metrics\n\nüèÖ **CORE CHE SUPERA LIMITI!**",
                    "üèãÔ∏è‚Äç‚ôÄÔ∏è **Addominali Femminili Armoniosi - Forza & Forma Elegante:**\n\n\nüíñ **APPROCCIO OLISTICO:** Per le donne, addominali tonici significano salute e fiducia. Equilibrio tra forza e femminilit√†.\n\n\nüå∏ **PROGRAMMA 3 GIORNI/SETTIMANA:**\n\n**GIORNO CORE A**\n‚Ä¢ Plank 3x30-45s\n‚Ä¢ Bicycle Crunch 3x15/side\n‚Ä¢ Leg Raises 3x12-15\n‚Ä¢ Russian Twist 3x20/side\n\n**GIORNO CORE B**\n‚Ä¢ Side Plank 3x20-30s/side\n‚Ä¢ Reverse Crunch 3x15\n‚Ä¢ Flutter Kicks 3x30s\n‚Ä¢ Dead Bug 3x10/side\n\n**GIORNO FULL BODY**\n‚Ä¢ Mountain Climbers 3x30s\n‚Ä¢ Pallof Press 3x10/side\n‚Ä¢ Bird Dog 3x12/side\n‚Ä¢ Woodchoppers Light 3x12/side\n\nüé® **ESTETICA & FORMA:**\n‚Ä¢ Focus su hourglass figure\n‚Ä¢ Waist-to-hip ratio ottimale\n‚Ä¢ Postura elegante\n‚Ä¢ Core strength funzionale\n\nüåø **RECUPERO DELICATO:**\n‚Ä¢ Yoga per core\n‚Ä¢ Stretching profondo\n‚Ä¢ Gentle massage\n‚Ä¢ Restorative sleep\n\n‚ú® **RISULTATI:**\n‚Ä¢ Addominali tonici visibili\n‚Ä¢ Miglior posture\n‚Ä¢ Increased energy\n‚Ä¢ Enhanced confidence\n\nüëë **POTENZIA LA TUA BELLEZZA INTERIORE!**",
                    "üî¨ **Ricerca Addominali 2025 - Protocollo Evidence-Based:**\n\n\nüìö **STUDI RIVOLUZIONARI:**\n‚Ä¢ Meta-analysis: planks superiori per endurance\n‚Ä¢ EMG studies: leg raises attivano 90% lower abs\n‚Ä¢ Longitudinal research: visible abs require 10-15% body fat\n\n\n‚öóÔ∏è **PROTOCOLLO SPERIMENTALE:**\n\n**WEEK 1-4: ADAPTATION**\n‚Ä¢ Plank 3x30s\n‚Ä¢ Crunch 3x15\n‚Ä¢ Russian Twist 3x20/side\n‚Ä¢ Leg Raises 3x12\n\n**WEEK 5-8: PROGRESSION**\n‚Ä¢ Plank 4x45s\n‚Ä¢ Bicycle Crunch 4x15/side\n‚Ä¢ Hanging Leg Raises 3x10\n‚Ä¢ Pallof Press 3x12/side\n\n**WEEK 9-12: INTENSIFICATION**\n‚Ä¢ Ab Wheel 4x8\n‚Ä¢ Dragon Flags 3x8\n‚Ä¢ Weighted Crunches 3x12\n‚Ä¢ Side Plank 3x30s/side\n\n**WEEK 13-16: PEAK**\n‚Ä¢ Circuit Training 4x4 min\n‚Ä¢ High-intensity core work\n‚Ä¢ Endurance focus\n‚Ä¢ Diet optimization\n\nüìä **TRACKING SCIENTIFICO:**\n‚Ä¢ Waist circumference\n‚Ä¢ Plank time tests\n‚Ä¢ Body composition\n‚Ä¢ Strength measurements\n\nüß™ **CONTROLLED VARIABLES:**\n‚Ä¢ Caloric intake\n‚Ä¢ Training frequency\n‚Ä¢ Recovery protocols\n‚Ä¢ Sleep duration\n\nüéØ **CONCLUSIONS:**\n‚Ä¢ Progressive overload works\n‚Ä¢ Diet critical for visibility\n‚Ä¢ Recovery essential\n‚Ä¢ Consistency key\n\nüî¨ **SCIENCE REVEALS ABS!**"
                ];
                return {
                    text: absResponses[Math.floor(Math.random() * absResponses.length)]
                };
            }
            
            // Home workout Schede with variety
            if (message.includes('casa') || message.includes('home') || message.includes('domicilio') || message.includes('senza attrezzi')) {
                const homeSchede = [
                    {
                        text: "Ecco una scheda efficace per allenarti a casa senza attrezzi:",
                        template: {
                            id: 'ai_home_' + Date.now(),
                            name: 'üè† Allenamento Casa Base',
                            exercises: [
                                { name: 'Push-up', sets: 3, reps: 15, weight: 0 },
                                { name: 'Squat a Corpo Libero', sets: 3, reps: 20, weight: 0 },
                                { name: 'Plank', sets: 3, reps: 60, weight: 0 },
                                { name: 'Burpees', sets: 3, reps: 10, weight: 0 },
                                { name: 'Mountain Climbers', sets: 3, reps: 30, weight: 0 },
                                { name: 'Jumping Jacks', sets: 3, reps: 30, weight: 0 }
                            ]
                        }
                    },
                    {
                        text: "Allenamento casalingo con focus su forza e resistenza:",
                        template: {
                            id: 'ai_home_' + Date.now(),
                            name: 'üè† Forza & Resistenza',
                            exercises: [
                                { name: 'Diamond Push-ups', sets: 4, reps: 12, weight: 0 },
                                { name: 'Bodyweight Squats', sets: 4, reps: 15, weight: 0 },
                                { name: 'Superman Holds', sets: 3, reps: 30, weight: 0 },
                                { name: 'Lunges', sets: 3, reps: 10, weight: 0 },
                                { name: 'Plank', sets: 3, reps: 45, weight: 0 },
                                { name: 'Burpees', sets: 3, reps: 8, weight: 0 }
                            ]
                        }
                    },
                    {
                        text: "Scheda HIIT per casa - alta intensit√†, risultati rapidi:",
                        template: {
                            id: 'ai_home_' + Date.now(),
                            name: 'üè† HIIT Explosion',
                            exercises: [
                                { name: 'Push-ups', sets: 4, reps: 20, weight: 0 },
                                { name: 'Jump Squats', sets: 4, reps: 15, weight: 0 },
                                { name: 'Mountain Climbers', sets: 4, reps: 40, weight: 0 },
                                { name: 'Burpees', sets: 4, reps: 12, weight: 0 },
                                { name: 'High Knees', sets: 4, reps: 30, weight: 0 },
                                { name: 'Plank Jacks', sets: 4, reps: 20, weight: 0 }
                            ]
                        }
                    }
                ];
                return homeTemplates[Math.floor(Math.random() * homeTemplates.length)];
            }
            
            // General advice responses
            if (message.includes('dieta') || message.includes('alimentazione') || message.includes('mangiare') || message.includes('nutrizione')) {
                const dietResponses = [
                    "L'alimentazione √® fondamentale! Ecco i principi base:\n\nü•ó **Per la massa muscolare**:\n‚Ä¢ Surplus calorico di 300-500 kcal\n‚Ä¢ 1.6-2.2g di proteine per kg di peso\n‚Ä¢ Carboidrati intorno agli allenamenti\n\nüî• **Per la definizione**:\n‚Ä¢ Deficit calorico di 300-500 kcal\n‚Ä¢ Mantieni alte le proteine (2-2.5g/kg)\n‚Ä¢ Riduci gradualmente carboidrati e grassi\n\nüí° **Consigli generali**:\n‚Ä¢ Bevi almeno 2-3L di acqua al giorno\n‚Ä¢ Mangia ogni 3-4 ore\n‚Ä¢ Priorit√† a cibi integrali e non processati",
                    "Alimentazione per risultati ottimali:\n\nüèãÔ∏è **Bulk**:\n‚Ä¢ 2500-3000 kcal giornaliere\n‚Ä¢ Proteine: 2g/kg\n‚Ä¢ Carboidrati: 4-5g/kg\n‚Ä¢ Grassi: 1g/kg\n\nüî• **Cut**:\n‚Ä¢ 1800-2200 kcal giornaliere\n‚Ä¢ Proteine: 2.2g/kg\n‚Ä¢ Carboidrati: 2-3g/kg\n‚Ä¢ Grassi: 0.8g/kg\n\nüçé **Cibi consigliati**:\n‚Ä¢ Pollo, tacchino, pesce\n‚Ä¢ Riso, patate dolci, avena\n‚Ä¢ Uova, latte, yogurt greco\n‚Ä¢ Frutta, verdura, noci",
                    "Guida alimentare per bodybuilding:\n\nü•© **Proteine**:\n‚Ä¢ Carne magra, pesce, uova\n‚Ä¢ Latticini, legumi, tofu\n‚Ä¢ Proteine in polvere (whey/casein)\n\nüçö **Carboidrati**:\n‚Ä¢ Cereali integrali\n‚Ä¢ Frutta e verdura\n‚Ä¢ Tuberi (patate, riso)\n\nü•ë **Grassi**:\n‚Ä¢ Avocado, noci, semi\n‚Ä¢ Olio d'oliva, pesce grasso\n‚Ä¢ Burro di arachidi\n\nRicorda: 80% dieta, 20% allenamento!"
                ];
                return {
                    text: dietResponses[Math.floor(Math.random() * dietResponses.length)]
                };
            }
            
            if (message.includes('recupero') || message.includes('riposo') || message.includes('recovery') || message.includes('stanchezza')) {
                const recoveryResponses = [
                    "Il recupero √® quando cresci davvero! üí™\n\nüò¥ **Sonno**:\n‚Ä¢ 7-9 ore per notte\n‚Ä¢ Qualit√† del sonno > quantit√†\n‚Ä¢ Routine serale costante\n\n‚è∞ **Riposo tra allenamenti**:\n‚Ä¢ 48-72h per lo stesso gruppo muscolare\n‚Ä¢ Giorni di riposo attivo (camminata, yoga)\n‚Ä¢ Ascolta il tuo corpo\n\nüßò **Gestione dello stress**:\n‚Ä¢ Meditazione o tecniche di rilassamento\n‚Ä¢ Hobby e attivit√† piacevoli\n‚Ä¢ Evita sovrallenamento\n\nRicorda: i muscoli crescono durante il riposo, non durante l'allenamento!",
                    "Recupero intelligente per risultati massimi:\n\nüí§ **Sonno profondo**:\n‚Ä¢ Orario fisso ogni notte\n‚Ä¢ Stanza buia e fresca\n‚Ä¢ Niente schermi 1h prima\n\nüõÄ **Recupero attivo**:\n‚Ä¢ Camminate leggere\n‚Ä¢ Stretching e mobilit√†\n‚Ä¢ Massaggi e foam rolling\n\nüçΩÔ∏è **Nutrizione**:\n‚Ä¢ Proteine post-allenamento\n‚Ä¢ Carboidrati per ricaricare glicogeno\n‚Ä¢ Anti-infiammatori naturali\n\nSegni di sovrallenamento: fatica cronica, dolori articolari, calo prestazioni!",
                    "Strategie di recupero avanzate:\n\nüîÑ **Active Recovery**:\n‚Ä¢ Allenamenti leggeri\n‚Ä¢ Nuoto o bici facile\n‚Ä¢ Yoga e pilates\n\nüßä **Terapie**:\n‚Ä¢ Bagni ghiacciati\n‚Ä¢ Sauna infrarossi\n‚Ä¢ Massaggi sportivi\n\nüìä **Monitoraggio**:\n‚Ä¢ Frequenza cardiaca a riposo\n‚Ä¢ Peso corporeo\n‚Ä¢ Livelli di energia\n\nIl recupero ottimale = progressi costanti!"
                ];
                return {
                    text: recoveryResponses[Math.floor(Math.random() * recoveryResponses.length)]
                };
            }
            
            // Default responses
            const defaultResponses = [
                "Interessante domanda! Potresti essere pi√π specifico? Sono qui per aiutarti con allenamenti, esercizi, tecnica e consigli fitness.",
                "Sono specializzato in fitness e allenamento. Puoi chiedermi di creare schede, suggerire esercizi o dare consigli sulla tecnica!",
                "Non sono sicuro di aver capito. Prova a chiedermi qualcosa come 'Crea una scheda per i pettorali' o 'Come migliorare lo squat'.",
                "Sono qui per aiutarti con tutto ci√≤ che riguarda il fitness! Chiedi pure di schede, esercizi, tecnica o consigli nutrizionali."
            ];
            
            return {
                text: defaultResponses[Math.floor(Math.random() * defaultResponses.length)]
            };
        }

        function useAITemplate(templateId) {
            // Find the template in the AI messages
            const messages = document.querySelectorAll('.ai-template-preview');
            let templateData = null;
            
            messages.forEach(preview => {
                const button = preview.querySelector('.ai-use-template-btn');
                if (button && button.getAttribute('onclick').includes(templateId)) {
                    const name = preview.querySelector('h4').textContent.replace('üèãÔ∏è ', '');
                    const exercises = [];
                    
                    preview.querySelectorAll('.ai-template-exercises li').forEach(li => {
                        const text = li.textContent;
                        const parts = text.split(' - ');
                        const name = parts[0];
                        const details = parts[1];
                        
                        // Parse "3 serie √ó 10 reps @ 50kg"
                        const match = details.match(/(\d+) serie √ó (\d+) reps @ (\d+(?:\.\d+)?)kg/);
                        if (match) {
                            exercises.push({
                                name: name,
                                sets: parseInt(match[1]),
                                reps: parseInt(match[2]),
                                weight: parseFloat(match[3])
                            });
                        }
                    });
                    
                    // Limita il nome della scheda a massimo 10 caratteri
                    let limitedName = name;
                    if (name.length > 10) {
                        limitedName = name.substring(0, 10);
                    }
                    
                    templateData = { name: limitedName, exercises };
                }
            });
            
            if (templateData) {
                // Add to custom Schede
                const newId = 'ai_Scheda_' + Date.now();
                customSchede[newId] = templateData;
                saveSchede();
                
                // Update UI
                renderSchedaButtons();
                renderSchedaEditors();
                
                // Switch to workout page and load the Scheda
                showPage('workout');
                loadScheda(newId);
                
                // Show success message
                addAIMessage(`‚úÖ Scheda "${templateData.name}" aggiunto con successo! L'ho caricato nella tua pagina workout.`, 'assistant');
            }
        }

        // AUTOCOMPLETAMENTO
        function setupAutocomplete() {
            const exerciseInput = document.getElementById('exerciseNameInput');
            const SchedaInput = document.getElementById('SchedaExerciseNameInput');
            const exerciseSuggestions = document.getElementById('exerciseSuggestions');
            const Schedeuggestions = document.getElementById('SchedaExerciseSuggestions');

            setupInputAutocomplete(exerciseInput, exerciseSuggestions);
            setupInputAutocomplete(SchedaInput, Schedeuggestions);
        }

        function setupInputAutocomplete(input, suggestionsContainer) {
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                if (query.length === 0) {
                    hideSuggestions(suggestionsContainer);
                    return;
                }

                const suggestions = getExerciseSuggestions(query);
                showSuggestions(suggestions, suggestionsContainer, input);
            });

            input.addEventListener('keydown', function(e) {
                handleKeyNavigation(e, suggestionsContainer, input);
            });

            input.addEventListener('blur', function() {
                setTimeout(() => hideSuggestions(suggestionsContainer), 150);
            });
        }

        function getExerciseSuggestions(query) {
            const normalizedQuery = normalizeExerciseName(query);
            
            // Inizia con esercizi predefiniti (formattati)
            let allExercises = Object.keys(PREDEFINED_EXERCISES).map(name => formatExerciseName(name));
            
            // Aggiungi esercizi dalla cronologia degli allenamenti
            const exerciseSet = new Set(allExercises.map(e => normalizeExerciseName(e)));
            
            workoutHistory.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    const normalized = normalizeExerciseName(exercise.name);
                    if (!exerciseSet.has(normalized)) {
                        exerciseSet.add(normalized);
                        allExercises.push(formatExerciseName(exercise.name));
                    }
                });
            });
            
            return allExercises
                .filter(exercise => normalizeExerciseName(exercise).includes(normalizedQuery))
                .sort()
                .slice(0, 8); // Aumentato a 8 suggerimenti
        }

        function showSuggestions(suggestions, container, input) {
            if (suggestions.length === 0) {
                hideSuggestions(container);
                return;
            }

            container.innerHTML = suggestions.map((suggestion, index) => 
                `<div class="autocomplete-suggestion" data-index="${index}">${suggestion}</div>`
            ).join('');

            container.classList.add('show');
            selectedSuggestionIndex = -1;

            container.querySelectorAll('.autocomplete-suggestion').forEach((item, index) => {
                item.addEventListener('click', function() {
                    input.value = suggestions[index];
                    hideSuggestions(container);
                    input.focus();
                });
            });
        }

        function hideSuggestions(container) {
            container.classList.remove('show');
            selectedSuggestionIndex = -1;
        }

        function handleKeyNavigation(e, container, input) {
            const suggestions = container.querySelectorAll('.autocomplete-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                updateSuggestionSelection(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSuggestionSelection(suggestions);
            } else if (e.key === 'Enter') {
                if (selectedSuggestionIndex >= 0 && suggestions[selectedSuggestionIndex]) {
                    e.preventDefault();
                    input.value = suggestions[selectedSuggestionIndex].textContent;
                    hideSuggestions(container);
                }
            } else if (e.key === 'Escape') {
                hideSuggestions(container);
            }
        }

        function updateSuggestionSelection(suggestions) {
            suggestions.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedSuggestionIndex);
            });
        }

        // NAVIGATION
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(pageId + 'Page').classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            // Update charts when showing progress page
            if (pageId === 'progress') {
                setTimeout(() => {
                    updateExerciseFilterOptions();
                    updateProgressCharts();
                }, 100);
            }
        }

        // WORKOUT FUNCTIONS
        function updateWorkoutDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('workoutDate').textContent = today.toLocaleDateString('it-IT', options);
            
            // Set default date in save modal
            const dateInput = document.getElementById('workoutDateInput');
            dateInput.value = today.toISOString().split('T')[0];
        }

        function showAddExerciseModal() {
            document.getElementById('exerciseModal').classList.add('show');
            document.getElementById('exerciseNameInput').focus();
        }

        function confirmAddExercise() {
            const name = document.getElementById('exerciseNameInput').value.trim();
            if (!name) {
                alert('Inserisci il nome dell\'esercizio');
                return;
            }

            // Normalizza e formatta il nome dell'esercizio
            const formattedName = formatExerciseName(name);

            // Se √® il primo esercizio aggiunto manualmente, resetta il nome scheda
            if (currentExercises.length === 0) {
                currentSchedaName = null;
            }

            // Controlla se l'esercizio √® gi√† nel database (usa normalizzazione)
            const normalizedName = normalizeExerciseName(name);
            const isInDatabase = PREDEFINED_EXERCISES[normalizedName] !== undefined;
            const hasBeenUsed = workoutHistory.some(workout => 
                workout.exercises.some(ex => normalizeExerciseName(ex.name) === normalizedName)
            );

            // Se l'esercizio non √® mai stato usato e non √® nel database, mostra la modale di configurazione
            if (!isInDatabase && !hasBeenUsed) {
                showMuscleSelectionModal(formattedName);
                return;
            }

            // Procedi normalmente con il nome formattato
            addExerciseToWorkout(formattedName);
        }

        function addExerciseToWorkout(name, customParams = null, isCardioOverride = null) {
            const isCardio = isCardioOverride !== null ? isCardioOverride : isCardioExercise(name);
            const lastData = getLastExerciseData(name);

            let exercise;
            if (isCardio) {
                // Esercizio cardio: tempo e distanza
                const time = customParams?.time ?? lastData?.time ?? 30;
                const distance = customParams?.distance ?? lastData?.distance ?? 5;
                
                exercise = {
                    id: Date.now(),
                    name: name,
                    isCardio: true,
                    time: time,
                    distance: distance,
                    notes: lastData?.notes || '',
                    notesCollapsed: !(lastData?.notes)
                };
            } else {
                // Esercizio tradizionale: sets, reps, weight
                const sets = customParams?.sets ?? lastData?.sets ?? 3;
                const reps = customParams?.reps ?? lastData?.reps ?? 10;
                const weight = customParams?.weight ?? lastData?.weight ?? 0;
                
                exercise = {
                    id: Date.now(),
                    name: name,
                    isCardio: false,
                    sets: sets,
                    reps: reps,
                    weight: weight,
                    notes: lastData?.notes || '',
                    notesCollapsed: !(lastData?.notes)
                };
            }

            currentExercises.push(exercise);
            renderExercises();
            hideModal();
            
            // Clear input
            document.getElementById('exerciseNameInput').value = '';
        }

        function showMuscleSelectionModal(exerciseName) {
            // Salva il nome dell'esercizio per usarlo dopo
            window.pendingExerciseName = exerciseName;
            
            // Reset dei radio button e mostra input tradizionali di default
            document.querySelector('input[name="exerciseType"][value="traditional"]').checked = true;
            toggleExerciseInputs();
            
            // Mostra la modale
            document.getElementById('muscleSelectionModal').classList.add('show');
        }

        function toggleExerciseInputs() {
            const exerciseType = document.querySelector('input[name="exerciseType"]:checked').value;
            const traditionalInputs = document.getElementById('traditionalInputs');
            const cardioInputs = document.getElementById('cardioInputs');
            const inputsTitle = document.getElementById('inputsTitle');
            const musclesGrid = document.getElementById('musclesGridSelection');
            
            if (exerciseType === 'cardio') {
                traditionalInputs.style.display = 'none';
                cardioInputs.style.display = 'flex';
                inputsTitle.textContent = 'Specifica durata e distanza:';
                // Nascondi la selezione muscoli per cardio
                if (musclesGrid) {
                    musclesGrid.style.display = 'none';
                }
            } else {
                traditionalInputs.style.display = 'flex';
                cardioInputs.style.display = 'none';
                inputsTitle.textContent = 'Specifica serie, reps e peso:';
                // Mostra la selezione muscoli per esercizi tradizionali
                if (musclesGrid) {
                    musclesGrid.style.display = 'block';
                }
            }
        }

        function confirmMuscleSelection() {
            const exerciseName = window.pendingExerciseName;
            if (!exerciseName) return;

            // Ottieni il tipo selezionato
            const exerciseType = document.querySelector('input[name="exerciseType"]:checked').value;
            const isCardio = exerciseType === 'cardio';

            // Ottieni i muscoli selezionati
            const selectedMuscles = [];
            document.querySelectorAll('.muscle-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                selectedMuscles.push(checkbox.value);
            });

            // Se √® cardio, aggiungi 'cardio' ai muscoli
            if (isCardio) {
                selectedMuscles.push('cardio');
            }

            // Salva nel database usando la funzione centralizzata
            saveExerciseToDatabase(exerciseName, selectedMuscles);

            // Ottieni i valori dei campi di input
            let exerciseParams = {};
            if (isCardio) {
                exerciseParams = {
                    time: parseInt(document.getElementById('exerciseTime').value) || 30,
                    distance: parseFloat(document.getElementById('exerciseDistance').value) || 5
                };
            } else {
                exerciseParams = {
                    sets: parseInt(document.getElementById('exerciseSets').value) || 3,
                    reps: parseInt(document.getElementById('exerciseReps').value) || 10,
                    weight: parseFloat(document.getElementById('exerciseWeight').value) || 0
                };
            }

            // Ora aggiungi l'esercizio al workout con i parametri specificati
            addExerciseToWorkout(exerciseName, exerciseParams, isCardio);
            
            // Chiudi la modale
            document.getElementById('muscleSelectionModal').classList.remove('show');
        }

        function cancelMuscleSelection() {
            document.getElementById('muscleSelectionModal').classList.remove('show');
            window.pendingExerciseName = null;
        }

        function hideModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function getLastExerciseData(exerciseName) {
            if (!exerciseName || workoutHistory.length === 0) return null;
            const target = normalizeExerciseName(exerciseName);

            for (let i = workoutHistory.length - 1; i >= 0; i--) {
                const workout = workoutHistory[i];
                if (!workout || !Array.isArray(workout.exercises)) continue;

                const match = workout.exercises.find(ex =>
                    ex && ex.name && normalizeExerciseName(ex.name) === target
                );

                if (match) {
                    if (match.isCardio) {
                        // Esercizio cardio
                        const parsedTime = parseInt(match.time, 10);
                        const parsedDistance = parseFloat(match.distance);

                        return {
                            isCardio: true,
                            time: Number.isFinite(parsedTime) ? parsedTime : undefined,
                            distance: Number.isFinite(parsedDistance) ? parsedDistance : undefined,
                            notes: match.notes || ''
                        };
                    } else {
                        // Esercizio tradizionale
                        const parsedSets = parseInt(match.sets, 10);
                        const parsedReps = parseInt(match.reps, 10);
                        const parsedWeight = parseFloat(match.weight);

                        return {
                            isCardio: false,
                            sets: Number.isFinite(parsedSets) ? parsedSets : undefined,
                            reps: Number.isFinite(parsedReps) ? parsedReps : undefined,
                            weight: Number.isFinite(parsedWeight) ? parsedWeight : undefined,
                            notes: match.notes || ''
                        };
                    }
                }
            }

            return null;
        }

        function renderExercises() {
            const container = document.getElementById('exercisesList');
            
            if (currentExercises.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí™</div>
                        <div class="empty-state-title">Nessun esercizio</div>
                        <div>Aggiungi un esercizio o carica un Scheda</div>
                    </div>
                `;
                document.getElementById('saveWorkoutBtn').style.display = 'none';
                document.getElementById('reorderExercisesBtn').style.display = 'none';
                return;
            }

            const baseId = Date.now();

            container.innerHTML = currentExercises.map((exercise, index) => {
                if (!exercise.id) {
                    exercise.id = baseId + index;
                }

                if (typeof exercise.notesCollapsed === 'undefined') {
                    exercise.notesCollapsed = true;
                }

                const isCollapsed = exercise.notesCollapsed !== false;
                const hasNotes = !!(exercise.notes && exercise.notes.trim().length);

                const notesToggleClasses = [
                    'control-btn',
                    'notes-toggle',
                    !isCollapsed ? 'open' : '',
                    hasNotes ? 'has-text' : ''
                ].filter(Boolean).join(' ');

                const notesSectionClasses = [
                    'notes-section',
                    isCollapsed ? 'collapsed' : ''
                ].filter(Boolean).join(' ');

                const notesToggleTitle = isCollapsed ? 'Mostra note' : 'Nascondi note';
                const notesToggleIcon = isCollapsed ? 'üìù' : 'üìÑ';

                return `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div class="exercise-name">${exercise.name}</div>
                            <div class="exercise-controls">
                                <button class="control-btn video-btn" title="Video YouTube" onclick="openExerciseVideo(${index})">üé•</button>
                                <button class="${notesToggleClasses}" title="${notesToggleTitle}" onclick="toggleNotes(${index})">${notesToggleIcon}</button>
                                <button class="control-btn delete" title="Rimuovi" onclick="removeExercise(${index})">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="exercise-inputs">
                            ${exercise.isCardio ? `
                                <div class="input-group">
                                    <label class="input-label">Tempo (minuti)</label>
                                    <input type="number" class="input-field" placeholder="Minuti" value="${exercise.time}" 
                                           onchange="updateExercise(${index}, 'time', this.value)" min="1">
                                    <small class="input-hint">Minuti</small>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Distanza (km)</label>
                                    <input type="number" class="input-field" placeholder="Km" value="${exercise.distance}" 
                                           onchange="updateExercise(${index}, 'distance', this.value)" min="0" step="0.1">
                                    <small class="input-hint">Km</small>
                                </div>
                                <div class="input-group cardio-placeholder">
                                    <!-- Placeholder per mantenere l'allineamento -->
                                </div>
                            ` : `
                                <div class="input-group">
                                    <label class="input-label">Serie</label>
                                    <input type="number" class="input-field" placeholder="Serie" value="${exercise.sets}" 
                                           onchange="updateExercise(${index}, 'sets', this.value)" min="1">
                                    <small class="input-hint">Serie</small>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Reps</label>
                                    <input type="number" class="input-field" placeholder="Reps" value="${exercise.reps}" 
                                           onchange="updateExercise(${index}, 'reps', this.value)" min="1">
                                    <small class="input-hint">Reps</small>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Peso (kg)</label>
                                    <input type="number" class="input-field" placeholder="Kg" value="${exercise.weight}" 
                                           onchange="updateExercise(${index}, 'weight', this.value)" min="0" step="0.5">
                                    <small class="input-hint">Kg</small>
                                </div>
                            `}
                        </div>
                        <div class="${notesSectionClasses}">
                            <textarea class="notes-input" placeholder="Note per questo esercizio..." 
                                      onchange="updateExercise(${index}, 'notes', this.value)">${exercise.notes || ''}</textarea>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('saveWorkoutBtn').style.display = 'block';
            document.getElementById('reorderExercisesBtn').style.display = currentExercises.length > 1 ? 'inline-block' : 'none';
        }

        function updateExercise(index, field, value) {
            if (field === 'sets' || field === 'reps' || field === 'time') {
                currentExercises[index][field] = parseInt(value) || 1;
            } else if (field === 'weight' || field === 'distance') {
                currentExercises[index][field] = parseFloat(value) || 0;
            } else {
                currentExercises[index][field] = value;
            }
        }

        function toggleNotes(index) {
            if (!currentExercises[index]) return;
            const current = currentExercises[index].notesCollapsed !== false;
            currentExercises[index].notesCollapsed = !current;
            renderExercises();
        }

        function moveExercise(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentExercises.length) return;
            
            [currentExercises[index], currentExercises[newIndex]] = [currentExercises[newIndex], currentExercises[index]];
            renderExercises();
        }

        function duplicateExercise(index) {
            const exercise = { ...currentExercises[index] };
            exercise.id = Date.now();
            exercise.notesCollapsed = true;
            currentExercises.splice(index + 1, 0, exercise);
            renderExercises();
        }

        function showReorderModal() {
            const modal = document.getElementById('reorderModal');
            const list = document.getElementById('reorderList');
            
            list.innerHTML = currentExercises.map((ex, index) => `
                <div class="reorder-item" data-index="${index}">
                    <span class="reorder-item-name">${ex.name}</span>
                    <button class="reorder-arrow-btn" onclick="moveExerciseInModal(${index}, -1)" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                    <button class="reorder-arrow-btn" onclick="moveExerciseInModal(${index}, 1)" ${index === currentExercises.length - 1 ? 'disabled' : ''}>‚Üì</button>
                </div>
            `).join('');
            
            modal.classList.add('show');
        }

        function moveExerciseInModal(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentExercises.length) return;
            
            // Swap exercises
            [currentExercises[index], currentExercises[newIndex]] = [currentExercises[newIndex], currentExercises[index]];
            
            // Re-render the modal content
            const list = document.getElementById('reorderList');
            list.innerHTML = currentExercises.map((ex, i) => `
                <div class="reorder-item" data-index="${i}">
                    <span class="reorder-item-name">${ex.name}</span>
                    <button class="reorder-arrow-btn" onclick="moveExerciseInModal(${i}, -1)" ${i === 0 ? 'disabled' : ''}>‚Üë</button>
                    <button class="reorder-arrow-btn" onclick="moveExerciseInModal(${i}, 1)" ${i === currentExercises.length - 1 ? 'disabled' : ''}>‚Üì</button>
                </div>
            `).join('');
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.reorder-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function confirmReorder() {
            // Gli esercizi sono gi√† stati riordinati in currentExercises tramite moveExerciseInModal
            renderExercises();
            document.getElementById('reorderModal').classList.remove('show');
        }

        function removeExercise(index) {
            currentExercises.splice(index, 1);
            renderExercises();
        }

        function openExerciseVideo(index) {
            const exerciseName = currentExercises[index].name;
            const searchQuery = 'how to do ' + exerciseName + ' properly';
            const youtubeUrl = 'https://www.youtube.com/results?search_query=' + encodeURIComponent(searchQuery);

            try {
                const newWindow = window.open(youtubeUrl, '_blank');
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    // Popup bloccato, apri nella stessa finestra
                    if (confirm('Il popup √® stato bloccato. Vuoi aprire YouTube in questa finestra? (perderai il workout corrente)')) {
                        window.location.href = youtubeUrl;
                    }
                }
            } catch (e) {
                // Fallback per browser che bloccano popup
                if (confirm('Impossibile aprire il video. Vuoi aprire YouTube in questa finestra? (perderai il workout corrente)')) {
                    window.location.href = youtubeUrl;
                }
            }
        }

        function showSaveWorkoutModal() {
            // Imposta valori di default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workoutDateInput').value = today;
            document.getElementById('durationInput').value = 60;
            document.getElementById('notesInput').value = '';
            
            document.getElementById('saveModal').classList.add('show');
            document.getElementById('durationInput').focus();
        }

        function confirmSaveWorkout() {
            // CORREZIONE BUG 1: Gestione corretta della data
            const workoutDateInput = document.getElementById('workoutDateInput').value;
            if (!workoutDateInput) {
                alert('Seleziona una data per l\'allenamento');
                return;
            }
            
            const duration = parseInt(document.getElementById('durationInput').value) || 60;
            const notes = document.getElementById('notesInput').value.trim();

            if (currentExercises.length === 0) {
                alert('Aggiungi almeno un esercizio prima di salvare');
                return;
            }

            const workout = {
                id: Date.now() + Math.random(), // CORREZIONE BUG 2: ID univoco
                date: workoutDateInput, // Usa direttamente il valore dell'input (formato YYYY-MM-DD)
                exercises: currentExercises.map(ex => {
                    // Salva ogni esercizio nel database locale
                    const muscles = getMuscleGroupsForExercise(ex.name);
                    saveExerciseToDatabase(ex.name, muscles);
                    
                    return {
                        name: ex.name,
                        sets: ex.sets,
                        reps: ex.reps,
                        weight: ex.weight,
                        notes: ex.notes || ''
                    };
                }),
                duration: duration,
                notes: notes,
                schedaName: currentSchedaName
            };

            workoutHistory.push(workout);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

            // Reset current workout
            currentExercises = [];
            currentSchedaName = null;
            renderExercises();
            
            // Update other views
            updateStats();
            renderHistory();
            renderProgress();
            renderCalendar();
            updateExerciseFilterOptions();

            hideModal();
        }

        // TEMPLATE FUNCTIONS
        function renderSchedaButtons() {
            const container = document.getElementById('SchedaButtons');

            const entriesMap = new Map();

            Object.entries(customSchede).forEach(([id, scheda]) => {
                const isProtected = id.startsWith('giulia24_') || id.startsWith('giovanna0_') || id.startsWith('doriano0_');
                if (!isProtected || unlockedCodes.some(code => codeMappings[code] && codeMappings[code].includes(id))) {
                    entriesMap.set(id, scheda);
                }
            });

            getUnlockedProtectedSchede().forEach(([id, scheda]) => {
                if (!entriesMap.has(id)) {
                    entriesMap.set(id, scheda);
                }
            });

            const entries = Array.from(entriesMap.entries());

            container.innerHTML = entries.map(([id, Scheda]) => {
                const isPersonal = id.startsWith('personal_');
                const isProtected = id.startsWith('giulia24_') || id.startsWith('giovanna0_') || id.startsWith('doriano0_');
                const isUnlocked = unlockedCodes.some(code => codeMappings[code] && codeMappings[code].includes(id));
                const showActions = !isPersonal && (!isProtected || isUnlocked);
                
                // Limita il nome della scheda a massimo 10 caratteri per i pulsanti
                let displayName = Scheda.name;
                if (displayName.length > 10) {
                    displayName = displayName.substring(0, 10);
                }

                return `
                    <button class="template-btn" data-template="${id}">
                        ${displayName}
                        ${showActions ? `<button class="template-edit-btn" onclick="event.stopPropagation(); editScheda('${id}')">‚úèÔ∏è</button>` : ''}
                        ${showActions ? `<button class="template-delete-btn" onclick="event.stopPropagation(); deleteScheda('${id}')">üóëÔ∏è</button>` : ''}
                    </button>
                `;
            }).join('');

            document.querySelectorAll('[data-template]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const templateId = this.getAttribute('data-template');
                    loadScheda(templateId);
                });
            });
        }

        function loadScheda(SchedaId) {
            let Scheda = customSchede[SchedaId];

            if (!Scheda) {
                const isProtected = unlockedCodes.some(code => codeMappings[code] && codeMappings[code].includes(SchedaId));
                if (isProtected && protectedSchedeData[SchedaId]) {
                    Scheda = protectedSchedeData[SchedaId];
                }
            }

            if (!Scheda) {
                alert('Scheda non disponibile. Inserisci il codice corretto per accedervi.');
                return;
            }

            currentSchedaName = Scheda.name;

            currentExercises = Scheda.exercises.map(ex => {
                // Salva ogni esercizio nel database locale quando viene caricato
                const muscles = getMuscleGroupsForExercise(ex.name);
                saveExerciseToDatabase(ex.name, muscles);
                
                const isCardio = isCardioExercise(ex.name);
                const lastData = getLastExerciseData(ex.name);
                
                if (isCardio) {
                    const defaultTime = Number.isFinite(parseInt(ex.time, 10)) ? parseInt(ex.time, 10) : (lastData?.time ?? 30);
                    const defaultDistance = Number.isFinite(parseFloat(ex.distance)) ? parseFloat(ex.distance) : (lastData?.distance ?? 5);
                    
                    return {
                        id: Date.now() + Math.random(),
                        name: ex.name,
                        isCardio: true,
                        time: defaultTime,
                        distance: defaultDistance,
                        notes: ex.notes || '',
                        notesCollapsed: true
                    };
                } else {
                    const defaultSets = Number.isFinite(parseInt(ex.sets, 10)) ? parseInt(ex.sets, 10) : (lastData?.sets ?? 3);
                    const defaultReps = Number.isFinite(parseInt(ex.reps, 10)) ? parseInt(ex.reps, 10) : (lastData?.reps ?? 10);
                    const defaultWeight = Number.isFinite(parseFloat(ex.weight)) ? parseFloat(ex.weight) : (lastData?.weight ?? 0);
                    
                    return {
                        id: Date.now() + Math.random(),
                        name: ex.name,
                        isCardio: false,
                        sets: defaultSets,
                        reps: defaultReps,
                        weight: defaultWeight,
                        notes: ex.notes || '',
                        notesCollapsed: true
                    };
                }
            });

            renderExercises();
        }

        function renderSchedaEditors() {
            const container = document.getElementById('SchedaEditorsList');
            
            // Filtra le schede: escludi personali e schede protette non sbloccate
            const editableSchede = Object.entries(customSchede).filter(([id]) => {
                if (id.startsWith('personal_')) return false;
                const isProtected = id.startsWith('giulia24_') || id.startsWith('giovanna0_') || id.startsWith('doriano0_');
                return !isProtected;
            });
            
            // Ottieni le schede protette sbloccate
            const unlockedProtectedSchede = getUnlockedProtectedSchede();
            
            container.innerHTML = editableSchede.map(([id, Scheda]) => `
                <div class="template-editor">
                    <h3>‚öôÔ∏è ${Scheda.name}</h3>
                    <div class="template-info">
                        <input type="text" class="modal-input" value="${Scheda.name}" 
                               onchange="updateSchedaName('${id}', this.value)" 
                               placeholder="Nome Template">
                    </div>
                    <button class="add-template-exercise-btn" onclick="showAddSchedaExercise('${id}')">
                        ‚ûï Aggiungi Esercizio
                    </button>
                    <div class="template-exercises">
                        ${Scheda.exercises.map((exercise, index) => `
                            <div class="template-exercise-item">
                                <div class="template-exercise-info">
                                    <div class="template-exercise-name">${exercise.name}</div>
                                    <div class="template-exercise-details">${exercise.sets} serie √ó ${exercise.reps} reps @ ${exercise.weight}kg</div>
                                </div>
                                <div class="template-exercise-controls">
                                    <button class="template-exercise-btn" onclick="moveSchedaExercise('${id}', ${index}, -1)">‚Üë</button>
                                    <button class="template-exercise-btn" onclick="moveSchedaExercise('${id}', ${index}, 1)">‚Üì</button>
                                    <button class="template-exercise-btn delete" onclick="removeSchedaExercise('${id}', ${index})">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('') + 
            // Aggiungi le schede protette sbloccate in sola lettura
            (unlockedProtectedSchede.length > 0 ? `
                <div class="template-editor">
                    <h3>üîí Schede Sbloccate (Sola Lettura)</h3>
                    ${unlockedProtectedSchede.map(([id, Scheda]) => `
                        <div class="template-editor" style="border: 2px solid #48bb78; margin-bottom: 20px;">
                            <h3>‚úÖ ${Scheda.name}</h3>
                            <div class="template-exercises">
                                ${Scheda.exercises.map((exercise, index) => `
                                    <div class="template-exercise-item">
                                        <div class="template-exercise-info">
                                            <div class="template-exercise-name">${exercise.name}</div>
                                            <div class="template-exercise-details">${exercise.sets} serie √ó ${exercise.reps} reps @ ${exercise.weight}kg</div>
                                        </div>
                                        <div class="template-exercise-controls">
                                            <span style="color: #718096; font-size: 0.8em;">üîí Protetta</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '');
        }

        function editScheda(SchedaId) {
            showPage('Schede');
        }

        function deleteScheda(SchedaId) {
            if (SchedaId.startsWith('personal_')) {
                alert('Questa scheda √® protetta e non pu√≤ essere eliminata.');
                return;
            }
            if (confirm('Sei sicuro di voler eliminare questo Scheda?')) {
                if (customSchede[SchedaId]) {
                    delete customSchede[SchedaId];
                    saveSchede();
                } else {
                    // √à una scheda sbloccata, rimuovi il codice
                    const codesToRemove = new Set();
                    Object.entries(codeMappings).forEach(([code, ids]) => {
                        if (ids.includes(SchedaId)) {
                            codesToRemove.add(code);
                        }
                    });
                    unlockedCodes = unlockedCodes.filter(code => !codesToRemove.has(code));
                    localStorage.setItem('unlockedCodes', JSON.stringify(unlockedCodes));
                }
                renderSchedaButtons();
                renderSchedaEditors();
            }
        }

        function showAddSchedaModal() {
            document.getElementById('newSchedaModal').classList.add('show');
            document.getElementById('newSchedaNameInput').focus();
        }

        function confirmAddScheda() {
            const name = document.getElementById('newSchedaNameInput').value.trim();
            if (!name) {
                alert('Inserisci il nome del Scheda');
                return;
            }

            const newId = 'Scheda_' + Date.now();
            customSchede[newId] = {
                name: name,
                exercises: []
            };

            saveSchede();
            renderSchedaButtons();
            renderSchedaEditors();
            hideModal();
        }

        function updateSchedaName(SchedaId, newName) {
            customSchede[SchedaId].name = newName;
            saveSchede();
            renderSchedaButtons();
        }

        function showAddSchedaExercise(SchedaId) {
            currentEditingScheda = SchedaId;
            document.getElementById('SchedaExerciseModal').classList.add('show');
        }

        function confirmAddSchedaExercise() {
            const name = document.getElementById('SchedaExerciseNameInput').value.trim();
            const sets = parseInt(document.getElementById('SchedaExerciseSetsInput').value) || 3;
            const reps = parseInt(document.getElementById('SchedaExerciseRepsInput').value) || 10;
            const weight = parseFloat(document.getElementById('SchedaExerciseWeightInput').value) || 20;

            if (!name || !currentEditingScheda) return;

            customSchede[currentEditingScheda].exercises.push({
                name: name,
                sets: sets,
                reps: reps,
                weight: weight
            });

            saveSchede();
            renderSchedaButtons();
            renderSchedaEditors();
            hideModal();

            // Clear inputs
            document.getElementById('SchedaExerciseNameInput').value = '';
            document.getElementById('SchedaExerciseSetsInput').value = '';
            document.getElementById('SchedaExerciseRepsInput').value = '';
            document.getElementById('SchedaExerciseWeightInput').value = '';
        }

        function moveSchedaExercise(SchedaId, index, direction) {
            const exercises = customSchede[SchedaId].exercises;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= exercises.length) return;
            
            [exercises[index], exercises[newIndex]] = [exercises[newIndex], exercises[index]];
            saveSchede();
            renderSchedaButtons();
            renderSchedaEditors();
        }

        function removeSchedaExercise(SchedaId, index) {
            const exerciseName = customSchede[SchedaId].exercises[index].name;
            if (confirm(`Sei sicuro di voler eliminare l'esercizio "${exerciseName}"?`)) {
                customSchede[SchedaId].exercises.splice(index, 1);
                saveSchede();
                renderSchedaButtons();
                renderSchedaEditors();
            }
        }

        function saveSchede() {
            localStorage.setItem('customSchede', JSON.stringify(customSchede));
        }

        // PROGRESS FUNCTIONS
        function renderProgress() {
            const container = document.getElementById('progressList');
            let progressData = calculateProgressFromHistory();
            
            // Filtra per gruppo muscolare se selezionato
            if (selectedMuscleGroup !== null) {
                const filteredData = {};
                Object.entries(progressData).forEach(([exerciseName, data]) => {
                    const muscles = getMuscleGroupsForExercise(exerciseName);
                    if (muscles.includes(selectedMuscleGroup)) {
                        filteredData[exerciseName] = data;
                    }
                });
                progressData = filteredData;
            }
            
            if (Object.keys(progressData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-title">Nessun progresso</div>
                        <div>Salva alcuni allenamenti per vedere i tuoi progressi</div>
                    </div>
                `;
                return;
            }

            const cards = Object.entries(progressData).map(([exerciseName, data]) => {
                const latest = data[data.length - 1];
                const previous = data.length > 1 ? data[data.length - 2] : latest;
                const maxWeight = Math.max(...data.map(d => d.weight));
                const avgVolume = Math.round(data.reduce((sum, d) => sum + d.volume, 0) / data.length);
                
                let trend = 'stable';
                let trendText = 'Stabile';
                if (latest.weight > previous.weight) {
                    trend = 'up';
                    trendText = '+' + (latest.weight - previous.weight) + 'kg';
                } else if (latest.weight < previous.weight) {
                    trend = 'down';
                    trendText = '-' + (previous.weight - latest.weight) + 'kg';
                }

                return `
                    <div class="progress-card">
                        <div class="progress-header">
                            <div class="progress-title">${exerciseName}</div>
                            <div class="progress-trend trend-${trend}">${trendText}</div>
                        </div>
                        <div class="progress-stats">
                            <div>
                                <div class="stat-value">${latest.weight}kg</div>
                                <div class="stat-label">Ultimo peso</div>
                            </div>
                            <div>
                                <div class="stat-value">${maxWeight}kg</div>
                                <div class="stat-label">Peso massimo</div>
                            </div>
                            <div>
                                <div class="stat-value">${avgVolume}kg</div>
                                <div class="stat-label">Volume medio</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = cards;
        }

        function createWeightChart() {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            // Distruggi il grafico esistente se presente
            if (weightChart) {
                weightChart.destroy();
                weightChart = null;
            }

            const progressData = getFilteredProgressData();
            
            if (Object.keys(progressData).length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            // Ordina gli esercizi per numero di sessioni (pi√π frequenti prima)
            const sortedExercises = Object.entries(progressData)
                .map(([name, data]) => ({ name, data, count: data.length }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10); // Prendi solo i top 10

            const datasets = sortedExercises.map((exercise, index) => {
                const colors = ['#4a5568', '#48bb78', '#ed8936', '#9f7aea', '#38b2ac', '#f56565', '#4299e1', '#ed64a6', '#ecc94b', '#9ae6b4'];
                const color = colors[index % colors.length];
                
                return {
                    label: exercise.name,
                    data: exercise.data.map(session => ({
                        x: new Date(session.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }),
                        y: session.weight
                    })),
                    borderColor: color,
                    backgroundColor: color + '20',
                    tension: 0.4,
                    fill: false
                };
            });

            const totalExercises = Object.keys(progressData).length;
            const showingCount = sortedExercises.length;

            // Mostra badge informativo se ci sono pi√π esercizi
            const infoBadge = document.getElementById('weightChartInfo');
            if (totalExercises > 10) {
                infoBadge.textContent = `Top ${showingCount} di ${totalExercises} esercizi`;
                infoBadge.style.display = 'inline-block';
            } else {
                infoBadge.style.display = 'none';
            }

            weightChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: showingCount > 1,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 8,
                                boxHeight: 8,
                                padding: 6,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Peso (kg)',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: '#e2e8f0' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: '#e2e8f0' }
                        }
                    }
                }
            });
        }

        function createVolumeChart() {
            const ctx = document.getElementById('volumeChart');
            if (!ctx) return;

            // Distruggi il grafico esistente se presente
            if (volumeChart) {
                volumeChart.destroy();
                volumeChart = null;
            }

            const progressData = getFilteredProgressData();
            
            if (Object.keys(progressData).length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            // Aggrega volume per data E salva il nome dell'allenamento
            const volumeByDate = {};
            const workoutNamesByDate = {};
            
            // Mappa date ai nomi allenamenti
            workoutHistory.forEach(workout => {
                const dateKey = new Date(workout.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' });
                workoutNamesByDate[dateKey] = workout.name || 'Allenamento';
            });
            
            Object.entries(progressData).forEach(([exerciseName, data]) => {
                data.forEach(session => {
                    const date = new Date(session.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' });
                    if (!volumeByDate[date]) volumeByDate[date] = 0;
                    volumeByDate[date] += session.volume;
                });
            });

            const sortedDates = Object.keys(volumeByDate).sort((a, b) => {
                // Ordina per data effettiva
                const dateA = Object.values(progressData)[0]?.find(d => 
                    new Date(d.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }) === a
                )?.date || '2024-01-01';
                const dateB = Object.values(progressData)[0]?.find(d => 
                    new Date(d.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }) === b
                )?.date || '2024-01-01';
                return new Date(dateA) - new Date(dateB);
            });

            volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Volume Totale (kg)',
                        data: sortedDates.map(date => volumeByDate[date]),
                        backgroundColor: '#48bb78',
                        borderColor: '#38a169',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const date = tooltipItems[0].label;
                                    const workoutName = workoutNamesByDate[date] || 'Allenamento';
                                    return `${workoutName} (${date})`;
                                },
                                label: function(context) {
                                    return `Volume: ${context.parsed.y}kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volume (kg)',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: '#e2e8f0' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // CORREZIONE BUG 3: Funzione di filtraggio migliorata
        function getFilteredProgressData() {
            const timeFilter = document.getElementById('timeFilter').value;
            const exerciseFilter = document.getElementById('exerciseFilter').value;
            
            let progressData = calculateProgressFromHistory();
            
            // Filtra per gruppo muscolare SE selezionato
            if (selectedMuscleGroup !== null) {
                const filteredData = {};
                Object.entries(progressData).forEach(([exerciseName, data]) => {
                    const muscles = getMuscleGroupsForExercise(exerciseName);
                    if (muscles.includes(selectedMuscleGroup)) {
                        filteredData[exerciseName] = data;
                    }
                });
                progressData = filteredData;
            }
            
            // Filtra per esercizio PRIMA del filtraggio temporale
            if (exerciseFilter && exerciseFilter !== '') {
                const filteredData = {};
                if (progressData[exerciseFilter]) {
                    filteredData[exerciseFilter] = progressData[exerciseFilter];
                }
                progressData = filteredData;
            }
            
            // Filtra per tempo
            if (timeFilter !== 'all') {
                let cutoffDate;
                
                if (timeFilter === 'custom') {
                    // Usa le date personalizzate
                    const startDateInput = document.getElementById('startDate').value;
                    const endDateInput = document.getElementById('endDate').value;
                    
                    if (startDateInput && endDateInput) {
                        const startDate = new Date(startDateInput);
                        const endDate = new Date(endDateInput);
                        endDate.setHours(23, 59, 59, 999); // Fine giornata
                        
                        Object.keys(progressData).forEach(exerciseName => {
                            progressData[exerciseName] = progressData[exerciseName].filter(session => {
                                const sessionDate = new Date(session.date);
                                return sessionDate >= startDate && sessionDate <= endDate;
                            });
                        });
                    }
                } else {
                    // Usa i giorni predefiniti
                    const daysBack = parseInt(timeFilter);
                    cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysBack);
                    cutoffDate.setHours(0, 0, 0, 0); // Normalizza a mezzanotte
                    
                    Object.keys(progressData).forEach(exerciseName => {
                        progressData[exerciseName] = progressData[exerciseName].filter(session => {
                            const sessionDate = new Date(session.date);
                            sessionDate.setHours(0, 0, 0, 0);
                            return sessionDate >= cutoffDate;
                        });
                    });
                }
            }
            
            return progressData;
        }

        // CORREZIONE BUG 3: Funzione di aggiornamento grafici migliorata
        function updateProgressCharts() {
            // Distruggi i grafici esistenti se presenti
            if (weightChart) {
                weightChart.destroy();
                weightChart = null;
            }
            if (volumeChart) {
                volumeChart.destroy();
                volumeChart = null;
            }
            
            // Ricrea i grafici con i dati filtrati
            createWeightChart();
            createVolumeChart();
            
            // Mostra i muscoli allenati nel periodo
            showMusclesWorked();
        }

        // Funzione per mappare esercizi ai muscoli (gruppi semplificati)
        function getMuscleGroupsForExercise(exerciseName) {
            const name = normalizeExerciseName(exerciseName);
            
            // Prima controlla il database predefinito
            if (PREDEFINED_EXERCISES[name]) {
                return [...PREDEFINED_EXERCISES[name]];
            }
            
            // Fallback alla logica esistente per esercizi non nel database
            const muscles = [];
            
            // Petto
            if (name.includes('panca') || name.includes('bench') || name.includes('push') || name.includes('dips') || name.includes('petto') || name.includes('croci') || name.includes('flyes')) {
                muscles.push('petto');
            }
            
            // Dorso (schiena)
            if (name.includes('trazioni') || name.includes('pull-ups') || name.includes('chin-ups') || name.includes('rematore') || name.includes('row') || name.includes('stacco') || name.includes('deadlift') || name.includes('lat machine') || name.includes('tirate machine') || name.includes('pulley') || name.includes('lat pulldown') || name.includes('schiena')) {
                muscles.push('dorso');
            }
            
            // Quadricipiti
            if (name.includes('squat') || name.includes('leg press') || name.includes('pressa gambe') || name.includes('leg extension') || name.includes('estensioni gambe') || name.includes('affondi') || name.includes('lunges') || name.includes('quadricipiti')) {
                muscles.push('quadricipiti');
            }
            
            // Bicipiti femorali (ischiocrurali)
            if (name.includes('leg curl') || name.includes('curl gambe') || name.includes('stacchi rumeni') || name.includes('romanian deadlift') || name.includes('ischiocrurali') || name.includes('bicipiti femorali')) {
                muscles.push('bicipiti femorali');
            }
            
            // Polpacci
            if (name.includes('calf') || name.includes('polpacci') || name.includes('alzate punte')) {
                muscles.push('polpacci');
            }
            
            // Spalle
            if (name.includes('military press') || name.includes('shoulder press') || name.includes('lateral raises') || name.includes('alzate laterali') || name.includes('rear delt') || name.includes('spalle posteriori') || name.includes('face pull') || name.includes('spalle')) {
                muscles.push('spalle');
            }
            
            // Bicipiti
            if (name.includes('curl') || name.includes('bicipiti') || name.includes('hammer curl')) {
                muscles.push('bicipiti');
            }
            
            // Tricipiti
            if (name.includes('tricipiti') || name.includes('pushdown') || name.includes('french press') || name.includes('estensioni') || name.includes('overhead')) {
                muscles.push('tricipiti');
            }
            
            // Addome
            if (name.includes('plank') || name.includes('crunch') || name.includes('sit-up') || name.includes('addominali') || name.includes('core') || name.includes('abs')) {
                muscles.push('addome');
            }
            
            // Rimuovi duplicati
            return [...new Set(muscles)];
        }

        // Lista completa di tutti i muscoli possibili (gruppi semplificati)
        const ALL_MUSCLES = [
            'quadricipiti', 'bicipiti femorali', 'polpacci', 'dorso', 'petto', 'spalle', 'bicipiti', 'tricipiti', 'addome'
        ];

        // Database esaustivo di esercizi predefiniti con i relativi muscoli
        const PREDEFINED_EXERCISES = {
            // Petto
            'panca piana': ['petto'],
            'panca inclinata': ['petto', 'spalle'],
            'panca declinata': ['petto'],
            'croci con manubri': ['petto'],
            'croci ai cavi': ['petto'],
            'croci machine': ['petto'],
            'dips': ['petto', 'tricipiti'],
            'push-ups': ['petto', 'tricipiti'],
            'petto ai cavi': ['petto'],
            'butterfly machine': ['petto'],
            'pec deck': ['petto'],
            'panca piana con bilanciere': ['petto'],
            'panca piana con manubri': ['petto'],
            'panca inclinata con bilanciere': ['petto', 'spalle'],
            'panca inclinata con manubri': ['petto', 'spalle'],
            'panca declinata con bilanciere': ['petto'],
            'panca declinata con manubri': ['petto'],
            'floor press': ['petto', 'tricipiti'],
            'svenson press': ['petto'],
            'chest press machine': ['petto'],
            'hammer strength chest press': ['petto'],
            'isometric chest squeeze': ['petto'],

            // Dorso (schiena)
            'stacco da terra': ['dorso', 'bicipiti femorali'],
            'stacco rumeno': ['dorso', 'bicipiti femorali'],
            'stacco sumo': ['dorso', 'bicipiti femorali', 'quadricipiti'],
            'trazioni alla sbarra': ['dorso', 'bicipiti'],
            'trazioni alla sbarra presa larga': ['dorso'],
            'trazioni alla sbarra presa stretta': ['dorso', 'bicipiti'],
            'rematore con bilanciere': ['dorso'],
            'rematore con manubrio': ['dorso'],
            'rematore con cavi': ['dorso'],
            'rematore machine': ['dorso'],
            'hammer strength row': ['dorso'],
            'lat machine': ['dorso'],
            'pulley': ['dorso'],
            'tirate al petto': ['dorso'],
            'tirate al petto presa larga': ['dorso'],
            'tirate al petto presa stretta': ['dorso', 'bicipiti'],
            'face pull': ['dorso', 'spalle'],
            'rear delt fly': ['dorso', 'spalle'],
            'hyperextension': ['dorso'],
            'good morning': ['dorso'],
            'shrugs': ['dorso', 'spalle'],
            'barbell shrugs': ['dorso', 'spalle'],
            'dumbbell shrugs': ['dorso', 'spalle'],
            'rack pull': ['dorso'],
            'deadlift deficit': ['dorso', 'bicipiti femorali'],
            'snatch grip deadlift': ['dorso', 'spalle'],
            'clean grip deadlift': ['dorso', 'spalle'],

            // Quadricipiti
            'squat': ['quadricipiti', 'bicipiti femorali'],
            'front squat': ['quadricipiti', 'bicipiti femorali'],
            'hack squat': ['quadricipiti'],
            'leg press': ['quadricipiti'],
            'leg press 45¬∞': ['quadricipiti'],
            'leg press orizzontale': ['quadricipiti'],
            'walking lunges': ['quadricipiti', 'bicipiti femorali'],
            'stationary lunges': ['quadricipiti', 'bicipiti femorali'],
            'reverse lunges': ['quadricipiti', 'bicipiti femorali'],
            'bulgarian split squat': ['quadricipiti', 'bicipiti femorali'],
            'step up': ['quadricipiti', 'bicipiti femorali'],
            'leg extension': ['quadricipiti'],
            'sissy squat': ['quadricipiti'],
            'wall sit': ['quadricipiti'],
            'box squat': ['quadricipiti', 'bicipiti femorali'],
            'pause squat': ['quadricipiti', 'bicipiti femorali'],
            'zercher squat': ['quadricipiti', 'bicipiti femorali'],
            'anderson squat': ['quadricipiti', 'bicipiti femorali'],
            'jefferson squat': ['quadricipiti', 'bicipiti femorali'],

            // Bicipiti femorali (ischiocrurali)
            'leg curl': ['bicipiti femorali'],
            'lying leg curl': ['bicipiti femorali'],
            'seated leg curl': ['bicipiti femorali'],
            'standing leg curl': ['bicipiti femorali'],
            'romanian deadlift': ['bicipiti femorali', 'dorso'],
            'single leg romanian deadlift': ['bicipiti femorali', 'dorso'],
            'glute ham raise': ['bicipiti femorali'],
            'nordic hamstring curl': ['bicipiti femorali'],
            'stiff leg deadlift': ['bicipiti femorali', 'dorso'],
            'deficit deadlift': ['bicipiti femorali', 'dorso'],
            'good morning': ['bicipiti femorali', 'dorso'],
            'hyperextension': ['bicipiti femorali', 'dorso'],

            // Polpacci
            'calf raise': ['polpacci'],
            'standing calf raise': ['polpacci'],
            'seated calf raise': ['polpacci'],
            'donkey calf raise': ['polpacci'],
            'single leg calf raise': ['polpacci'],
            'leg press calf raise': ['polpacci'],
            'smith machine calf raise': ['polpacci'],
            'dumbbell calf raise': ['polpacci'],
            'barbell calf raise': ['polpacci'],
            'toe press': ['polpacci'],

            // Spalle
            'military press': ['spalle'],
            'shoulder press': ['spalle'],
            'dumbbell shoulder press': ['spalle'],
            'barbell shoulder press': ['spalle'],
            'arnold press': ['spalle'],
            'lateral raises': ['spalle'],
            'dumbbell lateral raises': ['spalle'],
            'cable lateral raises': ['spalle'],
            'machine lateral raises': ['spalle'],
            'front raises': ['spalle'],
            'dumbbell front raises': ['spalle'],
            'cable front raises': ['spalle'],
            'rear delt fly': ['spalle', 'dorso'],
            'face pull': ['spalle', 'dorso'],
            'rear delt machine': ['spalle', 'dorso'],
            'upright row': ['spalle'],
            'barbell upright row': ['spalle'],
            'dumbbell upright row': ['spalle'],
            'shrug': ['spalle', 'dorso'],
            'barbell shrug': ['spalle', 'dorso'],
            'dumbbell shrug': ['spalle', 'dorso'],
            'clean and press': ['spalle', 'quadricipiti'],
            'push press': ['spalle', 'quadricipiti'],
            'jerk': ['spalle', 'quadricipiti'],

            // Bicipiti
            'curl': ['bicipiti'],
            'barbell curl': ['bicipiti'],
            'dumbbell curl': ['bicipiti'],
            'hammer curl': ['bicipiti'],
            'preacher curl': ['bicipiti'],
            'concentration curl': ['bicipiti'],
            'cable curl': ['bicipiti'],
            'machine curl': ['bicipiti'],
            'zottman curl': ['bicipiti'],
            'spider curl': ['bicipiti'],
            'drag curl': ['bicipiti'],
            'reverse curl': ['bicipiti'],
            'wrist curl': ['bicipiti'],

            // Tricipiti
            'triceps extension': ['tricipiti'],
            'overhead triceps extension': ['tricipiti'],
            'dumbbell overhead extension': ['tricipiti'],
            'cable overhead extension': ['tricipiti'],
            'skull crushers': ['tricipiti'],
            'lying triceps extension': ['tricipiti'],
            'close grip bench press': ['tricipiti', 'petto'],
            'triceps pushdown': ['tricipiti'],
            'cable pushdown': ['tricipiti'],
            'rope pushdown': ['tricipiti'],
            'overhead rope extension': ['tricipiti'],
            'diamond push-ups': ['tricipiti', 'petto'],
            'kickbacks': ['tricipiti'],
            'dumbbell kickbacks': ['tricipiti'],
            'cable kickbacks': ['tricipiti'],
            'french press': ['tricipiti'],

            // Addome
            'crunch': ['addome'],
            'sit-up': ['addome'],
            'leg raise': ['addome'],
            'hanging leg raise': ['addome'],
            'plank': ['addome'],
            'side plank': ['addome'],
            'russian twist': ['addome'],
            'bicycle crunch': ['addome'],
            'mountain climber': ['addome'],
            'flutter kick': ['addome'],
            'heel touch': ['addome'],
            'v-up': ['addome'],
            'dragon flag': ['addome'],
            'ab wheel rollout': ['addome'],
            'cable crunch': ['addome'],
            'machine crunch': ['addome'],
            'decline crunch': ['addome'],
            'reverse crunch': ['addome'],
            'windshield wiper': ['addome'],
            'l-sit': ['addome'],
            'hollow body hold': ['addome'],

            // VERSIONI ITALIANE DEGLI ESERCIZI
            
            // Petto italiano
            'panca piana': ['petto'],
            'panca inclinata': ['petto', 'spalle'],
            'panca declinata': ['petto'],
            'croci con manubri': ['petto'],
            'croci ai cavi': ['petto'],
            'petto ai cavi': ['petto'],
            'petto butterfly': ['petto'],
            'petto pec deck': ['petto'],
            'petto press machine': ['petto'],
            'petto hammer strength': ['petto'],
            'petto isometric squeeze': ['petto'],

            // Dorso italiano
            'stacco da terra': ['dorso', 'bicipiti femorali'],
            'stacco rumeno': ['dorso', 'bicipiti femorali'],
            'stacco sumo': ['dorso', 'bicipiti femorali', 'quadricipiti'],
            'trazioni alla sbarra': ['dorso', 'bicipiti'],
            'trazioni alla sbarra presa larga': ['dorso'],
            'trazioni alla sbarra presa stretta': ['dorso', 'bicipiti'],
            'rematore con bilanciere': ['dorso'],
            'rematore con manubrio': ['dorso'],
            'rematore con cavi': ['dorso'],
            'rematore machine': ['dorso'],
            'hammer strength row': ['dorso'],
            'lat machine': ['dorso'],
            'tirate al petto': ['dorso'],
            'tirate al petto presa larga': ['dorso'],
            'tirate al petto presa stretta': ['dorso', 'bicipiti'],
            'face pull': ['dorso', 'spalle'],
            'rear delt fly': ['dorso', 'spalle'],
            'iperextension': ['dorso'],
            'good morning': ['dorso'],
            'shrugs': ['dorso', 'spalle'],
            'shrugs con bilanciere': ['dorso', 'spalle'],
            'shrugs con manubri': ['dorso', 'spalle'],
            'rack pull': ['dorso'],
            'stacco da deficit': ['dorso', 'bicipiti femorali'],
            'stacco presa snatch': ['dorso', 'spalle'],
            'stacco presa clean': ['dorso', 'spalle'],

            // Quadricipiti italiano
            'squat': ['quadricipiti', 'bicipiti femorali'],
            'squat frontale': ['quadricipiti', 'bicipiti femorali'],
            'hack squat': ['quadricipiti'],
            'leg press': ['quadricipiti'],
            'leg press 45¬∞': ['quadricipiti'],
            'leg press orizzontale': ['quadricipiti'],
            'affondi camminando': ['quadricipiti', 'bicipiti femorali'],
            'affondi stazionari': ['quadricipiti', 'bicipiti femorali'],
            'affondi inversi': ['quadricipiti', 'bicipiti femorali'],
            'split squat bulgaro': ['quadricipiti', 'bicipiti femorali'],
            'step up': ['quadricipiti', 'bicipiti femorali'],
            'leg extension': ['quadricipiti'],
            'sissy squat': ['quadricipiti'],
            'wall sit': ['quadricipiti'],
            'box squat': ['quadricipiti', 'bicipiti femorali'],
            'pause squat': ['quadricipiti', 'bicipiti femorali'],
            'zercher squat': ['quadricipiti', 'bicipiti femorali'],
            'jefferson squat': ['quadricipiti', 'bicipiti femorali'],

            // Bicipiti femorali italiano
            'leg curl': ['bicipiti femorali'],
            'leg curl sdraiato': ['bicipiti femorali'],
            'leg curl seduto': ['bicipiti femorali'],
            'leg curl in piedi': ['bicipiti femorali'],
            'stacco rumeno': ['bicipiti femorali', 'dorso'],
            'stacco rumeno monopodalico': ['bicipiti femorali', 'dorso'],
            'glute ham raise': ['bicipiti femorali'],
            'nordic hamstring curl': ['bicipiti femorali'],
            'stacco gambe rigide': ['bicipiti femorali', 'dorso'],
            'stacco da deficit': ['bicipiti femorali', 'dorso'],
            'good morning': ['bicipiti femorali', 'dorso'],
            'iperextension': ['bicipiti femorali', 'dorso'],

            // Polpacci italiano
            'calf raise': ['polpacci'],
            'calf raise in piedi': ['polpacci'],
            'calf raise seduto': ['polpacci'],
            'calf raise asino': ['polpacci'],
            'calf raise monopodalico': ['polpacci'],
            'calf raise al leg press': ['polpacci'],
            'calf raise alla smith': ['polpacci'],
            'calf raise con manubri': ['polpacci'],
            'calf raise con bilanciere': ['polpacci'],
            'toe press': ['polpacci'],

            // Spalle italiano
            'military press': ['spalle'],
            'shoulder press': ['spalle'],
            'shoulder press con manubri': ['spalle'],
            'shoulder press con bilanciere': ['spalle'],
            'arnold press': ['spalle'],
            'alzate laterali': ['spalle'],
            'alzate laterali con manubri': ['spalle'],
            'alzate laterali ai cavi': ['spalle'],
            'alzate laterali alla macchina': ['spalle'],
            'alzate frontali': ['spalle'],
            'alzate frontali con manubri': ['spalle'],
            'alzate frontali ai cavi': ['spalle'],
            'rear delt fly': ['spalle', 'dorso'],
            'face pull': ['spalle', 'dorso'],
            'rear delt alla macchina': ['spalle', 'dorso'],
            'upright row': ['spalle'],
            'upright row con bilanciere': ['spalle'],
            'upright row con manubri': ['spalle'],
            'shrug': ['spalle', 'dorso'],
            'shrug con bilanciere': ['spalle', 'dorso'],
            'shrug con manubri': ['spalle', 'dorso'],
            'clean and press': ['spalle', 'quadricipiti'],
            'push press': ['spalle', 'quadricipiti'],
            'jerk': ['spalle', 'quadricipiti'],

            // Bicipiti italiano
            'curl': ['bicipiti'],
            'curl con bilanciere': ['bicipiti'],
            'curl con manubri': ['bicipiti'],
            'hammer curl': ['bicipiti'],
            'preacher curl': ['bicipiti'],
            'concentration curl': ['bicipiti'],
            'curl ai cavi': ['bicipiti'],
            'curl alla macchina': ['bicipiti'],
            'zottman curl': ['bicipiti'],
            'spider curl': ['bicipiti'],
            'drag curl': ['bicipiti'],
            'reverse curl': ['bicipiti'],
            'wrist curl': ['bicipiti'],

            // Tricipiti italiano
            'estensioni tricipiti': ['tricipiti'],
            'estensioni tricipiti sopra la testa': ['tricipiti'],
            'estensioni sopra la testa con manubri': ['tricipiti'],
            'estensioni sopra la testa ai cavi': ['tricipiti'],
            'skull crushers': ['tricipiti'],
            'estensioni tricipiti sdraiato': ['tricipiti'],
            'panca presa stretta': ['tricipiti', 'petto'],
            'pushdown tricipiti': ['tricipiti'],
            'pushdown ai cavi': ['tricipiti'],
            'pushdown con corda': ['tricipiti'],
            'estensioni sopra la testa con corda': ['tricipiti'],
            'piegamenti a diamante': ['tricipiti', 'petto'],
            'kickbacks': ['tricipiti'],
            'kickbacks con manubri': ['tricipiti'],
            'kickbacks ai cavi': ['tricipiti'],
            'french press': ['tricipiti'],

            // Addome italiano
            'crunch': ['addome'],
            'sit-up': ['addome'],
            'alzate gambe': ['addome'],
            'alzate gambe appesi': ['addome'],
            'plank': ['addome'],
            'plank laterale': ['addome'],
            'russian twist': ['addome'],
            'bicycle crunch': ['addome'],
            'mountain climber': ['addome'],
            'flutter kick': ['addome'],
            'heel touch': ['addome'],
            'v-up': ['addome'],
            'dragon flag': ['addome'],
            'ab wheel rollout': ['addome'],
            'crunch ai cavi': ['addome'],
            'crunch alla macchina': ['addome'],
            'crunch in declino': ['addome'],
            'reverse crunch': ['addome'],
            'windshield wiper': ['addome'],
            'l-sit': ['addome'],
            'hollow body hold': ['addome'],

            // ESERCIZI CARDIO (usano tempo e distanza invece di ripetizioni e peso)
            'corsa': ['cardio'],
            'running': ['cardio'],
            'jogging': ['cardio'],
            'camminata veloce': ['cardio'],
            'brisk walking': ['cardio'],
            'ciclismo': ['cardio'],
            'cycling': ['cardio'],
            'bici': ['cardio'],
            'bike': ['cardio'],
            'nuoto': ['cardio'],
            'swimming': ['cardio'],
            'crawl': ['cardio'],
            'dorso nuoto': ['cardio'],
            'backstroke': ['cardio'],
            'rana': ['cardio'],
            'breaststroke': ['cardio'],
            'farfalla': ['cardio'],
            'butterfly': ['cardio'],
            'ellittica': ['cardio'],
            'elliptical': ['cardio'],
            'tapis roulant': ['cardio'],
            'treadmill': ['cardio'],
            'cyclette': ['cardio'],
            'stationary bike': ['cardio'],
            'remoergometro': ['cardio'],
            'rowing machine': ['cardio'],
            'ski erg': ['cardio'],
            'sci di fondo': ['cardio'],
            'cross country skiing': ['cardio'],
            'step machine': ['cardio'],
            'stepper': ['cardio'],
            'salto della corda': ['cardio'],
            'jump rope': ['cardio'],
            'burpees': ['cardio'],
            'mountain climbers': ['cardio'],
            'high knees': ['cardio'],
            'butt kicks': ['cardio'],
            'sprint': ['cardio'],
            'allenamento a intervalli': ['cardio'],
            'hiit': ['cardio'],
            'tabata': ['cardio'],
            'circuit training': ['cardio']
        };

        // Carica esercizi personalizzati dal localStorage e uniscili al database predefinito
        (function loadCustomExercises() {
            try {
                const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
                Object.assign(PREDEFINED_EXERCISES, customExercises);
            } catch (e) {
                console.error('Errore nel caricamento esercizi personalizzati:', e);
            }
        })();

        // Funzione per salvare un esercizio nel database locale
        function saveExerciseToDatabase(exerciseName, muscles) {
            const normalized = normalizeExerciseName(exerciseName);
            
            // Se l'esercizio non √® gi√† nel database, aggiungilo
            if (!PREDEFINED_EXERCISES[normalized]) {
                PREDEFINED_EXERCISES[normalized] = muscles || [];
                
                // Salva nel localStorage
                try {
                    const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
                    customExercises[normalized] = muscles || [];
                    localStorage.setItem('customExercises', JSON.stringify(customExercises));
                } catch (e) {
                    console.error('Errore nel salvataggio esercizio:', e);
                }
            }
        }

        // Funzione helper per verificare se un esercizio √® cardio
        function isCardioExercise(exerciseName) {
            // Controlla se il nome contiene indicazioni di cardio
            const nameLower = normalizeExerciseName(exerciseName);
            if (nameLower.includes('(cardio)') || nameLower.includes('cardio') || 
                nameLower.includes('cyclette') || nameLower.includes('ellittica') || 
                nameLower.includes('tapis roulant') || nameLower.includes('camminata') ||
                nameLower.includes('elliptical') || nameLower.includes('treadmill')) {
                return true;
            }
            
            // Altrimenti controlla i muscoli dal database
            const muscles = getMuscleGroupsForExercise(exerciseName);
            return muscles.includes('cardio');
        }

        // Mostra i muscoli allenati nel periodo selezionato

        // Mostra i muscoli allenati nel periodo selezionato
        function showMusclesWorked() {
            const container = document.getElementById('muscleGroupButtons');
            if (!container) return;

            const timeFilter = document.getElementById('timeFilter').value;
            const exerciseFilter = document.getElementById('exerciseFilter').value;
            
            // Filtra i workout per periodo
            let filteredWorkouts = [...workoutHistory];
            
            if (timeFilter !== 'all') {
                if (timeFilter === 'custom') {
                    const startDateInput = document.getElementById('startDate').value;
                    const endDateInput = document.getElementById('endDate').value;
                    
                    if (startDateInput && endDateInput) {
                        const startDate = new Date(startDateInput);
                        const endDate = new Date(endDateInput);
                        endDate.setHours(23, 59, 59, 999);
                        
                        filteredWorkouts = filteredWorkouts.filter(workout => {
                            const workoutDate = new Date(workout.date);
                            return workoutDate >= startDate && workoutDate <= endDate;
                        });
                    }
                } else {
                    const daysBack = parseInt(timeFilter);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysBack);
                    
                    filteredWorkouts = filteredWorkouts.filter(workout => {
                        const workoutDate = new Date(workout.date);
                        return workoutDate >= cutoffDate;
                    });
                }
            }
            
            // Conta la frequenza di ogni muscolo allenato
            const muscleCounts = {};
            ALL_MUSCLES.forEach(muscle => muscleCounts[muscle] = 0);
            
            filteredWorkouts.forEach(workout => {
                if (workout.exercises) {
                    workout.exercises.forEach(exercise => {
                        const muscles = getMuscleGroupsForExercise(exercise.name);
                        muscles.forEach(muscle => {
                            muscleCounts[muscle]++;
                        });
                    });
                }
            });
            
            // Ordina i muscoli per frequenza
            const sortedMuscles = Object.entries(muscleCounts)
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1]);
            
            // Renderizza i pulsanti
            const allButton = `
                <button class="muscle-group-btn ${selectedMuscleGroup === null ? 'active' : ''}" 
                        onclick="selectMuscleGroup(null)">
                    üéØ Tutti (${sortedMuscles.reduce((sum, [_, count]) => sum + count, 0)})
                </button>
            `;
            
            const muscleButtons = sortedMuscles.map(([muscle, count]) => `
                <button class="muscle-group-btn ${selectedMuscleGroup === muscle ? 'active' : ''}" 
                        onclick="selectMuscleGroup('${muscle}')">
                    ${getMuscleEmoji(muscle)} ${capitalizeFirst(muscle)} (${count})
                </button>
            `).join('');
            
            container.innerHTML = allButton + muscleButtons;
        }

        function getMuscleEmoji(muscle) {
            const emojis = {
                'petto': 'üí™',
                'dorso': 'ü¶æ',
                'quadricipiti': 'ü¶µ',
                'bicipiti femorali': 'ü¶ø',
                'polpacci': 'üëü',
                'spalle': 'ü§∑',
                'bicipiti': 'üí™',
                'tricipiti': 'üí™',
                'addominali': 'üèãÔ∏è',
                'avambracci': 'ü§ú',
                'glutei': 'üçë',
                'adduttori': 'ü¶µ',
                'trapezio': 'ü¶æ'
            };
            return emojis[muscle] || 'üí™';
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function selectMuscleGroup(muscle) {
            selectedMuscleGroup = muscle;
            showMusclesWorked(); // Aggiorna i pulsanti
            updateExerciseFilterOptions(); // Aggiorna la lista a tendina esercizi
            updateProgressCharts(); // Aggiorna grafici e lista
            renderProgress(); // Aggiorna la lista esercizi
        }

        // CORREZIONE BUG 3: Aggiorna opzioni filtro esercizi
        function updateExerciseFilterOptions() {
            const exerciseFilter = document.getElementById('exerciseFilter');
            const currentValue = exerciseFilter.value;
            
            // Ottieni tutti gli esercizi unici dalla cronologia
            const allExercises = new Set();
            workoutHistory.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    allExercises.add(exercise.name);
                });
            });
            
            // Filtra esercizi per gruppo muscolare selezionato
            let filteredExercises = Array.from(allExercises);
            if (selectedMuscleGroup !== null) {
                filteredExercises = filteredExercises.filter(exerciseName => {
                    const muscles = getMuscleGroupsForExercise(exerciseName);
                    return muscles.includes(selectedMuscleGroup);
                });
            }
            
            // Ricostruisci le opzioni
            exerciseFilter.innerHTML = '<option value="">Tutti gli esercizi</option>' +
                filteredExercises.sort().map(exercise => 
                    `<option value="${exercise}">${exercise}</option>`
                ).join('');
            
            // Ripristina il valore selezionato se ancora valido
            if (currentValue && filteredExercises.includes(currentValue)) {
                exerciseFilter.value = currentValue;
            } else {
                exerciseFilter.value = '';
            }
        }

        function calculateProgressFromHistory() {
            const exerciseProgress = {};
            const nameMapping = {}; // Mappa normalizzato -> formattato
            
            workoutHistory.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    const normalized = normalizeExerciseName(exercise.name);
                    const formatted = formatExerciseName(exercise.name);
                    
                    // Usa il nome normalizzato come chiave, ma mantieni il formato pi√π recente
                    if (!nameMapping[normalized]) {
                        nameMapping[normalized] = formatted;
                    }
                    
                    if (!exerciseProgress[normalized]) {
                        exerciseProgress[normalized] = [];
                    }
                    
                    exerciseProgress[normalized].push({
                        date: workout.date,
                        sets: exercise.sets,
                        reps: exercise.reps,
                        weight: exercise.weight,
                        volume: exercise.sets * exercise.reps * exercise.weight
                    });
                });
            });
            
            // Converti le chiavi normalizzate in nomi formattati
            const formattedProgress = {};
            Object.keys(exerciseProgress).forEach(normalized => {
                const formattedName = nameMapping[normalized];
                formattedProgress[formattedName] = exerciseProgress[normalized].sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                );
            });
            
            return formattedProgress;
        }

        // STATS FUNCTIONS
        function updateStats() {
            calculateWeeklyStreak();
        }

        function calculateWeeklyStreak() {
            if (workoutHistory.length === 0) {
                document.getElementById('weeklyStreak').textContent = '0 settimane consecutive';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Funzione per ottenere il numero della settimana (ISO week)
            function getWeekNumber(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(), 0, 1);
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return d.getFullYear() + '-W' + weekNo;
            }

            // Raggruppa allenamenti per settimana
            const weeksSet = new Set();
            workoutHistory.forEach(workout => {
                const workoutDate = new Date(workout.date);
                weeksSet.add(getWeekNumber(workoutDate));
            });

            // Calcola streak di settimane consecutive
            let streak = 0;
            let checkDate = new Date(today);
            
            while (true) {
                const weekNum = getWeekNumber(checkDate);
                if (weeksSet.has(weekNum)) {
                    streak++;
                    // Vai alla settimana precedente
                    checkDate.setDate(checkDate.getDate() - 7);
                } else {
                    // Se siamo nella settimana corrente e non ci sono allenamenti, prova la settimana precedente
                    if (streak === 0 && getWeekNumber(today) === weekNum) {
                        checkDate.setDate(checkDate.getDate() - 7);
                        continue;
                    }
                    break;
                }
            }

            const text = streak === 1 ? 'üî• 1 settimana consecutiva' : `üî• ${streak} settimane consecutive`;
            document.getElementById('weeklyStreak').textContent = text;
        }

        // BACK TO TOP BUTTON
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            if (workoutHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-title">Nessuna cronologia</div>
                        <div>Salva i tuoi allenamenti per visualizzarli qui</div>
                    </div>
                `;
                return;
            }

            // Controlla se ci sono allenamenti di esempio
            const hasSamples = workoutHistory.some(w => w.isSample);

            // Header per allenamenti di esempio
            let headerHtml = '';
            if (hasSamples) {
                headerHtml = `
                    <div class="sample-workouts-header" style="background:#e3f2fd;border:1px solid #2196f3;border-radius:8px;padding:15px;margin-bottom:15px;text-align:center;">
                        <div style="font-size:1.1em;font-weight:bold;color:#1976d2;margin-bottom:8px;">üéØ Allenamenti di Esempio</div>
                        <div style="color:#666;margin-bottom:10px;">Questi sono allenamenti dimostrativi per mostrarti come funziona l'app</div>
                        <button onclick="deleteAllSampleWorkouts()" style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:0.9em;">
                            üóëÔ∏è Cancella Tutti gli Esempi
                        </button>
                    </div>
                `;
            }

            // mostra dall'ultimo al primo
            const items = [...workoutHistory].reverse().map(w => {
                const totalExercises = w.exercises.length;
                // Calcola volume solo per esercizi non cardio
                const totalVolume = w.exercises.reduce((s, e) => {
                    if (e.isCardio) return s; // Salta esercizi cardio per il volume
                    return s + (e.sets * e.reps * (e.weight || 0));
                }, 0);

                // Genera nome workout se non presente
                const workoutName = w.schedaName || (w.exercises.length > 0 ? `${w.exercises[0].name} Workout` : 'Allenamento Personalizzato');

                // CORREZIONE BUG 1: Gestione corretta della data per la visualizzazione
                const workoutDate = new Date(w.date + 'T00:00:00'); // Forza il fuso orario locale

                // Stile speciale per allenamenti di esempio
                const isSample = w.isSample;
                const sampleStyle = isSample ? 'border-left:4px solid #2196f3;background:#f8f9fa;' : '';
                const sampleBadge = isSample ? '<span style="background:#2196f3;color:white;padding:2px 6px;border-radius:3px;font-size:0.7em;margin-left:8px;">ESEMPIO</span>' : '';

                return `
                    <div class="history-item" data-id="${w.id}" style="${sampleStyle}">
                        <div class="history-content">
                            <h3>${workoutDate.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' })}${sampleBadge}</h3>
                            <div class="history-workout-name">${workoutName}</div>
                            <div class="history-summary">${totalExercises} esercizi ‚Ä¢ ${w.duration || 0} min ‚Ä¢ Volume ${Math.round(totalVolume)}kg</div>
                        </div>
                        <div style="display:flex;align-items:center;">
                            <div class="history-duration">${w.duration || 0}m</div>
                            <button class="history-delete-btn" onclick="deleteHistoryItem('${w.id}'); event.stopPropagation();">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = headerHtml + items;
        }

        // CORREZIONE BUG 2: Eliminazione basata su ID univoco con event.stopPropagation()
        function deleteHistoryItem(id) {
            if (!confirm('Eliminare questa voce dalla cronologia?')) return;
            
            const index = workoutHistory.findIndex(workout => workout.id == id);
            if (index !== -1) {
                workoutHistory.splice(index, 1);
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
                updateStats();
                renderHistory();
                renderProgress();
                updateExerciseFilterOptions();
                if (weightChart || volumeChart) {
                    updateProgressCharts();
                }
                renderCalendar();
            }
        }

        // CANCELLA TUTTI GLI ALLENAMENTI DI ESEMPIO
        function deleteAllSampleWorkouts() {
            if (!confirm('Sei sicuro di voler cancellare tutti gli allenamenti di esempio? Questa azione non pu√≤ essere annullata.')) return;

            // Filtra per rimuovere solo gli allenamenti di esempio
            const originalLength = workoutHistory.length;
            workoutHistory = workoutHistory.filter(workout => !workout.isSample);

            if (workoutHistory.length < originalLength) {
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
                updateStats();
                renderHistory();
                renderProgress();
                updateExerciseFilterOptions();
                if (weightChart || volumeChart) {
                    updateProgressCharts();
                }
                renderCalendar();
                alert('Allenamenti di esempio cancellati con successo!');
            }
        }

        // CALENDAR - CORREZIONE BUG 1: Gestione corretta delle date nel calendario
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            title.textContent = firstDay.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });

            // giorni della settimana header
            const dayHeaders = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
            const headerHtml = dayHeaders.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

            // calcola offset (coerente con luned√¨ come primo giorno)
            const startOffset = (firstDay.getDay() + 6) % 7; // converti domenica(0)->6, luned√¨(1)->0

            let cells = '';
            // giorni del mese precedente
            const prevMonthDays = startOffset;
            const prevMonthLastDate = new Date(year, month, 0).getDate();
            for (let i = prevMonthDays - 1; i >= 0; i--) {
                const d = prevMonthLastDate - i;
                cells += `<div class="calendar-day other-month">${d}</div>`;
            }

            // giorni del mese corrente
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dayDate = new Date(year, month, d);
                // CORREZIONE CALENDARIO: Usa il formato locale per il confronto
                const iso = dayDate.getFullYear() + '-' + 
                           String(dayDate.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(dayDate.getDate()).padStart(2, '0');
                const classes = ['calendar-day'];
                
                // CORREZIONE: Confronto date normalizzate
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                dayDate.setHours(0, 0, 0, 0);
                
                if (dayDate.getTime() === today.getTime()) {
                    classes.push('today');
                }
                
                // check if has workout
                const hasWorkout = workoutHistory.some(w => w.date === iso);
                if (hasWorkout) classes.push('has-workout');

                cells += `<div class="${classes.join(' ')}" onclick="openHistoryForDate('${iso}')">${d}</div>`;
            }

            // fill remaining cells to complete the grid
            const remaining = (Math.ceil((startOffset + lastDay.getDate()) / 7) * 7) - (startOffset + lastDay.getDate());
            for (let i = 1; i <= remaining; i++) {
                cells += `<div class="calendar-day other-month">${i}</div>`;
            }

            grid.innerHTML = headerHtml + cells;
        }

        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        function openHistoryForDate(isoDate) {
            // mostra i workout di quel giorno nella sezione history (o finestra)
            const workouts = workoutHistory.filter(w => w.date === isoDate);
            if (workouts.length === 0) {
                alert('Nessun allenamento per questa data');
                return;
            }

            // scorri i workout per quella data (primo)
            const w = workouts[0];
            // CORREZIONE BUG 1: Gestione corretta della data per la visualizzazione
            const workoutDate = new Date(w.date + 'T00:00:00');
            let msg = `Data: ${workoutDate.toLocaleDateString('it-IT')}\nDurata: ${w.duration || 0} min\n\nEsercizi:\n`;
            w.exercises.forEach(e => {
                msg += `‚Ä¢ ${e.name} ‚Äî ${e.sets}x${e.reps} @ ${e.weight}kg\n`;
            });
            if (w.notes) msg += `\nNote: ${w.notes}`;
            alert(msg);
        }

        // SCHEDE PERSONALI
        function showPersonalSchedeModal() {
            const code = prompt('Inserisci il codice per sbloccare schede personali:');
            if (!code) return;

            // Controlla se il codice √® valido
            if (!codeMappings[code]) {
                alert('Codice non valido. Riprova con un codice corretto.');
                return;
            }

            // Sblocca il codice per la sessione corrente (anche se gi√† sbloccato)
            if (!unlockedCodes.includes(code)) {
                unlockedCodes.push(code);
                localStorage.setItem('unlockedCodes', JSON.stringify(unlockedCodes));
            }

            renderSchedaButtons();
            renderSchedaEditors();
            alert(`Codice "${code}" sbloccato con successo! Ora puoi vedere le schede corrispondenti.`);
        }

        // SCARICA PDF
        function downloadSchedePdf() {
            if (!confirm('Vuoi scaricare tutte le schede in PDF?')) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Funzione per rimuovere emoticon e caratteri speciali
            function cleanText(text) {
                // Rimuovi emoticon e caratteri Unicode speciali
                return text.replace(/[^\x20-\x7E]/g, '').trim();
            }

            // Header elegante
            doc.setFillColor(30, 58, 138); // Blu scuro
            doc.rect(0, 0, 210, 40, 'F');

            // Titolo principale con stile
            doc.setFontSize(28);
            doc.setTextColor(255, 255, 255); // Bianco
            doc.setFont('helvetica', 'bold');
            doc.text('APP PALESTRA 3', 20, 20);

            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text('Le Tue Schede di Allenamento', 20, 30);

            // Data di generazione
            doc.setFontSize(10);
            doc.setTextColor(200, 200, 200);
            const today = new Date().toLocaleDateString('it-IT', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            doc.text(`Generato il ${today}`, 150, 35);

            let y = 60;
            let schedaCount = 0;

            Object.entries(customSchede).forEach(([id, scheda]) => {
                schedaCount++;
                if (y > 220) {
                    doc.addPage();

                    // Header su ogni pagina
                    doc.setFillColor(30, 58, 138);
                    doc.rect(0, 0, 210, 30, 'F');
                    doc.setFontSize(18);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.text('APP PALESTRA 3 - Continuazione', 20, 20);
                    y = 50;
                }

                // Box per ogni scheda
                doc.setFillColor(240, 240, 240);
                doc.rect(15, y - 5, 180, 35, 'F');

                // Numero scheda
                doc.setFontSize(12);
                doc.setTextColor(30, 58, 138);
                doc.setFont('helvetica', 'bold');
                doc.text(`SCHEDA ${schedaCount}`, 20, y);

                // Nome scheda pulito
                const cleanName = cleanText(scheda.name);
                doc.setFontSize(16);
                doc.setTextColor(34, 139, 34); // Verde scuro
                doc.setFont('helvetica', 'bold');
                doc.text(cleanName, 20, y + 8);

                y += 20;

                // Linea decorativa
                doc.setDrawColor(30, 58, 138);
                doc.setLineWidth(0.5);
                doc.line(20, y - 2, 190, y - 2);

                y += 8;

                // Esercizi con stile migliorato
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0); // Nero
                doc.setFont('helvetica', 'normal');

                scheda.exercises.forEach((exercise, index) => {
                    const cleanExerciseName = cleanText(exercise.name);
                    let exerciseText = `${index + 1}. ${cleanExerciseName}`;

                    if (exercise.isCardio) {
                        exerciseText += ` - ${exercise.duration || 'N/A'}`;
                    } else {
                        exerciseText += ` - ${exercise.sets}√ó${exercise.reps}`;
                        if (exercise.weight > 0) exerciseText += ` @ ${exercise.weight}kg`;
                    }

                    doc.text(exerciseText, 25, y);
                    y += 6;
                });

                y += 15; // Spazio extra tra schede
            });

            // Footer elegante
            const pageCount = doc.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.setFont('helvetica', 'italic');
                doc.text(`App Palestra 3 - Pagina ${i} di ${pageCount}`, 20, 285);
            }

            doc.save('le_mie_schede_palestra.pdf');
        }

        // CANCELLA TUTTE LE SCHEDE
        function deleteAllSchede() {
            showDeleteSchedeModal();
        }

        function showDeleteSchedeModal() {
            const container = document.getElementById('schedeSelectionList');
            container.innerHTML = '';

            // Aggiungi schede normali
            Object.keys(customSchede).forEach(key => {
                if (key !== 'push' && key !== 'pull' && key !== 'legs' && key !== 'cardio') {
                    const scheda = customSchede[key];
                    const exerciseCount = scheda.exercises ? scheda.exercises.length : 0;
                    
                    container.innerHTML += `
                        <div class="scheda-selection-item" onclick="toggleSchedaCheckbox('${key}')">
                            <input type="checkbox" id="checkbox-${key}" value="${key}" data-type="normal" onclick="event.stopPropagation()">
                            <div class="scheda-info">
                                <div class="scheda-name">${scheda.name}</div>
                                <div class="scheda-details">${exerciseCount} esercizi</div>
                            </div>
                        </div>
                    `;
                }
            });

            // Aggiungi schede protette (quelle di default)
            const protectedSchede = ['push', 'pull', 'legs', 'cardio'];
            protectedSchede.forEach(key => {
                if (customSchede[key]) {
                    const scheda = customSchede[key];
                    const exerciseCount = scheda.exercises ? scheda.exercises.length : 0;
                    
                    container.innerHTML += `
                        <div class="scheda-selection-item" onclick="toggleSchedaCheckbox('${key}')">
                            <input type="checkbox" id="checkbox-${key}" value="${key}" data-type="protected" onclick="event.stopPropagation()">
                            <div class="scheda-info">
                                <div class="scheda-name">${scheda.name} (Protetta)</div>
                                <div class="scheda-details">${exerciseCount} esercizi</div>
                            </div>
                        </div>
                    `;
                }
            });

            // Aggiungi schede sbloccate
            getUnlockedProtectedSchede().forEach(([key, scheda]) => {
                const exerciseCount = scheda.exercises ? scheda.exercises.length : 0;
                
                container.innerHTML += `
                    <div class="scheda-selection-item" onclick="toggleSchedaCheckbox('${key}')">
                        <input type="checkbox" id="checkbox-${key}" value="${key}" data-type="unlocked" onclick="event.stopPropagation()">
                        <div class="scheda-info">
                            <div class="scheda-name">${scheda.name} (Sbloccata)</div>
                            <div class="scheda-details">${exerciseCount} esercizi</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('deleteSchedeModal').classList.add('show');
        }

        function toggleSchedaCheckbox(key) {
            const checkbox = document.getElementById('checkbox-' + key);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }

        function confirmDeleteSelectedSchede() {
            const selectedSchede = [];
            document.querySelectorAll('#schedeSelectionList input[type="checkbox"]:checked').forEach(checkbox => {
                selectedSchede.push({
                    key: checkbox.value,
                    type: checkbox.dataset.type
                });
            });

            if (selectedSchede.length === 0) {
                alert('Seleziona almeno una scheda da eliminare.');
                return;
            }

            const confirmMessage = `Conferma eliminazione di ${selectedSchede.length} scheda(e)?`;
            if (!confirm(confirmMessage)) return;

            selectedSchede.forEach(scheda => {
                if (scheda.type === 'unlocked') {
                    // Rimuovi il codice che sblocca questa scheda
                    const codesToRemove = new Set();
                    Object.entries(codeMappings).forEach(([code, ids]) => {
                        if (ids.includes(scheda.key)) {
                            codesToRemove.add(code);
                        }
                    });
                    unlockedCodes = unlockedCodes.filter(code => !codesToRemove.has(code));
                    localStorage.setItem('unlockedCodes', JSON.stringify(unlockedCodes));
                } else {
                    delete customSchede[scheda.key];
                }
            });

            saveSchede();
            renderSchedaButtons();
            renderSchedaEditors();
            
            document.getElementById('deleteSchedeModal').classList.remove('show');
            alert(`${selectedSchede.length} scheda(e) eliminata(e) con successo.`);
        }

        function cancelDeleteSchede() {
            document.getElementById('deleteSchedeModal').classList.remove('show');
        }

        // INIZIALIZZAZIONE FINALE
        updateStats();
        renderProgress();
        renderHistory();
        renderCalendar();
    </script>

</body>
</html>
